<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>נגן שירים לרכב | Car Music Player</title>
    <!-- מניעת כיבוי מסך -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- הגדרות PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0C0F14">
    <link rel="apple-touch-icon" href="car-music-icon.png">
    <link rel="icon" type="image/png" href="car-music-icon.png">
    <!-- אפשר ניגון ברקע -->
    <meta name="mobile-web-app-background-audio" content="yes">
    <!-- ספריית איקונים -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            text-align: center;
            background: linear-gradient(145deg, #0C0F14 0%, #0F1622 50%, #0C0F14 100%);
            color: #EDEFF3;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            font-size: 16px;
            overflow-x: hidden;
            position: relative;
            width: 100%;
            top: 0;
            left: 0;
            box-sizing: border-box;
            transition: background 0.4s ease, color 0.4s ease;
        }

        .icon,
        .inline-icon,
        .icon-only {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .icon svg,
        .inline-icon svg,
        .icon-only svg {
            width: 1.2em;
            height: 1.2em;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .icon-only svg {
            width: 1em;
            height: 1em;
        }

        /* איקונים בתוך כפתורי שליטה */
        .control-btn .icon-only svg,
        .control-btn svg {
            width: 22px !important;
            height: 22px !important;
            stroke: white !important;
            stroke-width: 2.5 !important;
            fill: none !important;
        }

        .control-btn .icon-only,
        .control-btn [data-lucide] {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        /* Lucide icons general styling */
        [data-lucide] svg,
        .lucide {
            width: 1.2em;
            height: 1.2em;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .inline-icon {
            margin: 0 6px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes ripplePulse {
            0% {
                transform: scale(0);
                opacity: 0.3;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes marqueeSlide {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(var(--marquee-distance, -40%));
            }
        }

        /* Theme: Dark Graphite (Default) - Premium automotive style */
        /* Base styles already applied to body */

        /* Theme: Light Titanium (Day Mode) */
        body.theme-light {
            background: linear-gradient(145deg, #E8EAED 0%, #F5F6F8 50%, #E8EAED 100%);
            color: #1A1D24;
        }

        body.theme-light .music-player {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.98));
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        body.theme-light .control-btn {
            background: rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: #1A1D24;
        }

        body.theme-light .control-btn:hover {
            background: rgba(0, 0, 0, 0.10);
        }

        body.theme-light .control-btn.play-btn {
            background: #2F6BFF;
            border: none;
            color: #FFFFFF;
        }

        body.theme-light .playlist-name {
            color: #2F6BFF;
        }

        body.theme-light .current-song {
            color: #1A1D24;
        }

        body.theme-light .current-song-container {
            background: rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        body.theme-light .current-song-container::before {
            background: #2F6BFF;
        }

        body.theme-light .volume-slider {
            background: rgba(0, 0, 0, 0.12);
        }

        body.theme-light .volume-slider::-webkit-slider-thumb {
            background: #2F6BFF;
        }

        body.theme-light .volume-slider::-moz-range-thumb {
            background: #2F6BFF;
        }

        body.theme-light .video-frame {
            background: linear-gradient(145deg, #E0E2E6, #D4D6DA);
        }


        .music-player {
            width: 100%;
            max-width: 500px;
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.95), rgba(12, 15, 20, 0.98));
            padding: 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 100vh;
            overflow: visible;
            position: relative;
            z-index: 1;
            gap: 14px;
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55),
                        inset 0 1px 0 rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(16px);
            opacity: 1;
            animation: fadeSlideIn 0.5s ease forwards;
        }

        .layout-columns {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .media-column,
        .interface-column {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .interface-column > * {
            width: 100%;
        }

        .video-frame {
            width: 100%;
            height: 25vh;
            min-height: 180px;
            max-height: 200px;
            border-radius: 14px;
            border: none;
            overflow: hidden;
            background: linear-gradient(145deg, #0A0C10, #12161E);
            margin-bottom: 5px;
            position: relative;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .video-frame iframe {
            width: 100% !important;
            height: 100% !important;
            display: block;
            pointer-events: none !important;
        }
        
        .video-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 100;
            cursor: default;
            pointer-events: auto !important;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
        }

        .control-row,
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            width: 100%;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(237, 239, 243, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            letter-spacing: 0.2px;
            width: 52px;
            height: 52px;
            font-size: 22px;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        .control-btn.icon-btn,
        .control-btn.pill-btn {
            width: 52px;
            height: 52px;
            font-size: 22px;
        }

        /* Play button - accent color */
        #playPauseBtn {
            background: #2F6BFF;
            border: none;
            color: #FFFFFF;
            box-shadow: 0 4px 16px rgba(47, 107, 255, 0.25);
        }

        #playPauseBtn:hover {
            background: #4A7FFF;
            box-shadow: 0 6px 20px rgba(47, 107, 255, 0.35);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
        }
        
        .control-btn:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.06);
        }

        .control-btn::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
        }

        .control-btn:active::after {
            animation: ripplePulse 0.3s ease-out forwards;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0);
        }

        .update-check-btn {
            margin: 8px auto 0;
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(255, 255, 255, 0.08);
            color: rgba(237, 239, 243, 0.92);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .update-check-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .update-check-btn:active {
            transform: scale(0.98);
        }

        .theme-light .update-check-btn {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(0, 0, 0, 0.08);
            color: #1A1D24;
        }

        .microphone-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .microphone-modal {
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.98), rgba(12, 15, 20, 0.98));
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            max-width: 420px;
            width: 100%;
            padding: 24px;
            color: #EDEFF3;
            position: relative;
            box-shadow: 0 24px 70px rgba(0, 0, 0, 0.6);
            text-align: right;
        }

        .microphone-modal h2 {
            margin: 0 0 15px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .microphone-modal p {
            font-size: 14px;
            line-height: 1.6;
            margin: 0 0 15px;
            color: rgba(237, 239, 243, 0.85);
        }

        .microphone-modal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
            margin-bottom: 12px;
        }

        .microphone-modal-primary,
        .microphone-modal-secondary {
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .microphone-modal-primary {
            background: #2F6BFF;
            color: #FFFFFF;
            box-shadow: 0 4px 16px rgba(47, 107, 255, 0.25);
        }

        .microphone-modal-primary:hover {
            background: #4A7FFF;
        }

        .microphone-modal-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(237, 239, 243, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.10);
        }

        .microphone-modal-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .microphone-modal-close {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(237, 239, 243, 0.92);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .microphone-modal-close:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .microphone-settings-guide {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 15px;
            font-size: 13px;
            line-height: 1.7;
        }

        .microphone-settings-guide h3 {
            margin-top: 0;
            font-size: 14px;
            font-weight: 500;
            color: #2F6BFF;
        }

        .microphone-settings-guide h3 .inline-icon svg {
            width: 16px;
            height: 16px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        .microphone-modal h2 .inline-icon svg {
            width: 20px;
            height: 20px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        .microphone-modal-primary .icon-only svg,
        .microphone-modal-secondary .icon-only svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .microphone-modal-close .icon-only svg {
            width: 22px;
            height: 22px;
            stroke: white;
            stroke-width: 2;
        }

        .microphone-settings-guide ul {
            margin: 0 0 10px 0;
            padding-right: 18px;
        }

        .microphone-settings-guide li {
            margin-bottom: 6px;
        }

        .microphone-retry-status {
            font-size: 14px;
            margin-top: 8px;
            min-height: 20px;
        }

        @media (max-width: 480px) {
            .microphone-modal {
                padding: 20px 18px;
            }

            .microphone-modal h2 {
                font-size: 20px;
            }

            .microphone-modal-primary,
            .microphone-modal-secondary {
                flex: 1;
                text-align: center;
            }
        }

        .shuffle-btn.active {
            background: rgba(47, 107, 255, 0.15) !important;
            border-color: rgba(47, 107, 255, 0.4) !important;
            color: #2F6BFF !important;
        }

        .shuffle-btn.active::before {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #2F6BFF;
            border-radius: 50%;
        }

        .playlist-name {
            margin: 8px 0;
            font-size: 14px;
            color: #2F6BFF;
            font-weight: 500;
            letter-spacing: 0.3px;
            padding: 5px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            gap: 8px;
            visibility: visible !important;
            width: 100%;
        }

        .playlist-name .inline-icon svg {
            width: 18px;
            height: 18px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        .theme-light .playlist-name .inline-icon svg {
            stroke: #2F6BFF;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.08);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 16px;
            box-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(237, 239, 243, 0.92);
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        /* Subtle press feedback - no flashy effects */
        .active-effect {
            opacity: 0.8;
            transition: opacity 0.15s ease;
        }
        
        /* בעיית תצוגה - תיקון אלמנטים שלא מוצגים */
        .playlist-name, .current-song-container, .volume-control {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            margin: 10px 0 !important;
        }
        
        /* סגנון תצוגת שיר נוכחי */
        .current-song-container {
            background: rgba(255, 255, 255, 0.04);
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin: 5px 0;
            width: 100%;
            text-align: right;
            display: block !important;
            visibility: visible !important;
            position: relative;
        }

        /* Subtle accent indicator instead of thick border */
        .current-song-container::before {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: #2F6BFF;
            border-radius: 2px;
        }
        
        .current-song-label {
            font-size: 12px;
            color: rgba(237, 239, 243, 0.68);
            margin-bottom: 4px;
        }
        
        .current-song {
            font-weight: 600;
            font-size: 20px;
            color: #EDEFF3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: inline-block;
            position: relative;
            line-height: 1.3;
        }

        .current-song.marquee-text {
            animation: marqueeSlide var(--marquee-duration, 12s) linear infinite;
            padding-right: 40px;
        }
        
        /* סגנון בקר עוצמת שמע */
        .volume-control {
            width: 100%;
            display: flex !important;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            justify-content: center;
            visibility: visible !important;
        }
        
        .volume-slider {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #EDEFF3;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #EDEFF3;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .theme-light .volume-slider::-webkit-slider-thumb {
            background: #2F6BFF;
        }
        
        .theme-light .volume-slider::-moz-range-thumb {
            background: #2F6BFF;
        }
        
        .volume-icon {
            font-size: 24px;
            cursor: pointer;
            background: transparent;
            border: none;
            padding: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: rgba(237, 239, 243, 0.68);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .volume-icon:hover {
            color: rgba(237, 239, 243, 0.92);
        }

        .volume-icon .icon-only svg,
        .volume-icon svg {
            width: 22px !important;
            height: 22px !important;
            stroke: currentColor !important;
            stroke-width: 2 !important;
        }

        .theme-light .volume-icon {
            color: rgba(26, 29, 36, 0.68);
        }

        .theme-light .volume-icon:hover {
            color: #1A1D24;
        }
        
        /* סגנון קישור התקנה למסך הבית */
        .install-prompt {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.98), rgba(12, 15, 20, 0.98));
            color: #EDEFF3;
            padding: 18px 20px;
            border-radius: 16px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1200;
            animation: fadeIn 0.4s ease;
            direction: rtl;
            text-align: right;
            max-width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
        }

        .install-prompt button {
            background: #2F6BFF;
            color: #FFFFFF;
            border: none;
            padding: 10px 18px;
            border-radius: 999px;
            margin-top: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(47, 107, 255, 0.25);
        }

        .install-prompt button:hover {
            background: #4A7FFF;
            box-shadow: 0 6px 20px rgba(47, 107, 255, 0.35);
        }

        .theme-light .install-prompt {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 249, 250, 0.98));
            color: #1A1D24;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .theme-light .current-song {
            color: #1A1D24;
        }

        /* תפריט הגדרות */
        .settings-menu {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 1100;
        }

        .settings-toggle {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(237, 239, 243, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 22px;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
        }

        .settings-toggle .icon-only svg,
        .settings-toggle svg {
            width: 22px !important;
            height: 22px !important;
            stroke: currentColor !important;
            stroke-width: 2 !important;
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .settings-dropdown {
            display: none;
            flex-direction: column;
            gap: 6px;
            background: rgba(18, 22, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            direction: rtl;
            backdrop-filter: blur(16px);
        }

        .settings-dropdown.open {
            display: flex;
        }

        .settings-dropdown button {
            background: rgba(255, 255, 255, 0.06);
            color: rgba(237, 239, 243, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 500;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .settings-dropdown button .inline-icon svg,
        .settings-dropdown button .icon-only svg,
        .settings-dropdown button svg {
            width: 18px !important;
            height: 18px !important;
            stroke: currentColor !important;
            stroke-width: 2 !important;
        }

        .settings-dropdown button span:first-child {
            font-size: 18px;
        }

        .settings-dropdown button:hover {
            background: rgba(255, 255, 255, 0.10);
            border-color: rgba(255, 255, 255, 0.10);
        }

        .theme-light .settings-toggle {
            background: rgba(0, 0, 0, 0.06);
            color: #1A1D24;
            border-color: rgba(0, 0, 0, 0.08);
        }

        .theme-light .settings-toggle:hover {
            background: rgba(0, 0, 0, 0.10);
        }

        .theme-light .settings-dropdown {
            background: rgba(255, 255, 255, 0.98);
            border-color: rgba(0, 0, 0, 0.08);
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.15);
        }

        .theme-light .settings-dropdown button {
            background: rgba(0, 0, 0, 0.04);
            color: #1A1D24;
            border-color: rgba(0, 0, 0, 0.06);
        }

        .theme-light .settings-dropdown button:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        /* Theme selector modal */
        .theme-selector-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .theme-selector-overlay.open {
            display: flex;
        }

        .theme-selector-modal {
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.98), rgba(12, 15, 20, 0.98));
            border-radius: 18px;
            padding: 24px;
            max-width: 360px;
            width: 100%;
            color: #EDEFF3;
            box-shadow: 0 24px 70px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
        }

        .theme-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .theme-selector-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .theme-selector-close {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(237, 239, 243, 0.92);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-selector-close:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .theme-selector-close .icon-only svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .theme-selector-header h3 .inline-icon svg {
            width: 20px;
            height: 20px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        .theme-card-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-card {
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.04);
        }

        .theme-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .theme-card.active {
            border-color: rgba(47, 107, 255, 0.5);
            background: rgba(47, 107, 255, 0.08);
        }

        .theme-preview {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .theme-preview::after,
        .theme-preview::before {
            display: none;
        }

        /* Dark Graphite theme preview */
        .theme-card[data-theme="dark"] .theme-preview,
        .theme-card[data-theme="modern"] .theme-preview {
            background: linear-gradient(145deg, #0C0F14, #0F1622);
        }

        /* Light Titanium theme preview */
        .theme-card[data-theme="light"] .theme-preview {
            background: linear-gradient(145deg, #E8EAED, #F5F6F8);
        }

        .theme-card-info {
            flex: 1;
        }

        .theme-card h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 600;
            color: #EDEFF3;
        }

        .theme-card p {
            margin: 0;
            font-size: 13px;
            color: rgba(237, 239, 243, 0.68);
        }

        .theme-card.active h4 {
            color: #2F6BFF;
        }

        /* Voice Commands Help Modal */
        .voice-help-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 16px;
        }

        .voice-help-overlay.open {
            display: flex;
        }

        .voice-help-modal {
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.98), rgba(12, 15, 20, 0.98));
            border-radius: 18px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            color: #EDEFF3;
            box-shadow: 0 24px 70px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
        }

        .voice-help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .voice-help-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-help-header h3 .inline-icon svg {
            width: 22px;
            height: 22px;
            stroke: #2F6BFF;
        }

        .voice-help-close {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(237, 239, 243, 0.92);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-help-close:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .voice-help-close .icon-only svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        .voice-help-intro {
            font-size: 14px;
            color: rgba(237, 239, 243, 0.85);
            margin: 0 0 16px 0;
            text-align: right;
        }

        .voice-help-section {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .voice-help-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2F6BFF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-help-section h4 .inline-icon svg {
            width: 16px;
            height: 16px;
            stroke: #2F6BFF;
        }

        .voice-help-section ul {
            margin: 0;
            padding: 0 16px 0 0;
            list-style: none;
        }

        .voice-help-section li {
            font-size: 13px;
            color: rgba(237, 239, 243, 0.85);
            margin-bottom: 8px;
            padding-right: 12px;
            position: relative;
        }

        .voice-help-section li::before {
            content: '•';
            position: absolute;
            right: 0;
            color: #2F6BFF;
        }

        .voice-help-section li:last-child {
            margin-bottom: 0;
        }

        .voice-help-section li strong {
            color: #EDEFF3;
            background: rgba(47, 107, 255, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .voice-help-tip {
            background: rgba(47, 107, 255, 0.10);
            border: 1px solid rgba(47, 107, 255, 0.25);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 13px;
            color: rgba(237, 239, 243, 0.85);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 4px;
        }

        .voice-help-tip .inline-icon svg {
            width: 18px;
            height: 18px;
            stroke: #2F6BFF;
            flex-shrink: 0;
            margin-top: 1px;
        }

        /* Legacy day-mode support - redirects to theme-light */
        .day-mode {
            background: linear-gradient(145deg, #E8EAED 0%, #F5F6F8 50%, #E8EAED 100%) !important;
            color: #1A1D24;
        }

        .day-mode .music-player {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.98));
            color: #1A1D24;
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.12);
            border-color: rgba(0, 0, 0, 0.08);
        }

        .day-mode .control-btn {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(0, 0, 0, 0.08);
            color: #1A1D24;
        }

        .day-mode .control-btn:hover {
            background: rgba(0, 0, 0, 0.10);
        }

        .day-mode #playPauseBtn {
            background: #2F6BFF;
            color: #FFFFFF;
        }

        .day-mode .playlist-name {
            color: #2F6BFF;
        }

        .day-mode .current-song {
            color: #1A1D24;
        }

        .day-mode .current-song-container {
            background: rgba(0, 0, 0, 0.04);
            border-color: rgba(0, 0, 0, 0.06);
        }

        .day-mode .current-song-container::before {
            background: #2F6BFF;
        }

        .day-mode .current-song-label {
            color: rgba(26, 29, 36, 0.68);
        }

        /* התאמה למסכים קטנים */
        /* התאמה למסכים שונים */
        @media (max-height: 700px) {
            .music-player {
                transform: scale(0.9);
                margin-top: -20px;
            }
            .video-frame {
                height: 25vh;
            }
        }

        @media (max-width: 768px) {
            .control-btn.icon-btn,
            .control-btn.pill-btn {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .control-btn .icon-only svg {
                width: 24px;
                height: 24px;
            }

            .settings-menu {
                top: 12px;
                right: 12px;
            }

            .settings-dropdown {
                min-width: 170px;
            }

            .control-row,
            .control-buttons {
                gap: 10px;
            }
        }

        /* התאמה למסכי מובייל קטנים */
        @media (max-width: 400px) {
            .control-btn.icon-btn,
            .control-btn.pill-btn {
                width: 44px;
                height: 44px;
            }

            .control-btn .icon-only svg {
                width: 22px;
                height: 22px;
            }

            .control-row,
            .control-buttons {
                gap: 8px;
            }

            .music-player {
                padding: 10px;
            }
        }
        
        /* התאמה למחשב שולחני */
        @media (min-width: 1024px) {
            .music-player {
                max-width: 900px;
            }
            
            .control-buttons {
                margin: 10px auto;
            }
        }
        
        /* התאמה למצב רוחב (Landscape) במובייל */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                padding: 5px;
            }

            .music-player {
                max-width: 100%;
                width: 100%;
                max-height: 100vh;
                border-radius: 14px;
                padding: 10px 16px;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-between;
                gap: 10px;
                overflow-y: auto;
            }
            
            .video-frame {
                width: 45%;
                height: 65vh;
                max-height: none;
                min-height: 150px;
                border-radius: 12px;
            }
            
            .control-panel {
                width: 52%;
                margin: 0;
                justify-content: center;
                gap: 8px;
            }

            .control-btn.icon-btn,
            .control-btn.pill-btn {
                width: 44px;
                height: 44px;
            }

            .control-btn .icon-only svg {
                width: 20px;
                height: 20px;
            }

            .control-row,
            .control-buttons {
                gap: 8px;
            }
            
            h2 {
                width: 100%;
                font-size: 14px !important;
                margin: 2px 0 !important;
            }
            
            .playlist-name {
                width: 100%;
                font-size: 12px;
                padding: 3px;
            }
            
            .current-song-container {
                width: 100%;
                padding: 8px 12px;
            }

            .current-song {
                font-size: 16px;
            }

            .current-song-label {
                font-size: 11px;
            }
            
            #volumeControl {
                width: 100%;
            }

            .settings-menu {
                top: 5px;
                right: 5px;
            }

            .settings-toggle {
                padding: 8px 10px;
            }

            #playerTitle {
                display: none;
            }
        }

        @media (orientation: landscape) and (min-width: 768px) {
            .layout-columns {
                flex-direction: row;
                align-items: flex-start;
                gap: 20px;
            }

            .media-column {
                width: 50%;
            }

            .interface-column {
                width: 50%;
                justify-content: space-between;
                gap: 14px;
            }

            .video-frame {
                height: 65vh;
                min-height: 280px;
                max-height: none;
                border-radius: 14px;
            }

            .control-panel {
                margin: 0;
            }

            .current-song {
                font-size: 18px;
            }

            .playlist-name,
            .current-song-container,
            .volume-control {
                margin: 0;
            }
        }

        /* כפתור סגירה לחלון התקנה */
        .close-prompt {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-prompt:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .close-prompt:active {
            transform: scale(0.95);
        }

        /* מודאל ניהול פלייליסטים - מותאם למובייל */
        .playlist-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }

        .playlist-modal-container {
            max-width: 500px;
            margin: 10px auto;
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.98), rgba(12, 15, 20, 0.98));
            padding: 20px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 24px 70px rgba(0, 0, 0, 0.6);
        }

        .playlist-modal-title {
            color: #EDEFF3;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 15px 0;
        }

        .playlist-modal-section {
            background: rgba(255, 255, 255, 0.04);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .playlist-section-title {
            color: #EDEFF3;
            margin: 0 0 12px 0;
            font-size: 15px;
            font-weight: 500;
        }

        .playlist-input {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(255, 255, 255, 0.06);
            color: #EDEFF3;
            font-size: 15px;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        .playlist-input:focus {
            outline: none;
            border-color: rgba(47, 107, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .playlist-input::placeholder {
            color: rgba(237, 239, 243, 0.45);
        }

        .playlist-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .playlist-btn .icon-only svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
        }

        .playlist-btn:active {
            transform: scale(0.97);
        }

        .playlist-btn-primary {
            width: 100%;
            background: #2F6BFF;
            color: white;
            box-shadow: 0 4px 16px rgba(47, 107, 255, 0.25);
        }

        .playlist-btn-primary:hover {
            background: #4A7FFF;
        }

        .playlist-btn-search {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(237, 239, 243, 0.92);
            min-width: 50px;
        }

        .playlist-btn-search:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .playlist-btn-close {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.10);
            color: rgba(237, 239, 243, 0.92);
            width: 100%;
            margin-top: 10px;
        }

        .playlist-btn-close:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .playlist-section-title .inline-icon svg,
        .playlist-modal-title .inline-icon svg,
        .playlist-hint .inline-icon svg {
            width: 18px;
            height: 18px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        .playlist-search-row {
            display: flex;
            gap: 10px;
        }

        .playlist-search-input {
            flex: 1;
            margin-bottom: 0;
        }

        .playlist-search-results {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .playlist-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .playlist-hint {
            margin-top: 10px;
            font-size: 11px;
            color: #888;
            text-align: right;
            line-height: 1.5;
        }

        .playlist-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .playlist-item-info {
            flex: 1;
            text-align: right;
            min-width: 0;
        }

        .playlist-item-name {
            color: white;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-meta {
            color: #888;
            font-size: 11px;
        }

        .playlist-item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .playlist-item-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            color: white;
        }

        .playlist-item-btn .icon-only svg {
            width: 20px;
            height: 20px;
            stroke: white;
            stroke-width: 2;
        }

        .playlist-item-btn:active {
            transform: scale(0.92);
        }

        .playlist-item-btn-edit {
            background: rgba(47, 107, 255, 0.2);
            border: 1px solid rgba(47, 107, 255, 0.3);
        }

        .playlist-item-btn-delete {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .playlist-item-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .playlist-item-name .inline-icon svg {
            width: 16px;
            height: 16px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        .playlist-item {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .playlist-item-meta {
            color: rgba(237, 239, 243, 0.68);
        }

        /* התאמה למובייל */
        @media (max-width: 480px) {
            .playlist-modal-container {
                margin: 5px;
                padding: 15px;
                border-radius: 16px;
            }

            .playlist-modal-title {
                font-size: 1.2rem;
            }

            .playlist-modal-section {
                padding: 12px;
                margin-bottom: 12px;
            }

            .playlist-section-title {
                font-size: 0.95rem;
            }

            .playlist-input {
                padding: 14px 12px;
                font-size: 16px;
            }

            .playlist-btn {
                padding: 14px 16px;
                font-size: 15px;
            }

            .playlist-search-row {
                flex-direction: column;
            }

            .playlist-search-input {
                margin-bottom: 10px;
            }

            .playlist-btn-search {
                width: 100%;
            }

            .playlist-list {
                max-height: 200px;
            }

            .playlist-hint {
                font-size: 10px;
            }
        }

        /* הודעת הרשאות */
        .permission-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(12, 20, 30, 0.95), rgba(6, 12, 20, 0.92));
            color: #f5f5f5;
            padding: 28px;
            border-radius: 26px;
            box-shadow: 0 18px 55px rgba(0, 0, 0, 0.55), 0 0 25px rgba(29, 185, 84, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.08);
            z-index: 10000;
            max-width: 90%;
            width: 420px;
            text-align: right;
            animation: slideIn 0.45s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .permission-notification h3 {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 600;
            color: #EDEFF3;
        }

        .permission-notification p {
            margin: 8px 0;
            line-height: 1.5;
            color: rgba(237, 239, 243, 0.85);
        }

        .permission-notification .permission-list {
            background: rgba(255, 255, 255, 0.04);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: right;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .permission-notification button {
            background: #2F6BFF;
            color: #FFFFFF;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(47, 107, 255, 0.25);
        }

        .permission-notification button:hover {
            background: #4A7FFF;
        }

        /* באנר עדכון */
        #updateBanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, rgba(18, 22, 30, 0.98), rgba(12, 15, 20, 0.98));
            color: #EDEFF3;
            padding: 16px;
            text-align: center;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            animation: slideDown 0.4s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        #updateBanner button {
            background: #2F6BFF;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        #updateBanner button .icon-only svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
        }

        #updateBanner .inline-icon svg {
            width: 20px;
            height: 20px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        #updateBanner button:hover {
            background: #4A7FFF;
        }

        #updateBanner .dismiss-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(237, 239, 243, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.10);
        }

        #updateBanner .dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        #updateBanner .dismiss-btn .icon-only svg {
            stroke: currentColor;
        }

        /* Voice indicator icons */
        #voiceIndicator .inline-icon svg,
        #voiceCommand .inline-icon svg {
            width: 16px;
            height: 16px;
            stroke: #2F6BFF;
            stroke-width: 2;
        }

        /* Calm pulse animation for voice indicator */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

    </style>
</head>
<body>
    <!-- באנר עדכון -->
    <div id="updateBanner" style="display: none;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; justify-content: center;">
            <span class="inline-icon" data-lucide="refresh-cw" aria-hidden="true"></span>
            <span>עדכון חדש זמין!</span>
        </div>
        <div style="font-size: 14px; margin-bottom: 10px;">
            גרסה חדשה עם שיפורים ותכונות נוספות מחכה לך
        </div>
        <div class="version-info" style="font-size: 13px; margin-bottom: 10px; opacity: 0.9;">
            גרסה עדכנית
        </div>
        <button onclick="updateApp()" style="background: #27ae60; color: white; display: inline-flex; gap: 6px; align-items: center; justify-content: center;">
            <span class="icon-only" data-lucide="download" aria-hidden="true"></span>
            <span>עדכן עכשיו</span>
        </button>
        <button onclick="dismissUpdate()" class="dismiss-btn" style="display: inline-flex; gap: 6px; align-items: center; justify-content: center;">
            <span class="icon-only" data-lucide="clock" aria-hidden="true"></span>
            <span>אחר כך</span>
        </button>
    </div>

    <!-- תפריט הגדרות מערכת -->
    <div class="settings-menu">
        <button class="settings-toggle" id="settingsToggleBtn" onclick="toggleSettingsMenu(event)" aria-label="הגדרות מערכת" aria-expanded="false">
            <span class="icon-only" data-lucide="menu" aria-hidden="true"></span>
        </button>
        <div class="settings-dropdown" id="settingsDropdown" role="menu" aria-hidden="true">
            <button id="dayNightSettingBtn" role="menuitem" onclick="handleDayNightToggle(this)">
                <span id="dayNightSettingIcon" class="icon-only" data-lucide="moon" aria-hidden="true"></span>
                <span id="dayNightSettingLabel">הפעל מצב יום</span>
            </button>
            <button role="menuitem" onclick="handleThemeSelector(this)">
                <span class="icon-only" data-lucide="palette" aria-hidden="true"></span>
                <span>בחר עיצוב</span>
            </button>
            <button role="menuitem" onclick="handleLayoutSelector(this)">
                <span class="icon-only" data-lucide="layout-dashboard" aria-hidden="true"></span>
                <span>בחר פריסה</span>
            </button>
            <button role="menuitem" onclick="openVoiceCommandsHelp()">
                <span class="icon-only" data-lucide="mic" aria-hidden="true"></span>
                <span>פקודות קוליות</span>
            </button>
            <button role="menuitem" onclick="handleUpdateCheck(this)">
                <span class="icon-only" data-lucide="refresh-cw" aria-hidden="true"></span>
                <span>בדוק עדכון עכשיו</span>
            </button>
            <button role="menuitem" onclick="handleHardReload(this)">
                <span class="icon-only" data-lucide="rotate-ccw" aria-hidden="true"></span>
                <span>רענון קשיח (ניקוי מטמון)</span>
            </button>
            <button role="menuitem" onclick="handleGoBack(this)">
                <span class="icon-only" data-lucide="arrow-right" aria-hidden="true"></span>
                <span>חזרה לתפריט הראשי</span>
            </button>
        </div>
    </div>

    <!-- Theme selector modal -->
    <div class="theme-selector-overlay" id="themeSelectorOverlay" aria-hidden="true" onclick="themeSelectorOverlayClick(event)">
            <div class="theme-selector-modal" role="dialog" aria-modal="true" aria-labelledby="themeSelectorTitle">
                <div class="theme-selector-header">
                    <h3 id="themeSelectorTitle" style="display:flex;align-items:center;gap:8px;">
                        <span class="inline-icon" data-lucide="palette" aria-hidden="true"></span>
                        <span>בחר עיצוב לנגן</span>
                    </h3>
                    <button class="theme-selector-close" aria-label="סגור" onclick="closeThemeSelector()">
                        <span class="icon-only" data-lucide="x" aria-hidden="true"></span>
                    </button>
                </div>
            <div class="theme-card-grid">
                <div class="theme-card active" data-theme="dark" onclick="selectTheme('dark')">
                    <div class="theme-preview"></div>
                    <div class="theme-card-info">
                        <h4>Dark Graphite</h4>
                        <p>כהה פרימיום לנהיגת לילה</p>
                    </div>
                </div>
                <div class="theme-card" data-theme="light" onclick="selectTheme('light')">
                    <div class="theme-preview"></div>
                    <div class="theme-card-info">
                        <h4>Light Titanium</h4>
                        <p>בהיר ונקי לנהיגת יום</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Commands Help Modal -->
    <div class="voice-help-overlay" id="voiceHelpOverlay" aria-hidden="true" onclick="voiceHelpOverlayClick(event)">
        <div class="voice-help-modal" role="dialog" aria-modal="true" aria-labelledby="voiceHelpTitle">
            <div class="voice-help-header">
                <h3 id="voiceHelpTitle">
                    <span class="inline-icon" data-lucide="mic" aria-hidden="true"></span>
                    <span>פקודות קוליות</span>
                </h3>
                <button class="voice-help-close" aria-label="סגור" onclick="closeVoiceCommandsHelp()">
                    <span class="icon-only" data-lucide="x" aria-hidden="true"></span>
                </button>
            </div>
            <div class="voice-help-content">
                <p class="voice-help-intro">אמור את אחת הפקודות הבאות כדי לשלוט בנגן:</p>
                
                <div class="voice-help-section">
                    <h4><span class="inline-icon" data-lucide="music" aria-hidden="true"></span> שליטה בשירים</h4>
                    <ul>
                        <li><strong>"הבא"</strong> / <strong>"קדימה"</strong> - מעבר לשיר הבא</li>
                        <li><strong>"קודם"</strong> / <strong>"אחורה"</strong> - חזרה לשיר הקודם</li>
                    </ul>
                </div>

                <div class="voice-help-section">
                    <h4><span class="inline-icon" data-lucide="play-circle" aria-hidden="true"></span> שליטה בניגון</h4>
                    <ul>
                        <li><strong>"נגן"</strong> / <strong>"הפעל"</strong> - הפעלת הנגן</li>
                        <li><strong>"עצור"</strong> / <strong>"הפסק"</strong> - עצירת הנגן</li>
                    </ul>
                </div>

                <div class="voice-help-section">
                    <h4><span class="inline-icon" data-lucide="volume-2" aria-hidden="true"></span> שליטה בעוצמה</h4>
                    <ul>
                        <li><strong>"הגבר"</strong> / <strong>"חזק יותר"</strong> - הגברת עוצמה</li>
                        <li><strong>"הנמך"</strong> / <strong>"חלש יותר"</strong> - הנמכת עוצמה</li>
                        <li><strong>"השתק"</strong> / <strong>"שקט"</strong> - השתקה</li>
                    </ul>
                </div>

                <div class="voice-help-section">
                    <h4><span class="inline-icon" data-lucide="list-music" aria-hidden="true"></span> שליטה בפלייליסטים</h4>
                    <ul>
                        <li><strong>"פלייליסט הבא"</strong> - מעבר לפלייליסט הבא</li>
                        <li><strong>"פלייליסט קודם"</strong> - חזרה לפלייליסט הקודם</li>
                    </ul>
                </div>

                <div class="voice-help-section">
                    <h4><span class="inline-icon" data-lucide="shuffle" aria-hidden="true"></span> ערבוב</h4>
                    <ul>
                        <li><strong>"ערבוב"</strong> / <strong>"מצב אקראי"</strong> - הפעלת ערבוב שירים</li>
                    </ul>
                </div>

                <div class="voice-help-tip">
                    <span class="inline-icon" data-lucide="lightbulb" aria-hidden="true"></span>
                    <span>טיפ: לחץ על אינדיקטור המיקרופון כדי להפעיל/לכבות שליטה קולית</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio נסתר לניגון ברקע -->
    <audio id="backgroundAudio" style="display: none;" preload="auto"></audio>

    <div class="music-player" id="musicPlayer">
        <h2 style="font-size: 18px; margin: 5px 0; display: flex; gap: 8px; align-items: center; justify-content: center; color: rgba(237, 239, 243, 0.68); font-weight: 500;" id="playerTitle">
            <span class="inline-icon" data-lucide="headphones" aria-hidden="true"></span>
            <span>נגן מוזיקה לרכב</span>
        </h2>
        <div class="layout-columns">
            <div class="media-column">
                <div id="player" class="video-frame" title="נגן YouTube - לחיצות חסומות"></div>
            </div>
            <div class="interface-column">
                <div class="control-panel">
                    <div class="control-buttons top-controls">
                        <button class="control-btn icon-btn" title="שיר הבא" aria-label="שיר הבא" onclick="buttonClickEffect(this); nextTrack()">
                            <span class="sr-only">שיר הבא</span>
                            <span class="icon-only" data-lucide="skip-forward" aria-hidden="true"></span>
                        </button>
                        <button class="control-btn icon-btn" id="playPauseBtn" title="עצור" aria-label="עצור" onclick="buttonClickEffect(this); togglePlayPause(this)">
                            <span class="sr-only" id="playPauseSrLabel">עצור</span>
                            <span class="icon-only" data-icon-role="playpause" data-lucide="pause" aria-hidden="true"></span>
                        </button>
                        <button class="control-btn icon-btn" title="שיר קודם" aria-label="שיר קודם" onclick="buttonClickEffect(this); previousTrack()">
                            <span class="sr-only">שיר קודם</span>
                            <span class="icon-only" data-lucide="skip-back" aria-hidden="true"></span>
                        </button>
                        <button class="control-btn icon-btn shuffle-btn" id="songShuffleBtn" title="ערבוב שירים" aria-label="ערבוב שירים" onclick="buttonClickEffect(this); toggleSongShuffle()">
                            <span class="sr-only">ערבוב שירים</span>
                            <span class="icon-only" data-lucide="shuffle" aria-hidden="true"></span>
                        </button>
                        <button class="control-btn icon-btn shuffle-btn" id="playlistShuffleBtn" title="ערבוב פלייליסטים" aria-label="ערבוב פלייליסטים" onclick="buttonClickEffect(this); togglePlaylistShuffle()">
                            <span class="sr-only">ערבוב פלייליסטים</span>
                            <span class="icon-only" data-lucide="repeat" aria-hidden="true"></span>
                        </button>
                    </div>

                    <div class="control-buttons playlist-controls">
                        <button class="control-btn pill-btn" id="nextPlaylistBtn" style="display: none;"
                            title="פלייליסט הבא" aria-label="פלייליסט הבא"
                            onclick="buttonClickEffect(this); nextPlaylist()">
                            <span class="sr-only">פלייליסט הבא</span>
                            <span class="icon-only" data-lucide="chevrons-right" aria-hidden="true"></span>
                        </button>
                        <button class="control-btn pill-btn"
                            title="ניהול פלייליסטים" aria-label="ניהול פלייליסטים"
                            onclick="buttonClickEffect(this); openPlaylistManager()">
                            <span class="sr-only">ניהול פלייליסטים</span>
                            <span class="icon-only" data-lucide="list-music" aria-hidden="true"></span>
                        </button>
                        <button class="control-btn pill-btn" id="prevPlaylistBtn" style="display: none;"
                            title="פלייליסט קודם" aria-label="פלייליסט קודם"
                            onclick="buttonClickEffect(this); previousPlaylist()">
                            <span class="sr-only">פלייליסט קודם</span>
                            <span class="icon-only" data-lucide="chevrons-left" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>

                <div class="playlist-name" id="playlistName">
                    <span class="inline-icon" data-lucide="music-4" aria-hidden="true"></span>
                    <span id="playlistNameText">פלייליסט ראשי - נהיגה בכיף</span>
                </div>

                <!-- אינדיקטור שליטה קולית -->
                <div id="voiceIndicator" style="display: none; background: rgba(47, 107, 255, 0.15); border: 1px solid rgba(47, 107, 255, 0.3); color: #2F6BFF; padding: 8px 14px; border-radius: 10px; margin: 10px auto; text-align: center; font-size: 13px; font-weight: 500; cursor: pointer; user-select: none;"
                    onclick="toggleVoiceControl()">
                    <span class="inline-icon" data-lucide="mic" aria-hidden="true"></span>
                    <span>מאזין לפקודות קוליות...</span>
                </div>
                <div id="voiceCommand" style="display: none; background: rgba(47, 107, 255, 0.15); border: 1px solid rgba(47, 107, 255, 0.3); color: #2F6BFF; padding: 8px 14px; border-radius: 10px; margin: 10px auto; text-align: center; font-size: 13px; font-weight: 500; display: flex; gap: 6px; align-items: center; justify-content: center;">
                    <span class="inline-icon" data-lucide="check-circle" aria-hidden="true"></span>
                    <span>פקודה זוהתה</span>
                </div>
                
                <!-- תצוגת שיר נוכחי -->
                <div class="current-song-container" id="currentSongContainer">
                    <div class="current-song-label">שיר נוכחי:</div>
                    <div class="current-song" id="currentSong">טוען...</div>
                </div>
                
                <!-- בקר עוצמת שמע -->
                <div class="volume-control" id="volumeControl">
                    <button class="volume-icon" onclick="toggleMute()" id="volumeToggleBtn" aria-label="השתק / הפעלה" type="button">
                        <span class="icon-only" id="volumeIcon" data-lucide="volume-2" aria-hidden="true"></span>
                    </button>
                    <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
                </div>
            </div>
        </div>

        <!-- הוסרו קיצורי מקלדת כדי לחסוך מקום במסך -->
    </div>

    <!-- מודאל פתרון בעיות הרשאת מיקרופון -->
    <div id="microphoneHelpModal" class="microphone-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="microphoneHelpTitle">
        <div class="microphone-modal">
            <button class="microphone-modal-close" aria-label="סגור" onclick="closeMicrophoneHelp()">
                <span class="icon-only" data-lucide="x" aria-hidden="true"></span>
            </button>
            <h2 id="microphoneHelpTitle" style="display:flex;align-items:center;gap:8px;">
                <span class="inline-icon" data-lucide="mic" aria-hidden="true"></span>
                <span>נדרשת הרשאת מיקרופון</span>
            </h2>
            <p>
                כדי להשתמש בשליטה הקולית, עליך לאפשר גישה למיקרופון. בחר באחת האפשרויות:
            </p>
            <div class="microphone-modal-actions">
                <button class="microphone-modal-primary" onclick="retryMicrophonePermission()">
                    <span class="icon-only" data-lucide="refresh-cw" aria-hidden="true"></span>
                    <span>נסה שוב עכשיו</span>
                </button>
                <button class="microphone-modal-secondary" onclick="openMicrophoneSettingsGuide()">
                    <span class="icon-only" data-lucide="book-open" aria-hidden="true"></span>
                    <span>הוראות פתיחה בהגדרות</span>
                </button>
            </div>
            <div class="microphone-retry-status" id="microphoneRetryStatus"></div>
            <div class="microphone-settings-guide" id="microphoneSettingsGuide" style="display: none;">
                <h3 style="display:flex;gap:6px;align-items:center;">
                    <span class="inline-icon" data-lucide="smartphone" aria-hidden="true"></span>
                    <span>איך לפתוח הרשאה ידנית?</span>
                </h3>
                <ul>
                    <li><strong>Chrome / Android:</strong> הקש על סמל המנעול → Permissions → Microphone → Allow.</li>
                    <li><strong>Safari / iPhone:</strong> הגדרות → Safari → מצלמה ומיקרופון → אפשר.</li>
                    <li>לאחר העדכון רענן את האפליקציה וחזור לכאן.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- מודאל ניהול פלייליסטים -->
    <div id="playlistModal" class="playlist-modal-overlay">
        <div class="playlist-modal-container">
            <h2 class="playlist-modal-title" style="display:flex;align-items:center;gap:8px;">
                <span class="inline-icon" data-lucide="settings" aria-hidden="true"></span>
                <span>ניהול פלייליסטים</span>
            </h2>
            
            <!-- טופס הוספת פלייליסט או סרטון -->
            <div class="playlist-modal-section">
                <h3 class="playlist-section-title" style="display:flex;align-items:center;gap:6px;">
                    <span class="inline-icon" data-lucide="plus-square" aria-hidden="true"></span>
                    <span>הוסף פלייליסט או סרטון</span>
                </h3>
                <input type="text" id="newPlaylistName" placeholder="שם (לדוגמה: מוזיקה לנסיעה)" class="playlist-input">
                <input type="text" id="newPlaylistId" placeholder="לינק YouTube - סרטון או פלייליסט" class="playlist-input">
                <button onclick="addNewPlaylist()" class="playlist-btn playlist-btn-primary" style="display:flex;gap:6px;justify-content:center;align-items:center;">
                    <span class="icon-only" data-lucide="plus" aria-hidden="true"></span>
                    <span>הוסף</span>
                </button>
                <div class="playlist-hint">
                    <span class="inline-icon" data-lucide="info" aria-hidden="true"></span>
                    <b>תמיכה מלאה!</b> הדבק לינק מלא מ-YouTube:<br>
                    • סרטון: youtube.com/watch?v=...<br>
                    • פלייליסט: youtube.com/playlist?list=...
                </div>
            </div>
            
            <!-- חיפוש פלייליסטים ביוטיוב -->
            <div class="playlist-modal-section">
                <h3 class="playlist-section-title" style="display:flex;align-items:center;gap:6px;">
                    <span class="inline-icon" data-lucide="search" aria-hidden="true"></span>
                    <span>חיפוש פלייליסטים ביוטיוב</span>
                </h3>
                <div class="playlist-search-row">
                    <input type="text" id="youtubeSearchQuery" placeholder="חפש פלייליסטים..." class="playlist-input playlist-search-input"
                        onkeypress="if(event.key==='Enter') searchYouTubePlaylists()">
                    <button onclick="searchYouTubePlaylists()" class="playlist-btn playlist-btn-search" style="display:flex;align-items:center;justify-content:center;">
                        <span class="icon-only" data-lucide="search" aria-hidden="true"></span>
                    </button>
                </div>
                <div id="youtubeSearchResults" class="playlist-search-results"></div>
                <div id="searchLoading" style="display: none; text-align: center; padding: 20px; color: #aaa;">
                    <span class="inline-icon" data-lucide="loader" aria-hidden="true"></span> מחפש...
                </div>
            </div>
            
            <!-- רשימת פלייליסטים קיימים -->
            <div class="playlist-modal-section">
                <h3 class="playlist-section-title" style="display:flex;align-items:center;gap:6px;">
                    <span class="inline-icon" data-lucide="list" aria-hidden="true"></span>
                    <span>פלייליסטים קיימים</span>
                </h3>
                <div id="playlistList" class="playlist-list"></div>
            </div>
            
            <button onclick="closePlaylistManager()" class="playlist-btn playlist-btn-close" style="display:flex;gap:6px;align-items:center;justify-content:center;">
                <span class="icon-only" data-lucide="x" aria-hidden="true"></span>
                <span>סגור</span>
            </button>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // גרסת האפליקציה
        const APP_VERSION = "2.3.0";
        console.log(`[Music Player] נגן מוזיקה לרכב - גרסה ${APP_VERSION}`);

        // משתני מערכת עדכונים
        let newServiceWorker = null;
        let updateAvailable = false;
        const AUTO_REFRESH_ON_UPDATE = true; // אילוץ רענון אוטומטי לאחר עדכון
        let updatePending = false;
        let refreshing = false;
        let updateListenerAttached = false;
        const THEME_STORAGE_KEY = 'musicPlayerTheme';
        const AVAILABLE_THEMES = ['classic', 'neon', 'glass', 'forest']; // modern = base

        let player;
        let currentPlaylistIndex = 0;
        let isShuffle = false; // legacy flag (kept for compatibility)
        let songShuffleEnabled = localStorage.getItem('songShuffleEnabled') === 'true';
        let playlistShuffleEnabled = localStorage.getItem('playlistShuffleEnabled') === 'true';
        let songShuffleQueue = [];
        let songShuffleHistory = [];
        let playlistShuffleQueue = [];
        let playlistShuffleHistory = [];
        let userRequestedStop = false; // ניגן יפסיק רק אם המשתמש ביקש זאת מפורשות
        let isDayMode = false; // מצב ברירת מחדל: מצב לילה
        let lastVolume = 100; // נוסיף משתנה לשמירת עוצמת הקול האחרונה
        let deferredPrompt; // לשמירת האירוע של התקנת PWA

        function renderIcons(scope) {
            if (!window.lucide) {
                console.warn('[Icons] Lucide library not loaded');
                return;
            }
            try {
                // Use lucide.createIcons() - the correct API for CDN version
                lucide.createIcons();
            } catch (e) {
                console.error('[Icons] Error rendering icons:', e);
            }
        }

        function updateIconElement(element, iconName, options = {}) {
            if (!element || !iconName) return;
            element.setAttribute('data-lucide', iconName);
            // Re-render all icons
            renderIcons();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for Lucide to fully load
            setTimeout(() => {
                renderIcons();
            }, 100);
        });

        // Also render icons when Lucide loads
        window.addEventListener('load', () => {
            renderIcons();
        });

        let hasUserInteracted = false; // מניעת autoplay – ננגן רק לאחר לחיצה
        let adDetectionInterval = null; // מזהה זיהוי פרסומות
        let isAdPlaying = false; // האם מתנגנת פרסומת כרגע
        let lastKnownDuration = 0; // משך הסרטון האחרון שנשמר
        let lastVideoUrl = ''; // URL הסרטון האחרון
        let consecutiveAdChecks = 0; // מספר בדיקות רציפות שזיהו פרסומת
        let currentTheme = 'modern';

        // טעינת פלייליסטים מ-LocalStorage או ברירת מחדל
        const defaultPlaylists = [
            { name: "פלייליסט ראשי - נהיגה בכיף", id: "PLTpkiFPWhsF9JMQmEy4uptvTqanhTQ1Zo" },
            { name: "רוק ישראלי", id: "PLn-Gsrq4vA2s8v3yOixMDxL-cXrmSuxDC" },
            { name: "מזרחית מושלמת", id: "PLUFHSF7zKGMutOiQfwU3K2LytQBY8a_hw" },
            { name: "מוזיקה לנסיעה", id: "PLyoGzIYCpxLgeHw4tFrb5v8AIxhJu-Fae" },
            { name: "להיטים חמים", id: "PL7qAso9Bl0b91xYUe2zEjpSGeWGgrxh6l" },
            { name: "פופ ישראלי", id: "PLE9-6gZLvQ0Q2TyoNprRzF1aTzdW8UkM2" },
            { name: "קלאסיקות נצחיות", id: "PLjCGoHm3d-dkokIl_hZeS6PGj2EpRuWKf" },
            { name: "אווירה רגועה", id: "PLwrAS8k0keWQMSTv3nyzhSNEH34NED50E" }
        ];
        
        // הערה: יש להחליף את ה-Playlist IDs למעלה ב-IDs אמיתיים מ-YouTube
        // כדי למצוא Playlist ID: פתח פלייליסט ב-YouTube והעתק את הקוד אחרי "list=" בכתובת
        
        let playlists = JSON.parse(localStorage.getItem('musicPlaylists')) || defaultPlaylists;
        
        // אם יש רק פלייליסט אחד, החזר לברירת מחדל
        if (playlists.length === 1) {
            console.log('[!] נמצא רק פלייליסט אחד - מחזיר לברירת מחדל');
            playlists = defaultPlaylists;
            localStorage.setItem('musicPlaylists', JSON.stringify(playlists));
        }
        
        console.log(`[Playlists] נטענו ${playlists.length} פלייליסטים:`, playlists.map(p => p.name));

        // שמירת פלייליסטים ב-LocalStorage
        function savePlaylists() {
            localStorage.setItem('musicPlaylists', JSON.stringify(playlists));
            updatePlaylistNavigation();
        }

        // עדכון תצוגת כפתורי ניווט פלייליסטים
        function updatePlaylistNavigation() {
            const prevBtn = document.getElementById('prevPlaylistBtn');
            const nextBtn = document.getElementById('nextPlaylistBtn');
            
            console.log(`[Info] מספר פלייליסטים: ${playlists.length}`);
            console.log('[Info] רשימת פלייליסטים:', playlists.map(p => p.name).join(', '));
            
            if (playlists.length > 1) {
                if (prevBtn) prevBtn.style.display = 'inline-block';
                if (nextBtn) nextBtn.style.display = 'inline-block';
                console.log('[V] כפתורי ניווט מוצגים');
            } else {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                console.log('[!] כפתורי ניווט מוסתרים - יש רק פלייליסט אחד');
            }
        }

        // פונקציות עזר לערבוב
        function updateShuffleButtons() {
            const songBtn = document.getElementById('songShuffleBtn');
            if (songBtn) {
                songBtn.classList.toggle('active', songShuffleEnabled);
                const songTitle = songShuffleEnabled ? 'ערבוב שירים פעיל' : 'ערבוב שירים';
                songBtn.title = songTitle;
                songBtn.setAttribute('aria-label', songTitle);
            }

            const playlistBtn = document.getElementById('playlistShuffleBtn');
            if (playlistBtn) {
                playlistBtn.classList.toggle('active', playlistShuffleEnabled);
                const playlistTitle = playlistShuffleEnabled ? 'ערבוב פלייליסטים פעיל' : 'ערבוב פלייליסטים';
                playlistBtn.title = playlistTitle;
                playlistBtn.setAttribute('aria-label', playlistTitle);
            }
        }

        function getCurrentVideoIdSafe() {
            try {
                if (player && typeof player.getVideoData === 'function') {
                    const data = player.getVideoData();
                    return data && data.video_id ? data.video_id : null;
                }
            } catch (err) {
                console.warn('[!] לא ניתן לקבל מזהה וידאו נוכחי:', err);
            }
            return null;
        }

        function updatePlayPauseButton(isPlaying) {
            const btn = document.getElementById('playPauseBtn');
            if (!btn) return;

            const icon = btn.querySelector('[data-icon-role="playpause"]');
            const srLabel = document.getElementById('playPauseSrLabel');

            if (isPlaying) {
                updateIconElement(icon, 'pause');
                btn.title = 'עצור';
                btn.setAttribute('aria-label', 'עצור');
                if (srLabel) srLabel.textContent = 'עצור';
            } else {
                updateIconElement(icon, 'play');
                btn.title = 'נגן';
                btn.setAttribute('aria-label', 'נגן');
                if (srLabel) srLabel.textContent = 'נגן';
            }
        }

        function toggleMicrophoneHelp(show) {
            const modal = document.getElementById('microphoneHelpModal');
            if (!modal) return;
            modal.style.display = show ? 'flex' : 'none';
        }

        function openMicrophoneSettingsGuide() {
            const guide = document.getElementById('microphoneSettingsGuide');
            const status = document.getElementById('microphoneRetryStatus');
            if (guide) {
                guide.style.display = 'block';
            }
            if (status) {
                status.textContent = 'פתח את ההגדרות לפי ההנחיות ולאחר מכן רענן את האפליקציה.';
            }
        }

        function closeMicrophoneHelp() {
            toggleMicrophoneHelp(false);
            const status = document.getElementById('microphoneRetryStatus');
            const guide = document.getElementById('microphoneSettingsGuide');
            if (status) {
                status.textContent = '';
            }
            if (guide) {
                guide.style.display = 'none';
            }
        }

        async function retryMicrophonePermission() {
            const status = document.getElementById('microphoneRetryStatus');
            if (status) {
                status.textContent = 'מבקש הרשאה...';
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                if (status) {
                    status.textContent = '✅ ההרשאה ניתנה! השליטה הקולית הופעלה.';
                }
                closeMicrophoneHelp();
                setTimeout(() => {
                    initVoiceRecognition();
                    voiceControlEnabled = true;
                    updateVoiceIndicator();
                }, 500);
            } catch (error) {
                if (status) {
                    status.textContent = '❌ עדיין חסומה. נא לפתוח ידנית דרך ההגדרות.';
                }
                openMicrophoneSettingsGuide();
            }
        }

        function shuffleArray(array) {
            const arr = array.slice();
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function buildSongShuffleQueue() {
            if (!songShuffleEnabled || !player || typeof player.getPlaylist !== 'function') {
                return;
            }

            const playlist = player.getPlaylist();
            if (!playlist || playlist.length <= 1) {
                songShuffleQueue = [];
                return;
            }

            const currentIndex = typeof player.getPlaylistIndex === 'function' ? player.getPlaylistIndex() : -1;
            const indices = playlist.map((_, index) => index);
            const available = currentIndex >= 0 ? indices.filter(index => index !== currentIndex) : indices;
            songShuffleQueue = shuffleArray(available);
            console.log('[Shuffle] נבנתה רשימת ערבוב לשירים:', songShuffleQueue);
        }

        function ensureSongShuffleQueue() {
            if (!songShuffleEnabled) return;
            if (songShuffleQueue.length === 0) {
                buildSongShuffleQueue();
            }
        }

        function playNextShuffledSong() {
            if (!songShuffleEnabled || !player) {
                return false;
            }

            ensureSongShuffleQueue();
            if (songShuffleQueue.length === 0) {
                return false;
            }

            const currentIndex = typeof player.getPlaylistIndex === 'function' ? player.getPlaylistIndex() : -1;
            if (currentIndex >= 0) {
                songShuffleHistory.push(currentIndex);
                if (songShuffleHistory.length > 50) {
                    songShuffleHistory.shift();
                }
            }

            const nextIndex = songShuffleQueue.shift();
            if (typeof nextIndex !== 'number') {
                return false;
            }

            try {
                player.playVideoAt(nextIndex);
                console.log(`[Shuffle] מעבר אקראי לשיר במיקום ${nextIndex}`);
                return true;
            } catch (err) {
                console.warn('[!] לא ניתן לנגן שיר אקראי:', err);
                return false;
            }
        }

        function playPreviousShuffledSong() {
            if (!songShuffleEnabled || !player) {
                return false;
            }

            if (songShuffleHistory.length === 0) {
                return false;
            }

            const previousIndex = songShuffleHistory.pop();
            const currentIndex = typeof player.getPlaylistIndex === 'function' ? player.getPlaylistIndex() : -1;
            if (currentIndex >= 0 && !songShuffleQueue.includes(currentIndex)) {
                songShuffleQueue.unshift(currentIndex);
            }

            if (typeof previousIndex !== 'number') {
                return false;
            }

            try {
                player.playVideoAt(previousIndex);
                console.log(`[Prev] חזרה לשיר ממערך ההיסטוריה (מיקום ${previousIndex})`);
                return true;
            } catch (err) {
                console.warn('[!] לא ניתן לחזור לשיר קודם בערבוב:', err);
                return false;
            }
        }

        function resetSongShuffleState() {
            songShuffleQueue = [];
            songShuffleHistory = [];
            if (songShuffleEnabled) {
                setTimeout(buildSongShuffleQueue, 500);
            }
        }

        function toggleSongShuffle() {
            songShuffleEnabled = !songShuffleEnabled;
            localStorage.setItem('songShuffleEnabled', songShuffleEnabled);
            songShuffleQueue = [];
            songShuffleHistory = [];

            if (player && typeof player.setShuffle === 'function') {
                try {
                    player.setShuffle(songShuffleEnabled);
                } catch (err) {
                    console.warn('[!] לא ניתן לעדכן מצב shuffle של הנגן:', err);
                }
            }

            if (songShuffleEnabled) {
                console.log('[Shuffle] מצב ערבוב שירים הופעל');
                buildSongShuffleQueue();
            } else {
                console.log('[Shuffle] מצב ערבוב שירים הושבת');
            }

            updateShuffleButtons();
        }

        function buildPlaylistShuffleQueue() {
            if (!playlistShuffleEnabled || playlists.length <= 1) {
                playlistShuffleQueue = [];
                return;
            }

            const indices = playlists.map((_, index) => index);
            const available = indices.filter(index => index !== currentPlaylistIndex);
            playlistShuffleQueue = shuffleArray(available);
            console.log('[Shuffle] נבנתה רשימת ערבוב לפלייליסטים:', playlistShuffleQueue);
        }

        function getNextPlaylistIndex() {
            if (!playlistShuffleEnabled || playlists.length <= 1) {
                return (currentPlaylistIndex + 1) % playlists.length;
            }

            if (playlistShuffleQueue.length === 0) {
                buildPlaylistShuffleQueue();
            }

            if (playlistShuffleQueue.length === 0) {
                return currentPlaylistIndex;
            }

            const nextIndex = playlistShuffleQueue.shift();
            playlistShuffleHistory.push(currentPlaylistIndex);
            if (playlistShuffleHistory.length > 50) {
                playlistShuffleHistory.shift();
            }
            return typeof nextIndex === 'number' ? nextIndex : currentPlaylistIndex;
        }

        function getPreviousPlaylistIndex() {
            if (!playlistShuffleEnabled || playlists.length <= 1) {
                return (currentPlaylistIndex - 1 + playlists.length) % playlists.length;
            }

            if (playlistShuffleHistory.length > 0) {
                const previousIndex = playlistShuffleHistory.pop();
                if (typeof previousIndex === 'number') {
                    if (!playlistShuffleQueue.includes(currentPlaylistIndex)) {
                        playlistShuffleQueue.unshift(currentPlaylistIndex);
                    }
                    return previousIndex;
                }
            }

            if (playlistShuffleQueue.length === 0) {
                buildPlaylistShuffleQueue();
            }

            if (playlistShuffleQueue.length === 0) {
                return currentPlaylistIndex;
            }

            return playlistShuffleQueue.pop();
        }

        function togglePlaylistShuffle() {
            playlistShuffleEnabled = !playlistShuffleEnabled;
            localStorage.setItem('playlistShuffleEnabled', playlistShuffleEnabled);
            playlistShuffleQueue = [];
            playlistShuffleHistory = [];

            if (playlistShuffleEnabled) {
                console.log('[Shuffle] מצב ערבוב פלייליסטים הופעל');
                buildPlaylistShuffleQueue();
            } else {
                console.log('[Shuffle] מצב ערבוב פלייליסטים הושבת');
            }

            updateShuffleButtons();
        }

        // פתיחת מודאל ניהול פלייליסטים
        function openPlaylistManager() {
            const modal = document.getElementById('playlistModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // מניעת גלילה ברקע
            renderPlaylistList();
        }

        // סגירת מודאל ניהול פלייליסטים
        function closePlaylistManager() {
            const modal = document.getElementById('playlistModal');
            modal.style.display = 'none';
            document.body.style.overflow = ''; // החזרת גלילה
        }

        // הצגת רשימת פלייליסטים במודאל
        function renderPlaylistList() {
            const listContainer = document.getElementById('playlistList');
            
            if (playlists.length === 0) {
                listContainer.innerHTML = '<p style="color: #aaa; text-align: center;">אין פלייליסטים. הוסף פלייליסט חדש למעלה.</p>';
                return;
            }
            
            listContainer.innerHTML = playlists.map((playlist, index) => {
                const typeIcon = playlist.type === 'video' ? '🎬' : '🎵';
                const typeLabel = playlist.type === 'video' ? 'סרטון' : 'פלייליסט';
                return `
                <div class="playlist-item">
                    <div class="playlist-item-info">
                        <div class="playlist-item-name">
                            <span class="inline-icon" data-lucide="${playlist.type === 'video' ? 'video' : 'music-3'}" aria-hidden="true"></span>
                            <span>${playlist.name}</span>
                        </div>
                        <div class="playlist-item-meta">${typeLabel}</div>
                    </div>
                    <div class="playlist-item-actions">
                        <button onclick="editPlaylistName(${index})" class="playlist-item-btn playlist-item-btn-edit" aria-label="שינוי שם פלייליסט">
                            <span class="icon-only" data-lucide="edit-3" aria-hidden="true"></span>
                        </button>
                        <button onclick="deletePlaylist(${index})" class="playlist-item-btn playlist-item-btn-delete" aria-label="מחיקת פלייליסט">
                            <span class="icon-only" data-lucide="trash-2" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            renderIcons(listContainer);
        }

        // חילוץ Video ID מלינק YouTube
        function extractYouTubeVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([\w-]{11})/,
                /^([\w-]{11})$/ // אם זה רק ה-ID עצמו
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // חילוץ Playlist ID מלינק YouTube
        function extractYouTubePlaylistId(url) {
            const patterns = [
                /[?&]list=([\w-]+)/,
                /^(PL[\w-]+)$/ // אם זה רק ה-ID עצמו
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // הוספת פלייליסט או סרטון חדש
        function addNewPlaylist() {
            const nameInput = document.getElementById('newPlaylistName');
            const idInput = document.getElementById('newPlaylistId');
            
            const name = nameInput.value.trim();
            const input = idInput.value.trim();
            
            if (!name || !input) {
                alert('[שגיאה] אנא מלא את השם והלינק');
                return;
            }
            
            // נסה לזהות אם זה פלייליסט או סרטון
            let id = null;
            let type = 'playlist';
            
            // קודם כל בדוק פלייליסט (כי לפעמים יש לינקים עם שניהם)
            const playlistId = extractYouTubePlaylistId(input);
            const videoId = extractYouTubeVideoId(input);
            
            if (playlistId) {
                id = playlistId;
                type = 'playlist';
                console.log('[Playlist] זוהה פלייליסט:', id);
            } else if (videoId) {
                id = videoId;
                type = 'video';
                console.log('[Video] זוהה סרטון:', id);
            } else {
                alert('[שגיאה] לא הצלחתי לזהות את הלינק. ודא שהדבקת לינק תקין מ-YouTube.');
                return;
            }
            
            // בדיקה אם ה-ID כבר קיים
            if (playlists.some(p => p.id === id)) {
                alert('[שגיאה] פריט עם ID זה כבר קיים');
                return;
            }
            
            playlists.push({ name, id, type });
            savePlaylists();
            renderPlaylistList();
            
            // ניקוי השדות
            nameInput.value = '';
            idInput.value = '';
            
            const typeHeb = type === 'video' ? 'סרטון' : 'פלייליסט';
            alert(`[הצלחה] ה${typeHeb} נוסף בהצלחה!`);
        }

        // מחיקת פלייליסט
        function deletePlaylist(index) {
            if (playlists.length === 1) {
                alert('[שגיאה] לא ניתן למחוק את הפלייליסט האחרון');
                return;
            }
            
            const playlist = playlists[index];
            if (confirm(`האם אתה בטוח שברצונך למחוק את "${playlist.name}"?`)) {
                playlists.splice(index, 1);
                
                // אם מחקנו את הפלייליסט הנוכחי, עבור לראשון
                if (currentPlaylistIndex >= playlists.length) {
                    currentPlaylistIndex = 0;
                }
                
                savePlaylists();
                renderPlaylistList();
                updatePlaylistName();
                
                alert('[הצלחה] הפלייליסט נמחק בהצלחה!');
            }
        }

        // שינוי שם פלייליסט
        function editPlaylistName(index) {
            const playlist = playlists[index];
            const newName = prompt('הכנס שם חדש לפלייליסט:', playlist.name);
            
            if (newName && newName.trim() !== '') {
                playlists[index].name = newName.trim();
                savePlaylists();
                renderPlaylistList();
                
                // אם זה הפלייליסט הנוכחי, עדכן גם את התצוגה
                if (currentPlaylistIndex === index) {
                    updatePlaylistName();
                }
                
                alert('[הצלחה] שם הפלייליסט עודכן בהצלחה!');
            }
        }

        // YouTube API Key - החלף במפתח שלך מ-Google Cloud Console
        const YOUTUBE_API_KEY = 'AIzaSyDfKzz3Q4VGNVzMrWGqMHQbOe9Hp4LRjyA';
        
        // חיפוש פלייליסטים ביוטיוב
        async function searchYouTubePlaylists() {
            const query = document.getElementById('youtubeSearchQuery').value.trim();
            if (!query) {
                alert('[שים לב] הכנס מילות חיפוש');
                return;
            }
            
            const resultsDiv = document.getElementById('youtubeSearchResults');
            const loadingDiv = document.getElementById('searchLoading');
            
            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';
            
            try {
                const response = await fetch(
                    `https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&maxResults=10&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error('שגיאה בחיפוש');
                }
                
                const data = await response.json();
                loadingDiv.style.display = 'none';
                
                if (!data.items || data.items.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">לא נמצאו תוצאות</div>';
                    return;
                }
                
                resultsDiv.innerHTML = data.items.map(item => {
                    const playlistId = item.id.playlistId;
                    const title = item.snippet.title;
                    const channelTitle = item.snippet.channelTitle;
                    const thumbnail = item.snippet.thumbnails.default.url;
                    const isAlreadyAdded = playlists.some(p => p.id === playlistId);
                    
                    return `
                        <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #333; border-radius: 8px; margin-bottom: 10px;">
                            <img src="${thumbnail}" alt="" style="width: 60px; height: 45px; border-radius: 4px; object-fit: cover;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: white; font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${title}">${title}</div>
                                <div style="color: #aaa; font-size: 12px;">${channelTitle}</div>
                            </div>
                            <button onclick="addFromSearch('${playlistId}', '${title.replace(/'/g, "\\'")}')" 
                                style="padding: 8px 15px; background: ${isAlreadyAdded ? '#666' : '#1db954'}; color: white; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; white-space: nowrap;"
                                ${isAlreadyAdded ? 'disabled' : ''}>
                                ${isAlreadyAdded ? '✓ קיים' : '➕ הוסף'}
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                console.error('שגיאת חיפוש:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                        ❌ שגיאה בחיפוש<br>
                        <span style="font-size: 12px; color: #aaa;">נסה שוב מאוחר יותר</span>
                    </div>
                `;
            }
        }
        
        // הוספת פלייליסט מתוצאות החיפוש
        function addFromSearch(playlistId, title) {
            if (playlists.some(p => p.id === playlistId)) {
                alert('[שגיאה] פלייליסט זה כבר קיים');
                return;
            }
            
            playlists.push({ 
                name: title, 
                id: playlistId, 
                type: 'playlist' 
            });
            savePlaylists();
            renderPlaylistList();
            
            // עדכון כפתור בתוצאות החיפוש
            searchYouTubePlaylists();
            
            alert(`[הצלחה] הפלייליסט "${title}" נוסף בהצלחה!`);
        }

        function onYouTubeIframeAPIReady() {
            console.log('YouTube API נטען בהצלחה');
            
            // הצגת הודעה למשתמש שהפלייליסט נטען
            document.getElementById('currentSong').textContent = 'טוען פלייליסט... אנא המתן';
            
            try {
                createPlayer();
            } catch (e) {
                console.error('שגיאה בטעינת נגן YouTube:', e);
                // ניסיון שני עם השהייה
                setTimeout(() => {
                    try {
                        createPlayer();
                    } catch (error) {
                        console.error('ניסיון שני נכשל:', error);
                        // יצירת iframe ישירות ללא autoplay
                        document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                            playlists[currentPlaylistIndex].id + 
                            '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                    }
                }, 1500);
            }
        }

        function createPlayer() {
            console.log('יוצר נגן YouTube...');
            const currentItem = playlists[currentPlaylistIndex];
            const isVideo = currentItem.type === 'video';
            
            try {
                // הגדרות שונות לסרטון בודד לעומת פלייליסט
                const playerVars = {
                    'autoplay': 1,
                    'controls': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'enablejsapi': 1
                };
                
                if (isVideo) {
                    // סרטון בודד
                    console.log('[Video] טוען סרטון בודד:', currentItem.id);
                } else {
                    // פלייליסט
                    playerVars.listType = 'playlist';
                    playerVars.list = currentItem.id;
                    console.log('[Playlist] טוען פלייליסט:', currentItem.id);
                }
                
                const playerConfig = {
                    height: '350',
                    width: '100%',
                    playerVars: playerVars,
                    events: {
                    'onReady': () => {
                        updatePlaylistName();
                        // מנסה להתחיל לנגן אוטומטית
                        document.getElementById('currentSong').textContent = 'מתחיל לנגן...';
                        setTimeout(() => {
                            if (player && player.playVideo) {
                                player.playVideo();
                            }
                        }, 500);
                        // אתחול מצב ערבוב שירים אם הופעל בעבר
                        if (songShuffleEnabled && player && player.setShuffle) {
                            try {
                                player.setShuffle(true);
                                buildSongShuffleQueue();
                            } catch (err) {
                                console.warn('[!] לא ניתן להפעיל מצב ערבוב בעת טעינת הנגן:', err);
                            }
                        }
                        updatePlayPauseButton(false);
                        updateShuffleButtons();

                        if (pendingRestoreState && !restoringPlayback) {
                            console.log('[Restore] מנסה לשחזר את השיר האחרון...');
                            setTimeout(() => attemptRestorePlayback(), 500);
                        }
                    },
                    'onStateChange': (event) => {
                        // עדכון שם השיר כאשר השיר משתנה
                        if (event.data === YT.PlayerState.PLAYING) {
                            userRequestedStop = false;
                            updateCurrentSong();
                            updatePlayPauseButton(true);
                            startPlaybackStateTracking();
                            if (restoringPlayback && pendingRestoreState) {
                                const targetTime = pendingRestoreState.time || 0;
                                if (typeof player.seekTo === 'function') {
                                    console.log(`[Restore] משחזר מיקום ${targetTime} שניות`);
                                    try {
                                        player.seekTo(targetTime, true);
                                    } catch (err) {
                                        console.warn('[!] לא ניתן לשחזר מיקום בזמן:', err);
                                    }
                                }
                                pendingRestoreState = null;
                                restoringPlayback = false;
                            }
                        } else if (event.data === YT.PlayerState.PAUSED) {
                            updatePlayPauseButton(false);

                            if (!userRequestedStop) {
                                console.log('[Player] הנגן הושהה ללא בקשת המשתמש - ממשיך לנגן');
                                setTimeout(() => {
                                    if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PAUSED && !userRequestedStop) {
                                        playVideo();
                                    }
                                }, 800);
                            }
                        } else if (event.data === YT.PlayerState.ENDED) {
                            updatePlayPauseButton(false);

                            if (!userRequestedStop) {
                                console.log('[Player] שיר הסתיים - עובר לשיר הבא אוטומטית');
                                setTimeout(() => {
                                    if (!userRequestedStop) {
                                        nextTrack();
                                    }
                                }, 300);
                            }
                            stopPlaybackStateTracking();
                        }
                    },
                    'onError': handlePlayerError
                    }
                };
                
                // אם זה סרטון בודד, הוסף את ה-videoId
                if (isVideo) {
                    playerConfig.videoId = currentItem.id;
                }
                
                player = new YT.Player('player', playerConfig);
            } catch (error) {
                console.error('שגיאה ביצירת נגן YouTube:', error);
                // ניסיון שני אם הראשון נכשל
                setTimeout(() => {
                    try {
                        const item = playlists[currentPlaylistIndex];
                        const embedUrl = item.type === 'video' 
                            ? `https://www.youtube.com/embed/${item.id}?autoplay=0&rel=0&modestbranding=1`
                            : `https://www.youtube.com/embed/videoseries?list=${item.id}&autoplay=0&rel=0&modestbranding=1`;
                        document.getElementById('player').innerHTML = `<iframe width="100%" height="350" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    } catch (e) {
                        console.error('ניסיון יצירת נגן גיבוי נכשל:', e);
                    }
                }, 1000);
            }
        }

        function updatePlaylistName() {
            const nameContainer = document.getElementById('playlistNameText');
            if (nameContainer) {
                nameContainer.textContent = playlists[currentPlaylistIndex].name;
            }
        }

        function playVideo(userInitiated = false) {
            if (userRequestedStop && !userInitiated) {
                console.log('⏸️ ניגון אוטומטי נחסם - המשתמש עצר את הנגן ידנית');
                return;
            }

            if (player && player.playVideo) {
                if (userInitiated) {
                    userRequestedStop = false;
                }

                hasUserInteracted = true;
                player.playVideo();
                startAdDetection(); // הפעל זיהוי פרסומות
                
                // אתחל background audio למקרה של מעבר לרקע
                const backgroundAudio = document.getElementById('backgroundAudio');
                if (backgroundAudio && backgroundAudio.paused) {
                    const silenceUrl = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                    backgroundAudio.src = silenceUrl;
                    backgroundAudio.loop = true;
                    backgroundAudio.volume = 0.01; // שקט מאוד
                    backgroundAudio.play().catch(e => console.log('Silent audio init:', e));
                    console.log('🔇 Background audio initialized (silent)');
                }
                updatePlayPauseButton(true);
            }
        }

        function pauseVideo(userInitiated = false) {
            if (userInitiated) {
                userRequestedStop = true;
            }

            if (player && player.pauseVideo) {
                player.pauseVideo();
                stopAdDetection();
                updatePlayPauseButton(false);
            }
        }

        function togglePlayPause(btn) {
            if (!player || typeof player.getPlayerState !== 'function') {
                playVideo();
                return;
            }

            const state = player.getPlayerState();
            // YT.PlayerState.PLAYING === 1, PAUSED === 2, BUFFERING === 3, UNSTARTED === -1, ENDED === 0
            if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
                pauseVideo(true);
            } else {
                playVideo(true);
            }
        }

        // איפוס הפרמטרים שמזהים פרסומות כדי לאפשר זיהוי מחדש לאחר דילוג ידני
        function prepareAdDetectionForManualSkip() {
            consecutiveAdChecks = 0;
            isAdPlaying = false;
            lastVideoUrl = '';
            lastKnownDuration = 0;
        }

        // הפעל מחדש את מנגנון זיהוי הפרסומות לאחר שהמשתמש דילג ידנית על שיר
        function restartAdDetectionAfterManualSkip() {
            // בדיקות מהירות ואגרסיביות מיד אחרי דילוג ידני
            // פרסומות בדרך כלל מופיעות תוך 0-2 שניות אחרי מעבר שיר
            const rapidChecks = [50, 150, 300, 500, 800, 1200, 1800, 2500];
            
            rapidChecks.forEach(delay => {
                setTimeout(() => {
                    aggressiveAdCheck();
                }, delay);
            });

            setTimeout(() => {
                const shouldRestartViaPlay = player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING;

                if (shouldRestartViaPlay) {
                    playVideo();
                } else {
                    startAdDetection();
                }
            }, 350);
        }

        // בדיקת פרסומות אגרסיבית במיוחד - מדלג מיד על כל דבר חשוד
        function aggressiveAdCheck() {
            if (!player || !player.getDuration || !player.getPlayerState) return;
            
            try {
                const playerState = player.getPlayerState();
                if (playerState !== 1 && playerState !== 3) return; // רק אם מנגן או טוען
                
                const duration = player.getDuration();
                let videoData = null;
                let isLikelyAd = false;
                
                try {
                    videoData = player.getVideoData ? player.getVideoData() : null;
                } catch (e) {
                    isLikelyAd = true; // אם לא ניתן לקבל מידע - כנראה פרסומת
                }
                
                // בדיקות מהירות לזיהוי פרסומת
                if (duration > 0 && duration <= 60) {
                    isLikelyAd = true;
                    console.log('🚨 משך קצר מזוהה:', duration);
                }
                
                if (videoData) {
                    const videoId = videoData.video_id || '';
                    const title = (videoData.title || '').toLowerCase();
                    
                    // פרסומות לרוב יש ID קצר
                    if (videoId.length < 10 && videoId.length > 0) {
                        isLikelyAd = true;
                        console.log('🚨 video_id קצר:', videoId);
                    }
                    
                    // מילות מפתח של פרסומות
                    const adWords = ['ad', 'sponsor', 'promo', 'פרסומת', 'buy', 'shop', 'offer', 'deal', 'sale', 'click', 'subscribe'];
                    if (adWords.some(w => title.includes(w))) {
                        isLikelyAd = true;
                        console.log('🚨 מילת פרסומת בכותרת:', title);
                    }
                    
                    // כותרת ריקה או חסרה
                    if (!title || title.trim() === '') {
                        isLikelyAd = true;
                    }
                } else {
                    isLikelyAd = true;
                }
                
                // בדיקת playlist - אם אין playlist זה כנראה פרסומת
                try {
                    const playlist = player.getPlaylist ? player.getPlaylist() : null;
                    if (!playlist || playlist.length === 0) {
                        isLikelyAd = true;
                        console.log('🚨 אין playlist - כנראה פרסומת');
                    }
                } catch (e) {
                    isLikelyAd = true;
                }
                
                // השבתנו את ההשתקה האוטומטית כי היא גרמה להשתקת שירים רגילים
                // אם יש פרסומות, המשתמש יכול לדלג ידנית
                if (isLikelyAd) {
                    console.log('💡 זוהה תוכן חשוד - לא משתיקים (ייתכן שזה שיר רגיל)');
                }
            } catch (e) {
                console.error('שגיאה בבדיקת פרסומת אגרסיבית:', e);
            }
        }

        function nextTrack() {
            if (!player) return;

            hasUserInteracted = true;
            userRequestedStop = false;

            prepareAdDetectionForManualSkip();

            if (songShuffleEnabled && playNextShuffledSong()) {
                restartAdDetectionAfterManualSkip();
                return;
            }

            if (player.nextVideo) {
                player.nextVideo();
                setTimeout(() => {
                    restartAdDetectionAfterManualSkip();
                    if (player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        playVideo();
                    }
                }, 400);
            }
        }

        function previousTrack() {
            if (!player) return;

            hasUserInteracted = true;
            userRequestedStop = false;

            prepareAdDetectionForManualSkip();

            if (songShuffleEnabled && playPreviousShuffledSong()) {
                restartAdDetectionAfterManualSkip();
                return;
            }

            if (player.previousVideo) {
                player.previousVideo();
                setTimeout(() => {
                    restartAdDetectionAfterManualSkip();
                    if (player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        playVideo();
                    }
                }, 400);
            }
        }

        function nextPlaylist() {
            const oldIndex = currentPlaylistIndex;
            const targetIndex = getNextPlaylistIndex();
            currentPlaylistIndex = targetIndex;
            console.log(`⏭️ מעבר מפלייליסט ${oldIndex} (${playlists[oldIndex].name}) לפלייליסט ${currentPlaylistIndex} (${playlists[currentPlaylistIndex].name})`);
            hasUserInteracted = true;
            
            // עדכן את שם הפלייליסט מיד
            updatePlaylistName();
            
            // טען את הנגן מחדש
            reloadPlayer();
            
            // הוספת אפקט ויזואלי כדי שהמשתמש ידע שהפעולה התקבלה
            const playlistName = document.getElementById('playlistName');
            playlistName.style.animation = 'none';
            setTimeout(() => {
                playlistName.style.animation = 'flashEffect 0.5s';
            }, 10);
        }

        function previousPlaylist() {
            const oldIndex = currentPlaylistIndex;
            const targetIndex = getPreviousPlaylistIndex();
            currentPlaylistIndex = targetIndex;
            console.log(`⏮️ מעבר מפלייליסט ${oldIndex} (${playlists[oldIndex].name}) לפלייליסט ${currentPlaylistIndex} (${playlists[currentPlaylistIndex].name})`);
            hasUserInteracted = true;
            
            // עדכן את שם הפלייליסט מיד
            updatePlaylistName();
            
            // טען את הנגן מחדש
            reloadPlayer();
            
            // הוספת אפקט ויזואלי כדי שהמשתמש ידע שהפעולה התקבלה
            const playlistName = document.getElementById('playlistName');
            playlistName.style.animation = 'none';
            setTimeout(() => {
                playlistName.style.animation = 'flashEffect 0.5s';
            }, 10);
        }

        function reloadPlayer() {
            console.log(`טוען מחדש פלייליסט: ${playlists[currentPlaylistIndex].name}`);

            try {
                if (player) {
                    player.destroy();
                }
                resetSongShuffleState();
                if (playlistShuffleEnabled) {
                    buildPlaylistShuffleQueue();
                }
                
                // יצירת נגן חדש לאחר השהייה קצרה
                setTimeout(() => {
                    createPlayer();
                    
                    // אם היצירה נכשלה, נסה בדרך אחרת
                    setTimeout(() => {
                        if (!player || (player && typeof player.getPlayerState !== 'function')) {
                            console.log('ניסיון לטעון בדרך ישירה');
                            const item = playlists[currentPlaylistIndex];
                            const embedUrl = item.type === 'video' 
                                ? `https://www.youtube.com/embed/${item.id}?autoplay=0&rel=0&modestbranding=1`
                                : `https://www.youtube.com/embed/videoseries?list=${item.id}&autoplay=0&rel=0&modestbranding=1`;
                            document.getElementById('player').innerHTML = `<iframe width="100%" height="350" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;

                            // עדכון שם הפלייליסט גם במצב זה
                            updatePlaylistName();
                        }
                    }, 2000);
                }, 500);
            } catch (error) {
                console.error('שגיאה בטעינת פלייליסט:', error);

                // ניסיון אחרון באמצעות הטמעה ישירה ללא autoplay
                const item = playlists[currentPlaylistIndex];
                const embedUrl = item.type === 'video' 
                    ? `https://www.youtube.com/embed/${item.id}?autoplay=0&rel=0&modestbranding=1`
                    : `https://www.youtube.com/embed/videoseries?list=${item.id}&autoplay=0&rel=0&modestbranding=1`;
                document.getElementById('player').innerHTML = `<iframe width="100%" height="350" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;

                updatePlaylistName();
            }
        }

        function goBack() {
            // מכיוון שמדובר ביישום דף בודד, נעביר לדף הדמה של תפריט ראשי
            alert('תודה שהשתמשת בנגן המוזיקה לרכב!\nזה הדף הראשי של האפליקציה.');
        }

        function buttonClickEffect(button) {
            button.classList.add("active-effect");
            setTimeout(() => {
                button.classList.remove("active-effect");
            }, 300);
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function toggleSettingsMenu(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            if (!dropdown || !toggleBtn) {
                return;
            }

            event.stopPropagation();

            const isOpen = !dropdown.classList.contains('open');
            if (isOpen) {
                dropdown.classList.add('open');
                dropdown.setAttribute('aria-hidden', 'false');
                toggleBtn.setAttribute('aria-expanded', 'true');
                document.addEventListener('click', handleSettingsOutsideClick);
                document.addEventListener('keydown', handleSettingsKeydown);
            } else {
                closeSettingsMenu();
            }
        }

        function closeSettingsMenu() {
            const dropdown = document.getElementById('settingsDropdown');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            if (!dropdown || !toggleBtn) {
                return;
            }

            dropdown.classList.remove('open');
            dropdown.setAttribute('aria-hidden', 'true');
            toggleBtn.setAttribute('aria-expanded', 'false');
            document.removeEventListener('click', handleSettingsOutsideClick);
            document.removeEventListener('keydown', handleSettingsKeydown);
        }

        function handleSettingsOutsideClick(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            if (!dropdown || !toggleBtn) {
                return;
            }

            if (!dropdown.contains(event.target) && event.target !== toggleBtn) {
                closeSettingsMenu();
            }
        }

        function handleSettingsKeydown(event) {
            if (event.key === 'Escape') {
                closeSettingsMenu();
            }
        }

        function handleDayNightToggle(button) {
            buttonClickEffect(button);
            toggleDayNightMode();
            closeSettingsMenu();
        }

        function handleThemeSelector(button) {
            if (button) {
                buttonClickEffect(button);
            }
            closeSettingsMenu();
            openThemeSelector();
        }

        function handleLayoutSelector(button) {
            if (button) {
                buttonClickEffect(button);
            }
            closeSettingsMenu();
            alert('בחירת פריסה תתווסף בקרוב (שלב C)');
        }

        function openThemeSelector() {
            const overlay = document.getElementById('themeSelectorOverlay');
            if (overlay) {
                overlay.classList.add('open');
                overlay.setAttribute('aria-hidden', 'false');
                updateThemeCardsActiveState();
            }
        }

        function closeThemeSelector() {
            const overlay = document.getElementById('themeSelectorOverlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.setAttribute('aria-hidden', 'true');
            }
        }

        function themeSelectorOverlayClick(event) {
            if (event.target && event.target.id === 'themeSelectorOverlay') {
                closeThemeSelector();
            }
        }

        function selectTheme(theme) {
            if (theme !== 'modern' && !AVAILABLE_THEMES.includes(theme)) {
                console.warn('Theme not recognized:', theme);
                return;
            }
            applyTheme(theme);
            closeThemeSelector();
        }

        // Voice Commands Help Modal Functions
        function openVoiceCommandsHelp() {
            const overlay = document.getElementById('voiceHelpOverlay');
            if (overlay) {
                overlay.classList.add('open');
                overlay.setAttribute('aria-hidden', 'false');
                // Close settings menu
                const dropdown = document.getElementById('settingsDropdown');
                if (dropdown) dropdown.classList.remove('open');
                // Render icons
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function closeVoiceCommandsHelp() {
            const overlay = document.getElementById('voiceHelpOverlay');
            if (overlay) {
                overlay.classList.remove('open');
                overlay.setAttribute('aria-hidden', 'true');
            }
        }

        function voiceHelpOverlayClick(event) {
            if (event.target && event.target.id === 'voiceHelpOverlay') {
                closeVoiceCommandsHelp();
            }
        }

        function applyTheme(theme) {
            const body = document.body;
            AVAILABLE_THEMES.forEach(t => body.classList.remove(`theme-${t}`));
            if (theme && theme !== 'modern') {
                body.classList.add(`theme-${theme}`);
            }
            currentTheme = theme || 'modern';
            localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
            updateThemeCardsActiveState();
        }

        function updateThemeCardsActiveState() {
            const cards = document.querySelectorAll('.theme-card');
            cards.forEach(card => {
                const cardTheme = card.getAttribute('data-theme');
                const isActive = cardTheme === currentTheme || (currentTheme === 'modern' && cardTheme === 'modern');
                card.classList.toggle('active', isActive);
            });
        }

        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            if (savedTheme && (savedTheme === 'modern' || AVAILABLE_THEMES.includes(savedTheme))) {
                currentTheme = savedTheme;
            } else {
                currentTheme = 'modern';
            }
            applyTheme(currentTheme);
        }

        async function handleUpdateCheck(button) {
            buttonClickEffect(button);
            closeSettingsMenu();
            
            // הצג הודעה למשתמש
            document.getElementById('currentSong').textContent = 'בודק עדכונים...';
            
            try {
                // נסה לבדוק עדכונים דרך Service Worker
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.update();
                        
                        // בדוק אם יש Service Worker ממתין
                        if (registration.waiting) {
                            document.getElementById('currentSong').textContent = 'נמצא עדכון! מרענן...';
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            setTimeout(() => window.location.reload(), 500);
                            return;
                        }
                    }
                }
                
                // אם לא נמצא עדכון דרך SW, נסה רענון קשיח
                document.getElementById('currentSong').textContent = 'מרענן את האפליקציה...';
                
                // מחק cache ורענן
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                // רענון קשיח
                window.location.reload(true);
                
            } catch (error) {
                console.error('שגיאה בבדיקת עדכונים:', error);
                document.getElementById('currentSong').textContent = 'שגיאה בבדיקת עדכונים';
            }
        }

        function handleGoBack(button) {
            buttonClickEffect(button);
            closeSettingsMenu();
            goBack();
        }

        async function hardReloadApp() {
            try {
                // נקה Service Worker קיים אם יש
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        try {
                            await registration.unregister();
                        } catch (swError) {
                            console.warn('[!] Service Worker unregister failed:', swError);
                        }
                    }
                }

                // נקה Cache Storage (PWA)
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
            } catch (error) {
                console.warn('[!] hardReloadApp cleanup issue:', error);
            } finally {
                // רענון קשיח
                window.location.reload(true);
            }
        }

        function handleHardReload(button) {
            buttonClickEffect(button);
            closeSettingsMenu();
            hardReloadApp();
        }

        function updateDayNightSettingUI() {
            const icon = document.getElementById('dayNightSettingIcon');
            const label = document.getElementById('dayNightSettingLabel');
            if (!icon || !label) {
                return;
            }

            if (isDayMode) {
                icon.setAttribute('data-lucide', 'sun');
                label.textContent = 'הפעל מצב לילה';
            } else {
                icon.setAttribute('data-lucide', 'moon');
                label.textContent = 'הפעל מצב יום';
            }
            renderIcons(icon);
        }
        // פונקציה להחלפת מצב יום/לילה
        function toggleDayNightMode() {
            isDayMode = !isDayMode;
            const body = document.body;
            
            if (isDayMode) {
                body.classList.add('day-mode');
            } else {
                body.classList.remove('day-mode');
            }
            
            updateDayNightSettingUI();
        }
        
        // בדיקת זמן יום אוטומטית בטעינה
        function checkDayTime() {
            const hour = new Date().getHours();
            // אם השעה בין 7 בבוקר ל-19 בערב, הפעל מצב יום
            if (hour >= 7 && hour < 19 && !isDayMode) {
                toggleDayNightMode();
            }
        }
        
        // בדיקת זמן יום בטעינה
        window.addEventListener('load', checkDayTime);
        window.addEventListener('load', updateDayNightSettingUI);

        // מניעת כיבוי מסך
        function preventScreenSleep() {
            // שימוש ב-NoSleep.js למניעת כיבוי מסך
            if ('wakeLock' in navigator) {
                // אם הדפדפן תומך ב-Wake Lock API
                let wakeLock = null;
                
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('מסך נשאר דלוק - Wake Lock הופעל');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock שוחרר, מנסה להפעיל מחדש...');
                            requestWakeLock(); // ניסיון להפעיל מחדש
                        });
                    } catch (err) {
                        console.error(`לא ניתן להפעיל Wake Lock: ${err.name}, ${err.message}`);
                        // הפעלת שיטה חלופית - נגינת סרטון שקט ללא נראות
                        fallbackNoSleep();
                    }
                };
                
                // הפעלת Wake Lock בעת טעינת הדף
                requestWakeLock();
                
                // הפעלה מחדש של Wake Lock כאשר הדף חוזר להיות גלוי
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && wakeLock === null) {
                        requestWakeLock();
                    }
                });
            } else {
                // שיטה חלופית אם הדפדפן לא תומך ב-Wake Lock API
                fallbackNoSleep();
            }
        }
        
        // שיטה חלופית למניעת כיבוי מסך
        function fallbackNoSleep() {
            // יצירת אלמנט אודיו שינוגן ברקע בשקט
            console.log('מפעיל שיטה חלופית למניעת כיבוי מסך');
            setInterval(() => {
                // יצירת תזוזה קטנה כל 30 שניות כדי למנוע כיבוי מסך
                window.scrollBy(0, 1);
                window.scrollBy(0, -1);
            }, 30000);
        }
        
        // זיהוי ודילוג על פרסומות - אלגוריתם משופר במיוחד ל-PWA
        function detectAndSkipAds() {
            if (!player || !player.getDuration || !player.getCurrentTime) return;
            
            try {
                const duration = player.getDuration();
                const currentTime = player.getCurrentTime();
                const playerState = player.getPlayerState();
                let currentUrl = '';
                let videoData = null;
                
                // נסה לקבל URL ו-videoData (עשוי להיכשל בפרסומות)
                try {
                    currentUrl = player.getVideoUrl ? player.getVideoUrl() : '';
                    videoData = player.getVideoData ? player.getVideoData() : null;
                } catch (e) {
                    // אם נכשל לקבל מידע - זה כנראה פרסומת!
                    console.log('⚠️ לא ניתן לקבל מידע על הסרטון - כנראה פרסומת');
                }
                
                // בדיקה מיוחדת ל-PWA: האם זה standalone mode?
                const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                              window.navigator.standalone === true;
                
                // אסטרטגיות זיהוי משולבות:
                let adIndicators = 0;
                
                // 1. בדיקת video_id - פרסומות לעיתים קרובות יש ID קצר או מוזר
                if (videoData && videoData.video_id) {
                    const videoId = videoData.video_id;
                    // פרסומות בדרך כלל יש ID קצר מאוד או מתחיל ב-prefix מיוחד
                    if (videoId.length < 8 || videoId.startsWith('_')) {
                        adIndicators += 3;
                        console.log('🚫 זוהה video_id חשוד:', videoId);
                    }
                }
                
                // 2. בדיקת משך - רק סרטונים קצרים מאוד (פחות מ-45 שניות) חשודים
                if (duration > 0 && duration < 45) {
                    adIndicators++;
                    // אם המשך קצר מאוד (פחות מ-20 שניות) - חשוד יותר
                    if (duration < 20) {
                        adIndicators++;
                    }
                }
                
                // 3. שינוי פתאומי ב-URL או במשך - הוסר כי זה קורה תמיד בין שירים
                // שינוי URL ושינוי משך הם נורמליים בין שירים ולא צריכים להיספר
                
                // 4. בדיקת שם הסרטון (פרסומות לעיתים קרובות יש מילים מסוימות)
                if (videoData && videoData.title) {
                    const title = videoData.title.toLowerCase();
                    const adKeywords = [
                        'ad', 'advertisement', 'sponsor', 'sponsored', 
                        'פרסומת', 'מועצר', 'promo', 'commercial',
                        'visit', 'buy now', 'shop', 'deal',
                        'limited time', 'offer', 'sale'
                    ];
                    if (adKeywords.some(keyword => title.includes(keyword))) {
                        adIndicators += 4; // משקל גבוה מאוד
                        console.log('📢 זוהתה מילת מפתח בכותרת:', title);
                    }
                    
                    // אם אין כותרת או כותרת ריקה - חשוד
                    if (!title || title.trim() === '') {
                        adIndicators += 3;
                    }
                } else {
                    // אם אין videoData בכלל - חשוד מאוד
                    adIndicators += 3;
                    console.log('❌ אין videoData - כנראה פרסומת');
                }
                
                // 5. בדיקת התנהגות משונה
                const timeRemaining = duration - currentTime;
                if (timeRemaining > 0 && timeRemaining < 40 && duration < 90) {
                    adIndicators++;
                }
                
                // 6. בדיקה אם אפשר לדלג - פרסומות לעיתים קרובות לא מאפשרות דילוג
                try {
                    // אם לא ניתן לקבל playlist או שהוא ריק - כנראה פרסומת
                    const playlist = player.getPlaylist ? player.getPlaylist() : null;
                    if (!playlist || playlist.length === 0) {
                        adIndicators += 2;
                        console.log('� אין playlist - כנראה פרסומת');
                    }
                } catch (e) {
                    adIndicators += 2;
                }
                
                // 7. בדיקה מיוחדת ל-PWA - אם ב-standalone mode, היה יותר אגרסיבי
                if (isPWA && duration > 0 && duration < 90) {
                    adIndicators += 1;
                }
                
                // החלטה: אם יש 4+ אינדיקטורים, זו כנראה פרסומת - סף גבוה יותר למנוע false positives
                const threshold = isPWA ? 4 : 4;
                const isPossibleAd = adIndicators >= threshold && playerState === 1;
                
                // לוג רק כשיש חשד אמיתי לפרסומת
                if (adIndicators >= threshold - 1) {
                    console.log(`🔍 אינדיקטורים: ${adIndicators}/${threshold}, משך: ${duration.toFixed(1)}s`);
                }
                
                if (isPossibleAd) {
                    consecutiveAdChecks++;
                    
                    // צריך יותר בדיקות רציפות לפני השתקה כדי למנוע false positives
                    const checksNeeded = isPWA ? 3 : 4;
                    
                    // השבתנו את ההשתקה האוטומטית כי היא גרמה להשתקת שירים רגילים
                    // אם יש פרסומות אמיתיות, המשתמש יכול לדלג ידנית
                    if (consecutiveAdChecks >= checksNeeded) {
                        console.log(`💡 זוהה תוכן חשוד (אינדיקטורים: ${adIndicators}) - לא משתיקים (ייתכן שזה שיר רגיל)`);
                    }
                } else {
                    // לא פרסומת - איפוס והחזרת שמע
                    consecutiveAdChecks = 0;
                    isAdPlaying = false;
                    
                    // תמיד וודא שהשמע לא מושתק בזמן ניגון שיר רגיל
                    if (player.isMuted && player.isMuted() && lastVolume > 0) {
                        console.log('🔊 מחזיר שמע - זה שיר רגיל');
                        player.unMute();
                        player.setVolume(lastVolume);
                    }
                    
                    // עדכון נתונים אחרונים
                    if (duration > 60) { // רק שירים אמיתיים
                        lastKnownDuration = duration;
                    }
                }
                
                lastVideoUrl = currentUrl;
                
            } catch (e) {
                console.error('שגיאה בזיהוי פרסומות:', e);
            }
        }
        
        // הפעלת זיהוי פרסומות
        function startAdDetection() {
            if (adDetectionInterval) {
                clearInterval(adDetectionInterval);
            }
            // בדיקה כל 3 שניות - מספיק לזהות פרסומות בלי לעמוס על המערכת
            const checkInterval = 3000;
            adDetectionInterval = setInterval(detectAndSkipAds, checkInterval);
            console.log(`🛡️ מערכת זיהוי פרסומות הופעלה (כל ${checkInterval/1000} שניות)`);
        }
        
        // עצירת זיהוי פרסומות
        function stopAdDetection() {
            if (adDetectionInterval) {
                clearInterval(adDetectionInterval);
                adDetectionInterval = null;
            }
        }

        // עדכון Media Session API לניגון ברקע
        function updateMediaSession(title) {
            if ('mediaSession' in navigator) {
                try {
                    const backgroundAudio = document.getElementById('backgroundAudio');
                    
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title || 'נגן מוזיקה לרכב',
                        artist: playlists[currentPlaylistIndex].name,
                        album: '🎶 נגן שירים לרכב 🚗',
                        artwork: [
                            { src: 'car-music-icon.png', sizes: '192x192', type: 'image/png' },
                            { src: 'car-music-icon.png', sizes: '512x512', type: 'image/png' }
                        ]
                    });

                    // הגדרת פעולות שליטה
                    navigator.mediaSession.setActionHandler('play', () => {
                        playVideo(true);
                        // וודא שה-background audio פעיל
                        if (backgroundAudio && backgroundAudio.paused) {
                            backgroundAudio.play().catch(e => console.log('Background audio play failed'));
                        }
                    });
                    navigator.mediaSession.setActionHandler('pause', () => {
                        pauseVideo(true);
                        // עצור גם את ה-background audio
                        if (backgroundAudio && !backgroundAudio.paused) {
                            backgroundAudio.pause();
                        }
                    });
                    navigator.mediaSession.setActionHandler('previoustrack', () => {
                        previousTrack();
                    });
                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        nextTrack();
                    });
                    
                    // כפתורים נוספים למעבר בין פלייליסטים
                    navigator.mediaSession.setActionHandler('seekbackward', () => {
                        console.log('[Media] פלייליסט קודם (מ-Media Session)');
                        previousPlaylist();
                    });
                    navigator.mediaSession.setActionHandler('seekforward', () => {
                        console.log('[Media] פלייליסט הבא (מ-Media Session)');
                        nextPlaylist();
                    });

                    console.log('[V] Media Session API מופעל - 5 כפתורים זמינים (שירים + פלייליסטים)');
                } catch (e) {
                    console.warn('Media Session API לא נתמך:', e);
                }
            }
        }

        // עדכון שם השיר הנוכחי
        function updateCurrentSong() {
            if (player && player.getVideoData) {
                try {
                    const videoData = player.getVideoData();
                    if (videoData && videoData.title) {
                        const adIndicator = isAdPlaying ? ' [מדלג על פרסומת...]' : '';
                        const title = videoData.title;
                        document.getElementById('currentSong').textContent = title + adIndicator;
                        
                        // עדכון Media Session
                        if (!isAdPlaying) {
                            updateMediaSession(title);
                        }
                    } else if (hasUserInteracted) {
                        document.getElementById('currentSong').textContent = 'לא ניתן לקבל מידע על השיר';
                    }
                } catch (e) {
                    console.error('שגיאה בקבלת מידע על השיר:', e);
                }
            } else if (!hasUserInteracted) {
                document.getElementById('currentSong').textContent = 'מוכן לנגן – לחץ על Play כדי להתחיל';
            }
        }

        function handlePlayerError(event) {
            const currentSongLabel = document.getElementById('currentSong');
            let message = 'לא ניתן לנגן את השיר הנוכחי.';

            switch (event.data) {
                case 2:
                    message = 'כתובת הסרטון שגויה או בלתי זמינה.';
                    break;
                case 5:
                    message = 'הדפדפן לא תומך בפורמט הסרטון הנוכחי.';
                    break;
                case 100:
                case 101:
                case 150:
                    message = 'הסרטון מוגבל לצפייה בתוך YouTube בלבד.';
                    break;
            }

            currentSongLabel.textContent = message + ' מדלג לשיר הבא...';

            if (!userRequestedStop && player && player.nextVideo && hasUserInteracted) {
                setTimeout(() => {
                    if (userRequestedStop) {
                        return;
                    }
                    try {
                        userRequestedStop = false;
                        player.nextVideo();
                        setTimeout(() => {
                            if (player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING && !userRequestedStop) {
                                playVideo();
                            }
                        }, 500);
                    } catch (err) {
                        console.error('ניסיון מעבר לשיר הבא נכשל:', err);
                    }
                }, 1500);
            }
        }
        
        // בדיקה מחזורית של שם השיר הנוכחי
        setInterval(updateCurrentSong, 2000);
        
        // הפעלת מניעת כיבוי מסך בטעינת הדף
        window.addEventListener('load', preventScreenSleep);
        
        // שליטה בעוצמת השמע
        document.getElementById('volumeSlider').addEventListener('input', function() {
            if (player && player.setVolume) {
                const volume = this.value;
                player.setVolume(volume);
                updateVolumeIcon(volume);
                lastVolume = volume;
            }
        });
        
        // עדכון אייקון העוצמה לפי ערך העוצמה
        function updateVolumeIcon(volume) {
            const volumeIcon = document.getElementById('volumeIcon');
            const toggleBtn = document.getElementById('volumeToggleBtn');
            if (!volumeIcon || !toggleBtn) return;

            let iconName = 'volume-2';
            let label = 'עוצמה גבוהה';
            if (volume == 0) {
                iconName = 'volume-x';
                label = 'מושתק';
            } else if (volume < 50) {
                iconName = 'volume-1';
                label = 'עוצמה בינונית';
            }
            updateIconElement(volumeIcon, iconName);
            toggleBtn.setAttribute('aria-label', `השתק / הפעלה (${label})`);
        }
        
        // פונקציה להשתקה והפעלה מחדש של השמע
        function toggleMute() {
            if (player && player.isMuted) {
                const volumeSlider = document.getElementById('volumeSlider');
                if (player.isMuted()) {
                    player.unMute();
                    volumeSlider.value = lastVolume;
                    updateVolumeIcon(lastVolume);
                } else {
                    player.mute();
                    updateVolumeIcon(0);
                }
            }
        }
        
        // תמיכה בהתקנת PWA 
        window.addEventListener('beforeinstallprompt', (e) => {
            // מניעת הצגת החלון האוטומטי
            e.preventDefault();
            // שמירת האירוע כדי שנוכל להפעיל אותו מאוחר יותר
            deferredPrompt = e;
            
            // יצירת חלון מותאם עם הודעה להתקנה
            const installPrompt = document.createElement('div');
            installPrompt.className = 'install-prompt';
            installPrompt.innerHTML = `
                <button class="close-prompt" id="closePromptBtn">✖️</button>
                <p>רוצה להתקין את נגן המוזיקה לרכב ישירות למסך הבית?</p>
                <button id="installBtn">התקן עכשיו</button>
            `;
            document.body.appendChild(installPrompt);
            
            // הצגת החלון לאחר שנייה
            setTimeout(() => {
                installPrompt.style.display = 'block';
            }, 1000);
            
            // הוספת מאזין אירועים לכפתור הסגירה
            document.getElementById('closePromptBtn').addEventListener('click', () => {
                installPrompt.style.display = 'none';
            });
            
            // הוספת מאזין אירועים לכפתור ההתקנה
            document.getElementById('installBtn').addEventListener('click', async () => {
                // הסתרת החלון
                installPrompt.style.display = 'none';
                
                // הצגת חלון ההתקנה
                deferredPrompt.prompt();
                
                // בדיקה אם המשתמש אישר את ההתקנה
                const { outcome } = await deferredPrompt.userChoice;
                
                // איפוס deferredPrompt כי ניתן להשתמש בו רק פעם אחת
                deferredPrompt = null;
            });
        });
        
        // אם האפליקציה כבר מותקנת
        window.addEventListener('appinstalled', () => {
            // הסתרת הכפתור אם הוא עדיין מוצג
            const installPrompt = document.querySelector('.install-prompt');
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            deferredPrompt = null;
        });

        // מנגנון שמירה על האפליקציה פעילה ברקע
        function keepAppAlive() {
            // 1. Page Lifecycle API - מניעת freeze/discard באנדרואיד
            if ('onfreeze' in document) {
                document.addEventListener('freeze', (e) => {
                    console.log('❄️ אנדרואיד מנסה להקפיא - מונע!');
                    e.preventDefault();
                });
            }
            
            if ('onresume' in document) {
                document.addEventListener('resume', () => {
                    console.log('♻️ האפליקציה חודשה');
                    // וודא שהנגן עדיין פעיל
                    if (player && player.getPlayerState && player.getPlayerState() === 2) {
                        player.playVideo();
                    }
                });
            }

            // 2. סנכרון Audio ברקע עם YouTube
            const backgroundAudio = document.getElementById('backgroundAudio');
            let isBackgroundMode = false;
            
            // פונקציה לסנכרון השמע
            function syncBackgroundAudio() {
                if (!player || !player.getVideoData) return;
                
                try {
                    const videoData = player.getVideoData();
                    const videoId = videoData.video_id;
                    
                    if (videoId && isBackgroundMode) {
                        // השתמש ב-YouTube Audio URL (עובד ברקע!)
                        const audioUrl = `https://www.youtube.com/watch?v=${videoId}`;
                        console.log('[Music] מעביר לניגון ברקע:', videoData.title);
                        
                        // נגן שמע שקט כדי לשמור על הקשר פעיל
                        if (backgroundAudio.paused) {
                            // יצירת silence audio כדי לשמור על Media Session פעיל
                            const silenceUrl = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                            backgroundAudio.src = silenceUrl;
                            backgroundAudio.loop = true;
                            backgroundAudio.play().catch(e => console.log('Background audio play failed:', e));
                        }
                    }
                } catch (e) {
                    console.error('שגיאה בסנכרון שמע ברקע:', e);
                }
            }

            // 3. מניעת השהיה/סגירה של הדף
            let backgroundNotificationShown = false;
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('[App] האפליקציה עברה לרקע - שומר על פעילות');
                    isBackgroundMode = true;
                    
                    // המשך ניגון גם ברקע
                    if (player && player.getPlayerState && player.getPlayerState() === 1) {
                        console.log('[Music] ממשיך לנגן ברקע');
                        
                        // הפעל Audio ברקע
                        syncBackgroundAudio();
                        
                        // הצג הודעה למשתמש פעם אחת
                        if (!backgroundNotificationShown && 'Notification' in window && Notification.permission === 'granted') {
                            new Notification('נגן מוזיקה לרכב', {
                                body: 'המוזיקה ממשיכה לנגן ברקע',
                                icon: 'car-music-icon.png',
                                tag: 'background-music',
                                requireInteraction: false
                            });
                            backgroundNotificationShown = true;
                        }
                    }
                } else {
                    console.log('[App] האפליקציה חזרה לחזית');
                    isBackgroundMode = false;
                    
                    // עצור את ה-background audio
                    if (backgroundAudio && !backgroundAudio.paused) {
                        backgroundAudio.pause();
                    }
                    
                    // וודא שהנגן עדיין עובד
                    if (player && player.getPlayerState) {
                        const state = player.getPlayerState();
                        console.log('🔍 מצב נגן:', state);
                        
                        // אם הנגן עצר, הפעל אותו שוב
                        if (state === 2 || state === 5) {
                            player.playVideo();
                        }
                    }
                }
            });

            // 2. מניעת unload/beforeunload
            window.addEventListener('beforeunload', (e) => {
                // מונע סגירה מקרית
                if (player && player.getPlayerState && player.getPlayerState() === 1) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

            // 3. שמירה על חיבור פעיל - heartbeat (כל 30 שניות לחסוך בזיכרון)
            let heartbeatInterval = setInterval(() => {
                if (document.hidden && player && player.getPlayerState) {
                    try {
                        player.getPlayerState(); // שמירה על חיבור בשקט
                    } catch (e) {}
                }
            }, 30000); // כל 30 שניות

            // 4. מניעת sleep mode
            if ('wakeLock' in navigator) {
                let wakeLock = null;
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('🔒 Wake Lock פעיל - מונע כיבוי');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('🔓 Wake Lock שוחרר - מנסה שוב');
                            setTimeout(requestWakeLock, 1000);
                        });
                    } catch (err) {
                        console.log('⚠️ Wake Lock נכשל, מנסה שוב בעוד 5 שניות');
                        setTimeout(requestWakeLock, 5000);
                    }
                };
                
                // הפעלה ראשונית
                requestWakeLock();
                
                // הפעלה מחדש כשחוזרים מרקע
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && wakeLock === null) {
                        requestWakeLock();
                    }
                });
            }

            // 5. שמירה על Audio Context פעיל (חשוב לניגון ברקע)
            if ('AudioContext' in window || 'webkitAudioContext' in window) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                
                // שמירה על ה-context פעיל (כל 15 שניות)
                setInterval(() => {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().catch(() => {});
                    }
                }, 15000);
            }

            // 6. מניעת "freeze" ב-iOS (כל 10 שניות)
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                setInterval(() => {
                    if (document.hidden) {
                        Date.now(); // פעולה מינימלית
                    }
                }, 10000);
            }

            // 7. שמירה על Service Worker פעיל (אם קיים)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    console.log('✅ Service Worker מוכן לעבודה ברקע');
                    
                    // שליחת הודעות תקופתיות ל-Service Worker (כל 60 שניות)
                    setInterval(() => {
                        if (registration.active && document.hidden) {
                            registration.active.postMessage({ type: 'KEEP_ALIVE' });
                        }
                    }, 60000);
                });
            }

            // 8. בקשת הרשאות להתראות (לאחר אינטראקציה ראשונה)
            if ('Notification' in window && Notification.permission === 'default') {
                // נבקש הרשאה רק אחרי שהמשתמש לחץ play
                const requestNotificationPermission = () => {
                    if (hasUserInteracted) {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('✅ הרשאות התראות ניתנו');
                            }
                        });
                        // הסר את המאזין אחרי בקשה אחת
                        document.removeEventListener('click', requestNotificationPermission);
                    }
                };
                document.addEventListener('click', requestNotificationPermission);
            }

            console.log('🛡️ מנגנוני שמירה על פעילות ברקע הופעלו');
        }

        // הפעלת מנגנוני שמירה על פעילות
        window.addEventListener('load', keepAppAlive);
        
        // קיצורי מקלדת למחשב
        document.addEventListener('keydown', function(event) {
            // אם המשתמש מקליד בשדה טקסט, לא להפעיל קיצורים
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.key) {
                case ' ': // רווח - הפעלה/השהייה
                    if (player && player.getPlayerState) {
                        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                            pauseVideo();
                        } else {
                            playVideo();
                        }
                    }
                    event.preventDefault();
                    break;
                case 'ArrowRight': // חץ ימינה - שיר קודם (RTL)
                    previousTrack();
                    event.preventDefault();
                    break;
                case 'ArrowLeft': // חץ שמאלה - שיר הבא (RTL)
                    nextTrack();
                    event.preventDefault();
                    break;
                case 's': // ערבוב שירים
                case 'S':
                    toggleSongShuffle();
                    event.preventDefault();
                    break;
                case 'p': // פלייליסט הבא
                case 'P':
                    nextPlaylist();
                    event.preventDefault();
                    break;
                case 'm': // השתקה
                case 'M':
                    toggleMute();
                    event.preventDefault();
                    break;
                case 'd': // מצב יום/לילה
                case 'D':
                    toggleDayNightMode();
                    event.preventDefault();
                    break;
                case '+': // הגברת עוצמה
                case '=':
                    if (player && player.getVolume) {
                        const currentVolume = player.getVolume();
                        const newVolume = Math.min(100, currentVolume + 10);
                        player.setVolume(newVolume);
                        document.getElementById('volumeSlider').value = newVolume;
                        updateVolumeIcon(newVolume);
                    }
                    event.preventDefault();
                    break;
                case '-': // הנמכת עוצמה
                case '_':
                    if (player && player.getVolume) {
                        const currentVolume = player.getVolume();
                        const newVolume = Math.max(0, currentVolume - 10);
                        player.setVolume(newVolume);
                        document.getElementById('volumeSlider').value = newVolume;
                        updateVolumeIcon(newVolume);
                    }
                    event.preventDefault();
                    break;
            }
        });
        
        // פונקציה זו הוסרה - לא היתה בשימוש
        
        // רישום Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker נרשם בהצלחה:', registration.scope);
                        
                        // בדיקה אם יש עדכון
                        registration.addEventListener('updatefound', () => {
                            console.log('🔄 נמצא עדכון ל-Service Worker');
                        });

                        checkForUpdates();
                    })
                    .catch(error => {
                        console.error('❌ רישום Service Worker נכשל:', error);
                    });

                // בדיקת עדכונים מיד לאחר טעינה
                checkForUpdates();
            });

            if (!updateListenerAttached) {
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (updatePending && !refreshing) {
                        refreshing = true;
                        console.log('🔁 טעינת הדף לאחר עדכון Service Worker');
                        window.location.reload();
                    }
                });
                updateListenerAttached = true;
            }
        }

        // מערכת עדכונים
        function updateApp() {
            console.log('🔄 מתחיל עדכון...');
            
            if (newServiceWorker) {
                updatePending = true;
                // שליחת הוראה ל-Service Worker לדלג על מצב המתנה
                newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                const banner = document.getElementById('updateBanner');
                banner.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold;">
                        ⏳ מעדכן את האפליקציה...
                    </div>
                    <div style="margin-top: 10px;">
                        אנא המתן לרענון אוטומטי
                    </div>
                `;
            } else {
                console.log('⚠️ אין Service Worker חדש זמין');
                dismissUpdate();
            }
        }
        
        function dismissUpdate() {
            console.log('⏰ דחיית עדכון לאחר כך');
            const banner = document.getElementById('updateBanner');
            if (banner) {
                banner.style.display = 'none';
            }
            updateAvailable = false;
        }
        
        function showUpdateBanner() {
            console.log('🔔 מציג באנר עדכון');
            const banner = document.getElementById('updateBanner');
            if (!banner) return;
            banner.style.display = 'block';
            updateAvailable = true;
            
            // עדכן את הודעת הבאנר עם גרסת האפליקציה
            const versionInfo = banner.querySelector('.version-info');
            if (versionInfo) {
                versionInfo.textContent = `גרסה ${APP_VERSION}`;
            }
            
            // התראה אם הדפדפן תומך
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('🔄 עדכון זמין!', {
                    body: 'גרסה חדשה של נגן המוזיקה זמינה לעדכון',
                    icon: 'car-music-icon.png',
                    tag: 'update',
                    requireInteraction: false
                });
            }
        }

        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (!registration) return;
                    
                    registration.update();

                    if (registration.waiting) {
                        newServiceWorker = registration.waiting;
                        if (AUTO_REFRESH_ON_UPDATE) {
                            console.log('🔄 Service Worker ממתין - מאלץ רענון!');
                            updatePending = true;
                            newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            showUpdateBanner();
                        }
                    }

                    registration.addEventListener('updatefound', () => {
                        console.log('🔍 נמצא Service Worker חדש');
                        newServiceWorker = registration.installing;
                        newServiceWorker.addEventListener('statechange', () => {
                            if (newServiceWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    if (AUTO_REFRESH_ON_UPDATE) {
                                        console.log('🔄 רענון אוטומטי מאולץ - מעדכן עכשיו!');
                                        updatePending = true;
                                        newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                                        // המתן קצר ואז רענן
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 500);
                                    } else {
                                        showUpdateBanner();
                                    }
                                } else {
                                    console.log('✅ האפליקציה הותקנה לראשונה');
                                }
                            }
                        });
                    });
                });
            }
        }

        // מערכת זיהוי קולי
        let recognition = null;
        let isVoiceActive = false;
        let voiceControlEnabled = false;
        let voiceRecognitionInitialized = false;
        const VOICE_COMMAND_COOLDOWN_MS = 1200;
        const VOICE_RESTART_DELAY_MS = 350;
        let lastVoiceCommandTime = 0;
        let voiceCommandInProgress = false;
        let voiceRestartTimeout = null;
        let lastRecognizedCommand = '';
        let voiceCommandDefinitions = [];

        function showVoiceCommandFeedback(message) {
            const commandDiv = document.getElementById('voiceCommand');
            if (!commandDiv) return;
            commandDiv.textContent = message;
            commandDiv.style.display = 'block';
            setTimeout(() => {
                commandDiv.style.display = 'none';
            }, 2000);
        }

        function scheduleVoiceRecognitionRestart() {
            if (!voiceControlEnabled || !recognition) {
                return;
            }
            if (voiceRestartTimeout) {
                clearTimeout(voiceRestartTimeout);
            }
            voiceRestartTimeout = setTimeout(() => {
                startVoiceRecognition();
            }, VOICE_RESTART_DELAY_MS);
        }

        function voiceNextTrack() {
            nextTrack();
        }

        function voicePreviousTrack() {
            previousTrack();
        }

        function voiceNextPlaylist() {
            nextPlaylist();
        }

        function voicePreviousPlaylist() {
            previousPlaylist();
        }

        function voicePlay() {
            playVideo(true);
        }

        function voicePause() {
            pauseVideo(true);
        }

        function voiceToggleMute() {
            toggleMute();
        }

        function handleVoiceCommand(definition) {
            console.log('[Voice] פקודה קולית:', definition.label);
            
            // הפעל את הפעולה המתאימה
            if (definition.action && typeof definition.action === 'function') {
                definition.action();
                showVoiceCommandFeedback(definition.feedback || `✓ ${definition.label}`);
            } else {
                console.log('❓ פעולה לא מוגדרת:', definition.label);
                showVoiceCommandFeedback('❓ פקודה לא מוכרת');
            }

            setTimeout(() => {
                voiceCommandInProgress = false;
            }, Math.max(VOICE_RESTART_DELAY_MS + 150, 400));

            scheduleVoiceRecognitionRestart();

            return true;
        }


        function normaliseTranscript(text) {
            return text
                .toLowerCase()
                .replace(/[.,!?"׳״']/g, '')
                .trim();
        }

        function updateVoiceIndicator() {
            const indicator = document.getElementById('voiceIndicator');
            if (!indicator) return;

            if (!voiceRecognitionInitialized) {
                indicator.style.display = 'none';
                return;
            }

            indicator.style.display = 'inline-block';
            indicator.style.animation = 'none';

            if (!voiceControlEnabled) {
                indicator.innerHTML = '<span class="inline-icon" data-lucide="mic-off" aria-hidden="true"></span> <span>שליטה קולית כבויה - לחץ להפעלה</span>';
                indicator.style.background = 'rgba(255, 255, 255, 0.06)';
                indicator.style.borderColor = 'rgba(255, 255, 255, 0.10)';
                indicator.style.color = 'rgba(237, 239, 243, 0.68)';
                indicator.setAttribute('title', 'לחץ כדי להפעיל שליטה קולית');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } else if (isVoiceActive) {
                indicator.innerHTML = '<span class="inline-icon" data-lucide="mic" aria-hidden="true"></span> <span>מאזין לפקודות... (לחץ לכיבוי)</span>';
                indicator.style.background = 'rgba(47, 107, 255, 0.15)';
                indicator.style.borderColor = 'rgba(47, 107, 255, 0.4)';
                indicator.style.color = '#2F6BFF';
                indicator.style.animation = 'pulse 2s infinite';
                indicator.setAttribute('title', 'לחץ כדי לכבות את השליטה הקולית');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } else {
                indicator.innerHTML = '<span class="inline-icon" data-lucide="mic" aria-hidden="true"></span> <span>מפעיל שליטה קולית...</span>';
                indicator.style.background = 'rgba(47, 107, 255, 0.10)';
                indicator.style.borderColor = 'rgba(47, 107, 255, 0.25)';
                indicator.style.color = 'rgba(47, 107, 255, 0.8)';
                indicator.style.animation = 'pulse 2s infinite';
                indicator.setAttribute('title', 'מנסה להפעיל שליטה קולית');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function startVoiceRecognition() {
            if (!recognition) return;
            try {
                if (voiceRestartTimeout) {
                    clearTimeout(voiceRestartTimeout);
                    voiceRestartTimeout = null;
                }
                recognition.start();
            } catch (err) {
                if (err.name === 'InvalidStateError') {
                    console.log('[Voice] השליטה הקולית כבר פעילה');
                } else {
                    console.error('[Error] לא ניתן להפעיל שליטה קולית:', err);
                }
            }
        }

        function stopVoiceRecognition() {
            if (!recognition) return;
            try {
                recognition.stop();
            } catch (err) {
                console.error('[Error] לא ניתן לעצור שליטה קולית:', err);
            }
        }

        function toggleVoiceControl() {
            if (!voiceRecognitionInitialized) {
                console.log('[Voice] השליטה הקולית עדיין לא מוכנה');
                return;
            }

            voiceControlEnabled = !voiceControlEnabled;

            if (voiceControlEnabled) {
                console.log('[Voice] שליטה קולית הופעלה ידנית');
                startVoiceRecognition();
            } else {
                console.log('[Voice] שליטה קולית כובתה ידנית');
                stopVoiceRecognition();
                isVoiceActive = false;
            }

            updateVoiceIndicator();
        }

        function initVoiceRecognition() {
            // בדיקה אם הדפדפן תומך בזיהוי קולי
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('[!] הדפדפן לא תומך בזיהוי קולי');
                voiceRecognitionInitialized = false;
                updateVoiceIndicator();
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true; // האזנה רציפה
            recognition.interimResults = false;
            recognition.lang = 'he-IL'; // עברית כברירת מחדל
            recognition.maxAlternatives = 3;

            voiceRecognitionInitialized = true;
            updateVoiceIndicator();

            // מילון פקודות קוליות - כל הפקודות הזמינות במערכת
            voiceCommandDefinitions = [
                // שליטה בשירים
                { id: 'next-track', label: 'שיר הבא', feedback: '⏭️ מדלג לשיר הבא', phrases: ['next', 'הבא', 'שיר הבא', 'next song', 'הבא שיר', 'קדימה'], action: voiceNextTrack },
                { id: 'previous-track', label: 'שיר קודם', feedback: '⏮️ חוזר לשיר הקודם', phrases: ['previous', 'קודם', 'שיר קודם', 'previous song', 'חזור', 'אחורה'], action: voicePreviousTrack },
                
                // שליטה בניגון
                { id: 'play', label: 'נגן', feedback: '▶️ מפעיל נגן', phrases: ['play', 'נגן', 'תנגן', 'תפעיל', 'הפעל', 'המשך'], action: voicePlay },
                { id: 'pause', label: 'עצור', feedback: '⏸️ עוצר נגן', phrases: ['pause', 'stop', 'עצור', 'תעצור', 'עצירה', 'הפסק', 'השהה'], action: voicePause },
                
                // שליטה בעוצמה
                { id: 'mute', label: 'השתק', feedback: '🔇 משתיק', phrases: ['mute', 'השתק', 'שקט', 'השתק מוזיקה', 'בלי קול'], action: voiceToggleMute },
                { id: 'volume-up', label: 'הגבר עוצמה', feedback: '🔊 מגביר עוצמה', phrases: ['volume up', 'הגבר', 'יותר חזק', 'חזק יותר', 'להגביר', 'הגבר קול'], action: () => changeVolume(15) },
                { id: 'volume-down', label: 'הנמך עוצמה', feedback: '🔉 מנמיך עוצמה', phrases: ['volume down', 'הנמך', 'יותר חלש', 'חלש יותר', 'להנמיך', 'הנמך קול', 'נמוך'], action: () => changeVolume(-15) },
                
                // שליטה בפלייליסטים
                { id: 'next-playlist', label: 'פלייליסט הבא', feedback: '📁 עובר לפלייליסט הבא', phrases: ['next playlist', 'פלייליסט הבא', 'עבור פלייליסט', 'פלייליסט קדימה', 'רשימה הבאה'], action: voiceNextPlaylist },
                { id: 'previous-playlist', label: 'פלייליסט קודם', feedback: '📁 חוזר לפלייליסט הקודם', phrases: ['previous playlist', 'פלייליסט קודם', 'חזור פלייליסט', 'פלייליסט אחורה', 'רשימה קודמת'], action: voicePreviousPlaylist },
                
                // שליטה בערבוב
                { id: 'shuffle', label: 'ערבוב שירים', feedback: '🔀 מצב ערבוב שירים', phrases: ['shuffle', 'ערבוב', 'ערבב', 'תערבב', 'ערבוב שירים', 'מצב אקראי'], action: () => toggleSongShuffle() }
            ];

            recognition.onstart = () => {
                isVoiceActive = true;
                voiceControlEnabled = true;
                if (voiceRestartTimeout) {
                    clearTimeout(voiceRestartTimeout);
                    voiceRestartTimeout = null;
                }
                updateVoiceIndicator();
                console.log('[Voice] זיהוי קולי הופעל - מאזין...');
            };

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const transcriptRaw = event.results[last][0].transcript;
                const transcript = normaliseTranscript(transcriptRaw);
                
                console.log('[Voice] זוהה:', transcript);
                
                // חיפוש פקודה מתאימה
                let commandExecuted = false;
                for (const definition of voiceCommandDefinitions) {
                    if (definition.phrases.some(phrase => transcript.includes(phrase))) {
                        console.log(`[V] פקודה קולית מזוהה: ${definition.label}`);
                        commandExecuted = handleVoiceCommand(definition);
                        break;
                    }
                }

                if (!commandExecuted) {
                    console.log('[?] פקודה לא זוהתה:', transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('[Error] שגיאה בזיהוי קולי:', event.error);
                
                if (event.error === 'no-speech') {
                    console.log('[Voice] לא זוהה דיבור - ממשיך להאזין...');
                } else if (event.error === 'not-allowed') {
                    console.error('[Error] הרשאות מיקרופון נדחו');
                    voiceControlEnabled = false;
                    isVoiceActive = false;
                    updateVoiceIndicator();
                }
            };

            recognition.onend = () => {
                isVoiceActive = false;
                updateVoiceIndicator();

                if (voiceControlEnabled) {
                    console.log('[Voice] זיהוי קולי הסתיים - מתזמן הפעלה מחדש...');
                    scheduleVoiceRecognitionRestart();
                } else {
                    console.log('[Voice] שליטה קולית כבויה - לא מאתחל מחדש');
                }
            };

            // הפעל את הזיהוי הקולי
            updateVoiceIndicator();
        }

        // בקשת הרשאות מהמשתמש
        async function requestAllPermissions() {
            console.log('[Permissions] מבקש הרשאות מהמשתמש...');
            
            const permissions = [];
            
            // 0. הרשאות מיקרופון לזיהוי קולי
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                permissions.push('[V] מיקרופון (שליטה קולית)');
                stream.getTracks().forEach(track => track.stop()); // עצור את הזרם
                
                // הפעל זיהוי קולי
                setTimeout(() => {
                    initVoiceRecognition();
                }, 1000);
            } catch (e) {
                permissions.push('[X] מיקרופון (נדחה)');
                console.warn('לא ניתן לקבל הרשאות מיקרופון:', e);
                voiceRecognitionInitialized = false;
                voiceControlEnabled = false;
                isVoiceActive = false;
                updateVoiceIndicator();
            }
            
            // 1. הרשאות להתראות
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        permissions.push('[V] התראות');
                        // הצג התראת דוגמה
                        new Notification('נגן מוזיקה לרכב', {
                            body: 'האפליקציה תמשיך לנגן גם ברקע!',
                            icon: 'car-music-icon.png',
                            tag: 'welcome',
                            requireInteraction: false
                        });
                    } else {
                        permissions.push('[X] התראות (נדחה)');
                    }
                } catch (e) {
                    console.warn('לא ניתן לבקש הרשאות התראות:', e);
                }
            } else if (Notification.permission === 'granted') {
                permissions.push('[V] התראות (כבר ניתנו)');
            }

            // 3. בדיקת עדכונים בעת הרשאות
            checkForUpdates();

            // 2. Wake Lock - למניעת כיבוי מסך
            if ('wakeLock' in navigator) {
                try {
                    const wakeLock = await navigator.wakeLock.request('screen');
                    permissions.push('[V] מניעת כיבוי מסך');
                    console.log('[WakeLock] Wake Lock הופעל');
                } catch (e) {
                    permissions.push('[!] מניעת כיבוי מסך (ינסה שוב)');
                }
            }
            
            // 3. הצגת סיכום הרשאות
            if (permissions.length > 0) {
                console.log('[Permissions] הרשאות שהתקבלו:');
                permissions.forEach(p => console.log('  ' + p));
                
                // הצג הודעה יפה למשתמש
                const permissionList = permissions.map(p => `<div style="margin: 5px 0;">${p}</div>`).join('');
                
                const notification = document.createElement('div');
                notification.className = 'permission-notification';
                notification.innerHTML = `
                    <h3>נגן מוזיקה לרכב</h3>
                    <p><strong>הרשאות שהתקבלו:</strong></p>
                    <div class="permission-list">
                        ${permissionList}
                    </div>
                    <p style="font-size: 18px; font-weight: bold;">
                        האפליקציה תמשיך לנגן<br>גם כשתעבור לאפליקציות אחרות!
                    </p>
                    <button onclick="this.parentElement.remove()">הבנתי!</button>
                `;
                
                setTimeout(() => {
                    document.body.appendChild(notification);
                    
                    // הסר אוטומטית אחרי 8 שניות
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.animation = 'slideIn 0.5s ease reverse';
                            setTimeout(() => notification.remove(), 500);
                        }
                    }, 8000);
                }, 500);
            }
        }

        // בדיקת טעינת הדף ומצב הנגן
        window.addEventListener('load', function() {
            console.log('הדף נטען בהצלחה');
            
            // בקש הרשאות אחרי לחיצה ראשונה
            let permissionsRequested = false;
            document.addEventListener('click', async () => {
                if (!permissionsRequested) {
                    permissionsRequested = true;
                    await requestAllPermissions();
                }
            }, { once: true });
            
            // עדכון כפתורי ניווט פלייליסטים
            updatePlaylistNavigation();
            
            // בדיקה שכל האלמנטים מוצגים
            setTimeout(function() {
                // וידוא שכל האלמנטים מוצגים בצורה תקינה
                document.getElementById('currentSongContainer').style.display = 'block';
                document.getElementById('volumeControl').style.display = 'flex';
                document.querySelectorAll('.control-buttons').forEach(el => el.style.display = 'flex');
                document.getElementById('playlistName').style.display = 'block';
                
                // מנגנון בדיקה ותיקון אם הנגן לא נטען כראוי
                if (!player || (player && typeof player.getPlayerState !== 'function')) {
                    console.log('נגן YouTube לא נטען כראוי, מנסה לטעון מחדש...');
                    // ניסיון לטעון מחדש את הנגן בצורה ישירה ופשוטה
                    document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                        playlists[currentPlaylistIndex].id + 
                        '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                }
            }, 1000); // בדיקה לאחר שנייה אחת
        });

        // Error Handling גלובלי
        window.addEventListener('error', function(event) {
            console.error('[Error] שגיאה גלובלית:', event.error);
            // אל תציג שגיאות למשתמש - רק לוג לקונסול
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('[Error] Promise נדחה:', event.reason);
            event.preventDefault();
        });

        // בדיקת חיבור לאינטרנט
        window.addEventListener('online', () => {
            console.log('[Online] חיבור לאינטרנט חזר');
        });

        window.addEventListener('offline', () => {
            console.log('[Offline] אין חיבור לאינטרנט');
            const currentSong = document.getElementById('currentSong');
            if (currentSong) {
                currentSong.textContent = 'אין חיבור לאינטרנט - מנסה להתחבר מחדש...';
            }
        });
    </script>

    <!-- Initialize Lucide icons -->
    <script>
        // Ensure icons are rendered after page load
        if (window.lucide) {
            lucide.createIcons();
        }
        window.addEventListener('load', function() {
            if (window.lucide) {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































