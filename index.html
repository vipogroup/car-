
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¶ × ×’×Ÿ ×©×™×¨×™× ×œ×¨×›×‘ ğŸš—</title>
    <!-- ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- ×”×’×“×¨×•×ª PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1db954">
    <link rel="apple-touch-icon" href="car-music-icon.png">
    <link rel="icon" type="image/png" href="car-music-icon.png">
    <!-- ××¤×©×¨ × ×™×’×•×Ÿ ×‘×¨×§×¢ -->
    <meta name="mobile-web-app-background-audio" content="yes">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #222;
            color: white;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            font-size: 16px;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            box-sizing: border-box;
        }

        .music-player {
            width: 100%;
            max-width: 500px;
            background: #333;
            padding: 10px;
            border-radius: 15px;
            border: 2px solid #1db954;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 100vh;
            overflow: visible;
            position: relative;
            z-index: 1;
            gap: 10px;
        }

        .video-frame {
            width: 100%;
            height: 25vh;
            min-height: 180px;
            max-height: 200px;
            border-radius: 10px;
            border: 2px solid #1db954;
            overflow: hidden;
            background-color: #000;
            margin-bottom: 5px;
            position: relative; /* × ×“×¨×© ×¢×‘×•×¨ ×”-overlay */
        }
        
        .video-frame iframe {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        
        /* ×©×›×‘×ª ×–×›×•×›×™×ª ×©×§×•×¤×” ××¢×œ ×”-iframe - ×—×•×¡××ª ×œ×—×™×¦×•×ª */
        .video-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 10;
            cursor: default;
            pointer-events: auto; /* ×—×•×¡× ××ª ×›×œ ×”××™× ×˜×¨××§×¦×™×•×ª */
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
        }

        .control-row,
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            width: 100%;
        }

        .control-btn {
            background: #1db954;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.35);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            letter-spacing: 0.2px;
            width: 44px;
            height: 44px;
            font-size: 22px;
            padding: 0;
        }

        .control-btn.icon-btn,
        .control-btn.pill-btn {
            width: 44px;
            height: 44px;
            font-size: 22px;
        }

        .control-btn:hover {
            background: #17a450;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        .update-check-btn {
            margin: 8px auto 0;
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .update-check-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .update-check-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .day-mode .update-check-btn {
            background: linear-gradient(135deg, #6a5acd, #20b2aa);
            color: #fff;
        }

        .microphone-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.78);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .microphone-modal {
            background: linear-gradient(145deg, #1e1e1e, #2c2c2c);
            border-radius: 18px;
            border: 2px solid rgba(29, 185, 84, 0.35);
            max-width: 420px;
            width: 100%;
            padding: 25px;
            color: #fff;
            position: relative;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
            text-align: right;
        }

        .microphone-modal h2 {
            margin: 0 0 15px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .microphone-modal p {
            font-size: 15px;
            line-height: 1.6;
            margin: 0 0 15px;
        }

        .microphone-modal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
            margin-bottom: 12px;
        }

        .microphone-modal-primary,
        .microphone-modal-secondary {
            border: none;
            border-radius: 14px;
            padding: 10px 16px;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .microphone-modal-primary {
            background: linear-gradient(135deg, #1db954, #0b7d3b);
            color: #fff;
            box-shadow: 0 6px 18px rgba(29, 185, 84, 0.35);
        }

        .microphone-modal-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(29, 185, 84, 0.45);
        }

        .microphone-modal-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f1f1;
            border: 1px solid rgba(255, 255, 255, 0.25);
        }

        .microphone-modal-secondary:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.18);
        }

        .microphone-modal-close {
            position: absolute;
            top: 12px;
            left: 12px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
        }

        .microphone-settings-guide {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 15px;
            font-size: 14px;
            line-height: 1.7;
        }

        .microphone-settings-guide h3 {
            margin-top: 0;
            font-size: 16px;
            color: #1db954;
        }

        .microphone-settings-guide ul {
            margin: 0 0 10px 0;
            padding-right: 18px;
        }

        .microphone-settings-guide li {
            margin-bottom: 6px;
        }

        .microphone-retry-status {
            font-size: 14px;
            margin-top: 8px;
            min-height: 20px;
        }

        @media (max-width: 480px) {
            .microphone-modal {
                padding: 20px 18px;
            }

            .microphone-modal h2 {
                font-size: 20px;
            }

            .microphone-modal-primary,
            .microphone-modal-secondary {
                flex: 1;
                text-align: center;
            }
        }

        .shuffle-btn.active {
            background: #0b6838 !important;
            box-shadow: 0 0 12px #0b6838;
        }

        .playlist-name {
            margin: 5px 0;
            font-size: 1.2em;
            color: #1db954;
            font-weight: bold;
            padding: 5px;
            display: block !important;
            visibility: visible !important;
            width: 100%;
        }

        .back-btn {
            background: #ff3333;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: none;
            color: white;
        }

        .back-btn:hover {
            background: #cc0000;
        }

        /* ××¤×§×˜ ×”×‘×”×•×‘ ×œ×›×¤×ª×•×¨ ×©× ×œ×—×¥ */
        @keyframes flashEffect {
            0% { background-color: #1db954; }
            50% { background-color: #004080; }
            100% { background-color: #1db954; }
        }

        .active-effect {
            animation: flashEffect 0.3s ease-in-out;
        }
        
        /* ×‘×¢×™×™×ª ×ª×¦×•×’×” - ×ª×™×§×•×Ÿ ××œ×× ×˜×™× ×©×œ× ××•×¦×’×™× */
        .playlist-name, .current-song-container, .volume-control {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            margin: 10px 0 !important;
        }
        
        /* ×¡×’× ×•×Ÿ ×ª×¦×•×’×ª ×©×™×¨ × ×•×›×—×™ */
        .current-song-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 10px;
            margin: 5px 0;
            border-right: 2px solid #1db954;
            width: 100%;
            text-align: right;
            display: block !important;
            visibility: visible !important;
        }
        
        .day-mode .current-song-container {
            background: rgba(0, 0, 0, 0.1);
            border-left: 3px solid #4169E1;
        }
        
        .current-song-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        .current-song {
            font-weight: bold;
            font-size: 1em;
            color: #1db954;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        /* ×¡×’× ×•×Ÿ ×‘×§×¨ ×¢×•×¦××ª ×©××¢ */
        .volume-control {
            width: 100%;
            display: flex !important;
            align-items: center;
            gap: 5px;
            margin: 5px 0;
            justify-content: center;
            visibility: visible !important;
        }
        
        .volume-slider {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 5px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #1db954;
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #1db954;
            cursor: pointer;
            border: none;
        }
        
        .day-mode .volume-slider::-webkit-slider-thumb {
            background: #4169E1;
        }
        
        .day-mode .volume-slider::-moz-range-thumb {
            background: #4169E1;
        }
        
        .volume-icon {
            font-size: 24px;
            cursor: pointer;
        }
        
        /* ×¡×’× ×•×Ÿ ×§×™×©×•×¨ ×”×ª×§× ×” ×œ××¡×š ×”×‘×™×ª */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(29, 185, 84, 0.9);
            color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.5s;
            direction: rtl;
            text-align: center;
        }
        
        .day-mode .install-prompt {
            background: rgba(65, 105, 225, 0.9);
        }
        
        .install-prompt button {
            background: white;
            color: #1db954;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .day-mode .install-prompt button {
            color: #4169E1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .day-mode .current-song {
            color: #4169E1;
        }

        /* ×ª×¤×¨×™×˜ ×”×’×“×¨×•×ª */
        .settings-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 1100;
        }

        .settings-toggle {
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 10px 16px;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .settings-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            background: rgba(0, 0, 0, 0.75);
        }

        .settings-dropdown {
            display: none;
            flex-direction: column;
            gap: 8px;
            background: rgba(34, 34, 34, 0.95);
            border-radius: 14px;
            padding: 14px 16px;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.45);
            min-width: 200px;
            direction: rtl;
        }

        .settings-dropdown.open {
            display: flex;
        }

        .settings-dropdown button {
            background: linear-gradient(135deg, #1db954, #0b7d3b);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 15px;
            font-weight: 600;
            text-align: right;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .settings-dropdown button span:first-child {
            font-size: 18px;
        }

        .settings-dropdown button:hover {
            transform: translateX(-3px);
            box-shadow: 0 8px 18px rgba(29, 185, 84, 0.4);
        }

        .day-mode .settings-toggle {
            background: rgba(255, 255, 255, 0.85);
            color: #1f3b8a;
            box-shadow: 0 4px 14px rgba(65, 105, 225, 0.35);
        }

        .day-mode .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .day-mode .settings-dropdown {
            background: rgba(255, 255, 255, 0.97);
            box-shadow: 0 14px 28px rgba(65, 105, 225, 0.35);
        }

        .day-mode .settings-dropdown button {
            background: linear-gradient(135deg, #5a6ff7, #4dd2ff);
            color: #0f1b3d;
        }

        .day-mode .settings-dropdown button:hover {
            box-shadow: 0 8px 18px rgba(90, 111, 247, 0.35);
        }

        /* ×¡×’× ×•×Ÿ ×œ××¦×‘ ×™×•× */
        .day-mode {
            background: linear-gradient(135deg, #89CFF0, #6495ED, #4169E1) !important;
        }

        .day-mode .music-player {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 0 20px #4169E1;
        }

        .day-mode .control-btn {
            background: #4169E1;
        }

        .day-mode .control-btn:hover {
            background: #1E90FF;
        }

        .day-mode .playlist-name {
            color: #4169E1;
        }

        .day-mode .back-btn {
            background: #FF6347;
        }

        .day-mode .back-btn:hover {
            background: #FF4500;
        }

        /* ×”×ª×××” ×œ××¡×›×™× ×§×˜× ×™× */
        /* ×”×ª×××” ×œ××¡×›×™× ×©×•× ×™× */
        @media (max-height: 700px) {
            .music-player {
                transform: scale(0.9);
                margin-top: -20px;
            }
            .video-frame {
                height: 25vh;
            }
        }

        @media (max-width: 768px) {
            .control-btn.icon-btn,
            .control-btn.pill-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .settings-menu {
                top: 12px;
                right: 12px;
            }

            .settings-dropdown {
                min-width: 170px;
            }
        }
        
        /* ×”×ª×××” ×œ××—×©×‘ ×©×•×œ×—× ×™ */
        @media (min-width: 1024px) {
            .music-player {
                max-width: 900px;
            }
            
            .control-buttons {
                margin: 10px auto;
            }
            
            /* ××¤×§×˜×™× ×œ××¢×‘×¨ ×¢×›×‘×¨ ×¢×œ ×›×¤×ª×•×¨×™× */
            .control-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            }
        }

        /* ×›×¤×ª×•×¨ ×¡×’×™×¨×” ×œ×—×œ×•×Ÿ ×”×ª×§× ×” */
        .close-prompt {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-prompt:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .close-prompt:active {
            transform: scale(0.95);
        }

        /* ×”×•×“×¢×ª ×”×¨×©××•×ª */
        .permission-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            max-width: 90%;
            width: 400px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .permission-notification h3 {
            margin: 0 0 15px 0;
            font-size: 24px;
        }

        .permission-notification p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .permission-notification .permission-list {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: right;
        }

        .permission-notification button {
            background: white;
            color: #1db954;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .permission-notification button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* ×‘×× ×¨ ×¢×“×›×•×Ÿ */
        #updateBanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 10001;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        #updateBanner button {
            background: white;
            color: #3498db;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #updateBanner button:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        #updateBanner .dismiss-btn {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        /* ×× ×™××¦×™×” ×œ××™× ×“×™×§×˜×•×¨ ×§×•×œ×™ */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

    </style>
</head>
<body>
    <!-- ×‘×× ×¨ ×¢×“×›×•×Ÿ -->
    <div id="updateBanner" style="display: none;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">
            ğŸ”„ ×¢×“×›×•×Ÿ ×—×“×© ×–××™×Ÿ!
        </div>
        <div style="font-size: 14px; margin-bottom: 10px;">
            ×’×¨×¡×” ×—×“×©×” ×¢× ×©×™×¤×•×¨×™× ×•×ª×›×•× ×•×ª × ×•×¡×¤×•×ª ××—×›×” ×œ×š
        </div>
        <div class="version-info" style="font-size: 13px; margin-bottom: 10px; opacity: 0.9;">
            ×’×¨×¡×” ×¢×“×›× ×™×ª
        </div>
        <button onclick="updateApp()" style="background: #27ae60; color: white;">
            âœ… ×¢×“×›×Ÿ ×¢×›×©×™×•
        </button>
        <button onclick="dismissUpdate()" class="dismiss-btn">
            â° ××—×¨ ×›×š
        </button>
    </div>

    <!-- ×ª×¤×¨×™×˜ ×”×’×“×¨×•×ª ××¢×¨×›×ª -->
    <div class="settings-menu">
        <button class="settings-toggle" id="settingsToggleBtn" onclick="toggleSettingsMenu(event)" aria-label="×”×’×“×¨×•×ª ××¢×¨×›×ª" aria-expanded="false">
            â˜°
        </button>
        <div class="settings-dropdown" id="settingsDropdown" role="menu" aria-hidden="true">
            <button id="dayNightSettingBtn" role="menuitem" onclick="handleDayNightToggle(this)">
                <span id="dayNightSettingIcon">ğŸŒ™</span>
                <span id="dayNightSettingLabel">×”×¤×¢×œ ××¦×‘ ×™×•×</span>
            </button>
            <button role="menuitem" onclick="handleUpdateCheck(this)">
                <span>ğŸ”„</span>
                <span>×‘×“×•×§ ×¢×“×›×•×Ÿ ×¢×›×©×™×•</span>
            </button>
            <button role="menuitem" onclick="handleGoBack(this)">
                <span>ğŸ”™</span>
                <span>×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</span>
            </button>
        </div>
    </div>

    <!-- Audio × ×¡×ª×¨ ×œ× ×™×’×•×Ÿ ×‘×¨×§×¢ -->
    <audio id="backgroundAudio" style="display: none;" preload="auto"></audio>

    <div class="music-player" id="musicPlayer">
        <h2 style="font-size: 22px; margin: 5px 0;">ğŸ¶ × ×’×Ÿ ××•×–×™×§×” ×œ×¨×›×‘ ğŸš—</h2>
        <div id="player" class="video-frame" title="× ×’×Ÿ YouTube - ×œ×—×™×¦×•×ª ×—×¡×•××•×ª"></div>

        <div class="control-panel">
            <div class="control-buttons top-controls">
                <button class="control-btn icon-btn" title="×©×™×¨ ×§×•×“×" aria-label="×©×™×¨ ×§×•×“×" onclick="buttonClickEffect(this); previousTrack()">â®</button>
                <button class="control-btn icon-btn" id="playPauseBtn" title="×¢×¦×•×¨" aria-label="×¢×¦×•×¨" onclick="buttonClickEffect(this); togglePlayPause(this)">â¸</button>
                <button class="control-btn icon-btn" title="×©×™×¨ ×”×‘×" aria-label="×©×™×¨ ×”×‘×" onclick="buttonClickEffect(this); nextTrack()">â­</button>
                <button class="control-btn icon-btn shuffle-btn" id="songShuffleBtn" title="×¢×¨×‘×•×‘ ×©×™×¨×™×" aria-label="×¢×¨×‘×•×‘ ×©×™×¨×™×" onclick="buttonClickEffect(this); toggleSongShuffle()">ğŸ”€</button>
                <button class="control-btn icon-btn shuffle-btn" id="playlistShuffleBtn" title="×¢×¨×‘×•×‘ ×¤×œ×™×™×œ×™×¡×˜×™×" aria-label="×¢×¨×‘×•×‘ ×¤×œ×™×™×œ×™×¡×˜×™×" onclick="buttonClickEffect(this); togglePlaylistShuffle()">ğŸ”</button>
            </div>

            <div class="control-buttons playlist-controls">
                <button class="control-btn pill-btn" id="prevPlaylistBtn" style="display: none;"
                    title="×¤×œ×™×™×œ×™×¡×˜ ×§×•×“×" aria-label="×¤×œ×™×™×œ×™×¡×˜ ×§×•×“×"
                    onclick="buttonClickEffect(this); previousPlaylist()">âª</button>
                <button class="control-btn pill-btn"
                    title="× ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™×" aria-label="× ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™×"
                    onclick="buttonClickEffect(this); openPlaylistManager()">ğŸ“œ</button>
                <button class="control-btn pill-btn" id="nextPlaylistBtn" style="display: none;"
                    title="×¤×œ×™×™×œ×™×¡×˜ ×”×‘×" aria-label="×¤×œ×™×™×œ×™×¡×˜ ×”×‘×"
                    onclick="buttonClickEffect(this); nextPlaylist()">â©</button>
            </div>
        </div>

        <div class="playlist-name" id="playlistName">ğŸµ ×¤×œ×™×™×œ×™×¡×˜ ×¨××©×™ - × ×”×™×’×” ×‘×›×™×£ ğŸš—</div>

        <!-- ××™× ×“×™×§×˜×•×¨ ×©×œ×™×˜×” ×§×•×œ×™×ª -->
        <div id="voiceIndicator" style="display: none; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 8px 15px; border-radius: 20px; margin: 10px auto; text-align: center; font-size: 14px; font-weight: bold; animation: pulse 1.5s infinite; cursor: pointer; user-select: none;"
            onclick="toggleVoiceControl()">
            ğŸ¤ ×××–×™×Ÿ ×œ×¤×§×•×“×•×ª ×§×•×œ×™×•×ª...
        </div>
        <div id="voiceCommand" style="display: none; background: #27ae60; color: white; padding: 8px 15px; border-radius: 20px; margin: 10px auto; text-align: center; font-size: 14px; font-weight: bold;">
            âœ… ×¤×§×•×“×” ×–×•×”×ª×”
        </div>
        
        <!-- ×ª×¦×•×’×ª ×©×™×¨ × ×•×›×—×™ -->
        <div class="current-song-container" id="currentSongContainer">
            <div class="current-song-label">×©×™×¨ × ×•×›×—×™:</div>
            <div class="current-song" id="currentSong">×˜×•×¢×Ÿ...</div>
        </div>
        
        <!-- ×‘×§×¨ ×¢×•×¦××ª ×©××¢ -->
        <div class="volume-control" id="volumeControl">
            <span class="volume-icon" onclick="toggleMute()" id="volumeIcon">ğŸ”Š</span>
            <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
        </div>

        <!-- ×”×•×¡×¨×• ×§×™×¦×•×¨×™ ××§×œ×“×ª ×›×“×™ ×œ×—×¡×•×š ××§×•× ×‘××¡×š -->
    </div>

    <!-- ××•×“××œ ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ -->
    <div id="microphoneHelpModal" class="microphone-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="microphoneHelpTitle">
        <div class="microphone-modal">
            <button class="microphone-modal-close" aria-label="×¡×’×•×¨" onclick="closeMicrophoneHelp()">âœ–</button>
            <h2 id="microphoneHelpTitle">ğŸ¤ × ×“×¨×©×ª ×”×¨×©××ª ××™×§×¨×•×¤×•×Ÿ</h2>
            <p>
                ×›×“×™ ×œ×”×©×ª××© ×‘×©×œ×™×˜×” ×”×§×•×œ×™×ª, ×¢×œ×™×š ×œ××¤×©×¨ ×’×™×©×” ×œ××™×§×¨×•×¤×•×Ÿ. ×‘×—×¨ ×‘××—×ª ×”××¤×©×¨×•×™×•×ª:
            </p>
            <div class="microphone-modal-actions">
                <button class="microphone-modal-primary" onclick="retryMicrophonePermission()">ğŸ” × ×¡×” ×©×•×‘ ×¢×›×©×™×•</button>
                <button class="microphone-modal-secondary" onclick="openMicrophoneSettingsGuide()">ğŸ“˜ ×”×•×¨××•×ª ×¤×ª×™×—×” ×‘×”×’×“×¨×•×ª</button>
            </div>
            <div class="microphone-retry-status" id="microphoneRetryStatus"></div>
            <div class="microphone-settings-guide" id="microphoneSettingsGuide" style="display: none;">
                <h3>ğŸ“± ××™×š ×œ×¤×ª×•×— ×”×¨×©××” ×™×“× ×™×ª?</h3>
                <ul>
                    <li><strong>Chrome / Android:</strong> ×”×§×© ×¢×œ ×¡××œ ×”×× ×¢×•×œ â–¶ï¸ Permissions â–¶ï¸ Microphone â–¶ï¸ Allow.</li>
                    <li><strong>Safari / iPhone:</strong> ×”×’×“×¨×•×ª â–¶ï¸ Safari â–¶ï¸ ××¦×œ××” ×•××™×§×¨×•×¤×•×Ÿ â–¶ï¸ ××¤×©×¨.</li>
                    <li>×œ××—×¨ ×”×¢×“×›×•×Ÿ ×¨×¢× ×Ÿ ××ª ×”××¤×œ×™×§×¦×™×” ×•×—×–×•×¨ ×œ×›××Ÿ.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ××•×“××œ × ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™× -->
    <div id="playlistModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 500px; margin: 20px auto; background: #333; padding: 20px; border-radius: 15px; border: 2px solid #1db954;">
            <h2 style="color: #1db954; text-align: center;">âš™ï¸ × ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™×</h2>
            
            <!-- ×˜×•×¤×¡ ×”×•×¡×¤×ª ×¤×œ×™×™×œ×™×¡×˜ -->
            <div style="background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: white; margin-top: 0;">â• ×”×•×¡×£ ×¤×œ×™×™×œ×™×¡×˜ ×—×“×©</h3>
                <input type="text" id="newPlaylistName" placeholder="×©× ×”×¤×œ×™×™×œ×™×¡×˜ (×œ×“×•×’××”: ××•×–×™×§×” ×œ× ×¡×™×¢×”)" 
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #1db954; background: #444; color: white; font-size: 16px; box-sizing: border-box;">
                <input type="text" id="newPlaylistId" placeholder="YouTube Playlist ID (×œ×“×•×’××”: PLWkfrFkdyL1Fdaso2jWg1gevOxRe2jKvG)" 
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #1db954; background: #444; color: white; font-size: 16px; box-sizing: border-box;">
                <button onclick="addNewPlaylist()" style="width: 100%; padding: 12px; background: #1db954; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold;">
                    â• ×”×•×¡×£ ×¤×œ×™×™×œ×™×¡×˜
                </button>
                <div style="margin-top: 10px; font-size: 12px; color: #aaa; text-align: right;">
                    ğŸ’¡ ××™×š ×œ××¦×•× Playlist ID: ×¤×ª×— ×¤×œ×™×™×œ×™×¡×˜ ×‘-YouTube, ×”×¢×ª×§ ××ª ×”×§×•×“ ××—×¨×™ "list=" ×‘×›×ª×•×‘×ª
                </div>
            </div>
            
            <!-- ×¨×©×™××ª ×¤×œ×™×™×œ×™×¡×˜×™× ×§×™×™××™× -->
            <div style="background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: white; margin-top: 0;">ğŸ“‹ ×¤×œ×™×™×œ×™×¡×˜×™× ×§×™×™××™×</h3>
                <div id="playlistList"></div>
            </div>
            
            <button onclick="closePlaylistManager()" style="width: 100%; padding: 12px; background: #666; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold;">
                âœ–ï¸ ×¡×’×•×¨
            </button>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // ×’×¨×¡×ª ×”××¤×œ×™×§×¦×™×”
        const APP_VERSION = "2.2.0";
        console.log(`ğŸµ × ×’×Ÿ ××•×–×™×§×” ×œ×¨×›×‘ - ×’×¨×¡×” ${APP_VERSION}`);

        // ××©×ª× ×™ ××¢×¨×›×ª ×¢×“×›×•× ×™×
        let newServiceWorker = null;
        let updateAvailable = false;
        const AUTO_REFRESH_ON_UPDATE = true; // ××™×œ×•×¥ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×œ××—×¨ ×¢×“×›×•×Ÿ
        let updatePending = false;
        let refreshing = false;
        let updateListenerAttached = false;

        let player;
        let currentPlaylistIndex = 0;
        let isShuffle = false; // legacy flag (kept for compatibility)
        let songShuffleEnabled = localStorage.getItem('songShuffleEnabled') === 'true';
        let playlistShuffleEnabled = localStorage.getItem('playlistShuffleEnabled') === 'true';
        let songShuffleQueue = [];
        let songShuffleHistory = [];
        let playlistShuffleQueue = [];
        let playlistShuffleHistory = [];
        let userRequestedStop = false; // × ×™×’×Ÿ ×™×¤×¡×™×§ ×¨×§ ×× ×”××©×ª××© ×‘×™×§×© ×–××ª ××¤×•×¨×©×•×ª
        let isDayMode = false; // ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ: ××¦×‘ ×œ×™×œ×”
        let lastVolume = 100; // × ×•×¡×™×£ ××©×ª× ×” ×œ×©××™×¨×ª ×¢×•×¦××ª ×”×§×•×œ ×”××—×¨×•× ×”
        let deferredPrompt; // ×œ×©××™×¨×ª ×”××™×¨×•×¢ ×©×œ ×”×ª×§× ×ª PWA
        let hasUserInteracted = false; // ×× ×™×¢×ª autoplay â€“ × × ×’×Ÿ ×¨×§ ×œ××—×¨ ×œ×—×™×¦×”
        let adDetectionInterval = null; // ××–×”×” ×–×™×”×•×™ ×¤×¨×¡×•××•×ª
        let isAdPlaying = false; // ×”×× ××ª× ×’× ×ª ×¤×¨×¡×•××ª ×›×¨×’×¢
        let lastKnownDuration = 0; // ××©×š ×”×¡×¨×˜×•×Ÿ ×”××—×¨×•×Ÿ ×©× ×©××¨
        let lastVideoUrl = ''; // URL ×”×¡×¨×˜×•×Ÿ ×”××—×¨×•×Ÿ
        let consecutiveAdChecks = 0; // ××¡×¤×¨ ×‘×“×™×§×•×ª ×¨×¦×™×¤×•×ª ×©×–×™×”×• ×¤×¨×¡×•××ª

        // ×˜×¢×™× ×ª ×¤×œ×™×™×œ×™×¡×˜×™× ×-LocalStorage ××• ×‘×¨×™×¨×ª ××—×“×œ
        const defaultPlaylists = [
            { name: "ğŸµ ×¤×œ×™×™×œ×™×¡×˜ ×¨××©×™ - × ×”×™×’×” ×‘×›×™×£ ğŸš—", id: "PLWkfrFkdyL1Fdaso2jWg1gevOxRe2jKvG" },
            { name: "ğŸ¸ ×¨×•×§ ×™×©×¨××œ×™ ğŸ‡®ğŸ‡±", id: "PLn-Gsrq4vA2s8v3yOixMDxL-cXrmSuxDC" },
            { name: "ğŸ¤ ××–×¨×—×™×ª ××•×©×œ××ª ğŸ’ƒ", id: "PLUFHSF7zKGMutOiQfwU3K2LytQBY8a_hw" }
        ];
        
        // ×”×¢×¨×”: ×™×© ×œ×”×—×œ×™×£ ××ª ×”-Playlist IDs ×œ××¢×œ×” ×‘-IDs ×××™×ª×™×™× ×-YouTube
        // ×›×“×™ ×œ××¦×•× Playlist ID: ×¤×ª×— ×¤×œ×™×™×œ×™×¡×˜ ×‘-YouTube ×•×”×¢×ª×§ ××ª ×”×§×•×“ ××—×¨×™ "list=" ×‘×›×ª×•×‘×ª
        
        let playlists = JSON.parse(localStorage.getItem('musicPlaylists')) || defaultPlaylists;
        
        // ×× ×™×© ×¨×§ ×¤×œ×™×™×œ×™×¡×˜ ××—×“, ×”×—×–×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ
        if (playlists.length === 1) {
            console.log('âš ï¸ × ××¦× ×¨×§ ×¤×œ×™×™×œ×™×¡×˜ ××—×“ - ××—×–×™×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ');
            playlists = defaultPlaylists;
            localStorage.setItem('musicPlaylists', JSON.stringify(playlists));
        }
        
        console.log(`ğŸµ × ×˜×¢× ×• ${playlists.length} ×¤×œ×™×™×œ×™×¡×˜×™×:`, playlists.map(p => p.name));

        // ×©××™×¨×ª ×¤×œ×™×™×œ×™×¡×˜×™× ×‘-LocalStorage
        function savePlaylists() {
            localStorage.setItem('musicPlaylists', JSON.stringify(playlists));
            updatePlaylistNavigation();
        }

        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×¤×œ×™×™×œ×™×¡×˜×™×
        function updatePlaylistNavigation() {
            const prevBtn = document.getElementById('prevPlaylistBtn');
            const nextBtn = document.getElementById('nextPlaylistBtn');
            
            console.log(`ğŸ“‹ ××¡×¤×¨ ×¤×œ×™×™×œ×™×¡×˜×™×: ${playlists.length}`);
            console.log('ğŸ“‹ ×¨×©×™××ª ×¤×œ×™×™×œ×™×¡×˜×™×:', playlists.map(p => p.name).join(', '));
            
            if (playlists.length > 1) {
                if (prevBtn) prevBtn.style.display = 'inline-block';
                if (nextBtn) nextBtn.style.display = 'inline-block';
                console.log('âœ… ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ××•×¦×’×™×');
            } else {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                console.log('âš ï¸ ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ××•×¡×ª×¨×™× - ×™×© ×¨×§ ×¤×œ×™×™×œ×™×¡×˜ ××—×“');
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×¢×¨×‘×•×‘
        function updateShuffleButtons() {
            const songBtn = document.getElementById('songShuffleBtn');
            if (songBtn) {
                songBtn.classList.toggle('active', songShuffleEnabled);
                const songTitle = songShuffleEnabled ? '×¢×¨×‘×•×‘ ×©×™×¨×™× ×¤×¢×™×œ' : '×¢×¨×‘×•×‘ ×©×™×¨×™×';
                songBtn.title = songTitle;
                songBtn.setAttribute('aria-label', songTitle);
            }

            const playlistBtn = document.getElementById('playlistShuffleBtn');
            if (playlistBtn) {
                playlistBtn.classList.toggle('active', playlistShuffleEnabled);
                const playlistTitle = playlistShuffleEnabled ? '×¢×¨×‘×•×‘ ×¤×œ×™×™×œ×™×¡×˜×™× ×¤×¢×™×œ' : '×¢×¨×‘×•×‘ ×¤×œ×™×™×œ×™×¡×˜×™×';
                playlistBtn.title = playlistTitle;
                playlistBtn.setAttribute('aria-label', playlistTitle);
            }
        }

        function getCurrentVideoIdSafe() {
            try {
                if (player && typeof player.getVideoData === 'function') {
                    const data = player.getVideoData();
                    return data && data.video_id ? data.video_id : null;
                }
            } catch (err) {
                console.warn('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××–×”×” ×•×™×“××• × ×•×›×—×™:', err);
            }
            return null;
        }

        function updatePlayPauseButton(isPlaying) {
            const btn = document.getElementById('playPauseBtn');
            if (!btn) return;

            if (isPlaying) {
                btn.textContent = 'â¸';
                btn.title = '×¢×¦×•×¨';
                btn.setAttribute('aria-label', '×¢×¦×•×¨');
            } else {
                btn.textContent = 'â–¶';
                btn.title = '× ×’×Ÿ';
                btn.setAttribute('aria-label', '× ×’×Ÿ');
            }
        }

        function toggleMicrophoneHelp(show) {
            const modal = document.getElementById('microphoneHelpModal');
            if (!modal) return;
            modal.style.display = show ? 'flex' : 'none';
        }

        function openMicrophoneSettingsGuide() {
            const guide = document.getElementById('microphoneSettingsGuide');
            const status = document.getElementById('microphoneRetryStatus');
            if (guide) {
                guide.style.display = 'block';
            }
            if (status) {
                status.textContent = '×¤×ª×— ××ª ×”×”×’×“×¨×•×ª ×œ×¤×™ ×”×”× ×—×™×•×ª ×•×œ××—×¨ ××›×Ÿ ×¨×¢× ×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”.';
            }
        }

        function closeMicrophoneHelp() {
            toggleMicrophoneHelp(false);
            const status = document.getElementById('microphoneRetryStatus');
            const guide = document.getElementById('microphoneSettingsGuide');
            if (status) {
                status.textContent = '';
            }
            if (guide) {
                guide.style.display = 'none';
            }
        }

        async function retryMicrophonePermission() {
            const status = document.getElementById('microphoneRetryStatus');
            if (status) {
                status.textContent = '××‘×§×© ×”×¨×©××”...';
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                if (status) {
                    status.textContent = 'âœ… ×”×”×¨×©××” × ×™×ª× ×”! ×”×©×œ×™×˜×” ×”×§×•×œ×™×ª ×”×•×¤×¢×œ×”.';
                }
                closeMicrophoneHelp();
                setTimeout(() => {
                    initVoiceRecognition();
                    voiceControlEnabled = true;
                    updateVoiceIndicator();
                }, 500);
            } catch (error) {
                if (status) {
                    status.textContent = 'âŒ ×¢×“×™×™×Ÿ ×—×¡×•××”. × × ×œ×¤×ª×•×— ×™×“× ×™×ª ×“×¨×š ×”×”×’×“×¨×•×ª.';
                }
                openMicrophoneSettingsGuide();
            }
        }

        function shuffleArray(array) {
            const arr = array.slice();
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function buildSongShuffleQueue() {
            if (!songShuffleEnabled || !player || typeof player.getPlaylist !== 'function') {
                return;
            }

            const playlist = player.getPlaylist();
            if (!playlist || playlist.length <= 1) {
                songShuffleQueue = [];
                return;
            }

            const currentIndex = typeof player.getPlaylistIndex === 'function' ? player.getPlaylistIndex() : -1;
            const indices = playlist.map((_, index) => index);
            const available = currentIndex >= 0 ? indices.filter(index => index !== currentIndex) : indices;
            songShuffleQueue = shuffleArray(available);
            console.log('ğŸ”€ × ×‘× ×ª×” ×¨×©×™××ª ×¢×¨×‘×•×‘ ×œ×©×™×¨×™×:', songShuffleQueue);
        }

        function ensureSongShuffleQueue() {
            if (!songShuffleEnabled) return;
            if (songShuffleQueue.length === 0) {
                buildSongShuffleQueue();
            }
        }

        function playNextShuffledSong() {
            if (!songShuffleEnabled || !player) {
                return false;
            }

            ensureSongShuffleQueue();
            if (songShuffleQueue.length === 0) {
                return false;
            }

            const currentIndex = typeof player.getPlaylistIndex === 'function' ? player.getPlaylistIndex() : -1;
            if (currentIndex >= 0) {
                songShuffleHistory.push(currentIndex);
                if (songShuffleHistory.length > 50) {
                    songShuffleHistory.shift();
                }
            }

            const nextIndex = songShuffleQueue.shift();
            if (typeof nextIndex !== 'number') {
                return false;
            }

            try {
                player.playVideoAt(nextIndex);
                console.log(`ğŸ² ××¢×‘×¨ ××§×¨××™ ×œ×©×™×¨ ×‘××™×§×•× ${nextIndex}`);
                return true;
            } catch (err) {
                console.warn('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ× ×’×Ÿ ×©×™×¨ ××§×¨××™:', err);
                return false;
            }
        }

        function playPreviousShuffledSong() {
            if (!songShuffleEnabled || !player) {
                return false;
            }

            if (songShuffleHistory.length === 0) {
                return false;
            }

            const previousIndex = songShuffleHistory.pop();
            const currentIndex = typeof player.getPlaylistIndex === 'function' ? player.getPlaylistIndex() : -1;
            if (currentIndex >= 0 && !songShuffleQueue.includes(currentIndex)) {
                songShuffleQueue.unshift(currentIndex);
            }

            if (typeof previousIndex !== 'number') {
                return false;
            }

            try {
                player.playVideoAt(previousIndex);
                console.log(`â®ï¸ ×—×–×¨×” ×œ×©×™×¨ ×××¢×¨×š ×”×”×™×¡×˜×•×¨×™×” (××™×§×•× ${previousIndex})`);
                return true;
            } catch (err) {
                console.warn('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×—×–×•×¨ ×œ×©×™×¨ ×§×•×“× ×‘×¢×¨×‘×•×‘:', err);
                return false;
            }
        }

        function resetSongShuffleState() {
            songShuffleQueue = [];
            songShuffleHistory = [];
            if (songShuffleEnabled) {
                setTimeout(buildSongShuffleQueue, 500);
            }
        }

        function toggleSongShuffle() {
            songShuffleEnabled = !songShuffleEnabled;
            localStorage.setItem('songShuffleEnabled', songShuffleEnabled);
            songShuffleQueue = [];
            songShuffleHistory = [];

            if (player && typeof player.setShuffle === 'function') {
                try {
                    player.setShuffle(songShuffleEnabled);
                } catch (err) {
                    console.warn('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×¢×“×›×Ÿ ××¦×‘ shuffle ×©×œ ×”× ×’×Ÿ:', err);
                }
            }

            if (songShuffleEnabled) {
                console.log('ğŸ”€ ××¦×‘ ×¢×¨×‘×•×‘ ×©×™×¨×™× ×”×•×¤×¢×œ');
                buildSongShuffleQueue();
            } else {
                console.log('â¹ï¸ ××¦×‘ ×¢×¨×‘×•×‘ ×©×™×¨×™× ×”×•×©×‘×ª');
            }

            updateShuffleButtons();
        }

        function buildPlaylistShuffleQueue() {
            if (!playlistShuffleEnabled || playlists.length <= 1) {
                playlistShuffleQueue = [];
                return;
            }

            const indices = playlists.map((_, index) => index);
            const available = indices.filter(index => index !== currentPlaylistIndex);
            playlistShuffleQueue = shuffleArray(available);
            console.log('ğŸ” × ×‘× ×ª×” ×¨×©×™××ª ×¢×¨×‘×•×‘ ×œ×¤×œ×™×™×œ×™×¡×˜×™×:', playlistShuffleQueue);
        }

        function getNextPlaylistIndex() {
            if (!playlistShuffleEnabled || playlists.length <= 1) {
                return (currentPlaylistIndex + 1) % playlists.length;
            }

            if (playlistShuffleQueue.length === 0) {
                buildPlaylistShuffleQueue();
            }

            if (playlistShuffleQueue.length === 0) {
                return currentPlaylistIndex;
            }

            const nextIndex = playlistShuffleQueue.shift();
            playlistShuffleHistory.push(currentPlaylistIndex);
            if (playlistShuffleHistory.length > 50) {
                playlistShuffleHistory.shift();
            }
            return typeof nextIndex === 'number' ? nextIndex : currentPlaylistIndex;
        }

        function getPreviousPlaylistIndex() {
            if (!playlistShuffleEnabled || playlists.length <= 1) {
                return (currentPlaylistIndex - 1 + playlists.length) % playlists.length;
            }

            if (playlistShuffleHistory.length > 0) {
                const previousIndex = playlistShuffleHistory.pop();
                if (typeof previousIndex === 'number') {
                    if (!playlistShuffleQueue.includes(currentPlaylistIndex)) {
                        playlistShuffleQueue.unshift(currentPlaylistIndex);
                    }
                    return previousIndex;
                }
            }

            if (playlistShuffleQueue.length === 0) {
                buildPlaylistShuffleQueue();
            }

            if (playlistShuffleQueue.length === 0) {
                return currentPlaylistIndex;
            }

            return playlistShuffleQueue.pop();
        }

        function togglePlaylistShuffle() {
            playlistShuffleEnabled = !playlistShuffleEnabled;
            localStorage.setItem('playlistShuffleEnabled', playlistShuffleEnabled);
            playlistShuffleQueue = [];
            playlistShuffleHistory = [];

            if (playlistShuffleEnabled) {
                console.log('ğŸ” ××¦×‘ ×¢×¨×‘×•×‘ ×¤×œ×™×™×œ×™×¡×˜×™× ×”×•×¤×¢×œ');
                buildPlaylistShuffleQueue();
            } else {
                console.log('â¹ï¸ ××¦×‘ ×¢×¨×‘×•×‘ ×¤×œ×™×™×œ×™×¡×˜×™× ×”×•×©×‘×ª');
            }

            updateShuffleButtons();
        }

        // ×¤×ª×™×—×ª ××•×“××œ × ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™×
        function openPlaylistManager() {
            document.getElementById('playlistModal').style.display = 'block';
            renderPlaylistList();
        }

        // ×¡×’×™×¨×ª ××•×“××œ × ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™×
        function closePlaylistManager() {
            document.getElementById('playlistModal').style.display = 'none';
        }

        // ×”×¦×’×ª ×¨×©×™××ª ×¤×œ×™×™×œ×™×¡×˜×™× ×‘××•×“××œ
        function renderPlaylistList() {
            const listContainer = document.getElementById('playlistList');
            
            if (playlists.length === 0) {
                listContainer.innerHTML = '<p style="color: #aaa; text-align: center;">××™×Ÿ ×¤×œ×™×™×œ×™×¡×˜×™×. ×”×•×¡×£ ×¤×œ×™×™×œ×™×¡×˜ ×—×“×© ×œ××¢×œ×”.</p>';
                return;
            }
            
            listContainer.innerHTML = playlists.map((playlist, index) => `
                <div style="background: #444; padding: 12px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1; text-align: right;">
                        <div style="color: white; font-weight: bold; margin-bottom: 5px;">${playlist.name}</div>
                        <div style="color: #aaa; font-size: 12px;">ID: ${playlist.id}</div>
                    </div>
                    <button onclick="deletePlaylist(${index})" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                        ğŸ—‘ï¸ ××—×§
                    </button>
                </div>
            `).join('');
        }

        // ×”×•×¡×¤×ª ×¤×œ×™×™×œ×™×¡×˜ ×—×“×©
        function addNewPlaylist() {
            const nameInput = document.getElementById('newPlaylistName');
            const idInput = document.getElementById('newPlaylistId');
            
            const name = nameInput.value.trim();
            const id = idInput.value.trim();
            
            if (!name || !id) {
                alert('âŒ ×× × ××œ× ××ª ×©× ×”×¤×œ×™×™×œ×™×¡×˜ ×•×”-ID');
                return;
            }
            
            // ×‘×“×™×§×” ×× ×”-ID ×›×‘×¨ ×§×™×™×
            if (playlists.some(p => p.id === id)) {
                alert('âŒ ×¤×œ×™×™×œ×™×¡×˜ ×¢× ID ×–×” ×›×‘×¨ ×§×™×™×');
                return;
            }
            
            playlists.push({ name, id });
            savePlaylists();
            renderPlaylistList();
            
            // × ×™×§×•×™ ×”×©×“×•×ª
            nameInput.value = '';
            idInput.value = '';
            
            alert('âœ… ×”×¤×œ×™×™×œ×™×¡×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
        }

        // ××—×™×§×ª ×¤×œ×™×™×œ×™×¡×˜
        function deletePlaylist(index) {
            if (playlists.length === 1) {
                alert('âŒ ×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”×¤×œ×™×™×œ×™×¡×˜ ×”××—×¨×•×Ÿ');
                return;
            }
            
            const playlist = playlists[index];
            if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª "${playlist.name}"?`)) {
                playlists.splice(index, 1);
                
                // ×× ××—×§× ×• ××ª ×”×¤×œ×™×™×œ×™×¡×˜ ×”× ×•×›×—×™, ×¢×‘×•×¨ ×œ×¨××©×•×Ÿ
                if (currentPlaylistIndex >= playlists.length) {
                    currentPlaylistIndex = 0;
                    reloadPlayer();
                } else if (currentPlaylistIndex === index) {
                    reloadPlayer();
                }
                
                savePlaylists();
                renderPlaylistList();
                updatePlaylistName();
                
                alert('âœ… ×”×¤×œ×™×™×œ×™×¡×˜ × ××—×§ ×‘×”×¦×œ×—×”!');
            }
        }

        function onYouTubeIframeAPIReady() {
            console.log('YouTube API × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”');
            
            // ×”×¦×’×ª ×”×•×“×¢×” ×œ××©×ª××© ×©×”×¤×œ×™×™×œ×™×¡×˜ × ×˜×¢×Ÿ
            document.getElementById('currentSong').textContent = '×˜×•×¢×Ÿ ×¤×œ×™×™×œ×™×¡×˜... ×× × ×”××ª×Ÿ';
            
            try {
                createPlayer();
            } catch (e) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª × ×’×Ÿ YouTube:', e);
                // × ×™×¡×™×•×Ÿ ×©× ×™ ×¢× ×”×©×”×™×™×”
                setTimeout(() => {
                    try {
                        createPlayer();
                    } catch (error) {
                        console.error('× ×™×¡×™×•×Ÿ ×©× ×™ × ×›×©×œ:', error);
                        // ×™×¦×™×¨×ª iframe ×™×©×™×¨×•×ª ×œ×œ× autoplay
                        document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                            playlists[currentPlaylistIndex].id + 
                            '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                    }
                }, 1500);
            }
        }

        function createPlayer() {
            console.log('×™×•×¦×¨ × ×’×Ÿ YouTube...');
            try {
                player = new YT.Player('player', {
                    height: '350',
                    width: '100%',
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'listType': 'playlist',
                        'list': playlists[currentPlaylistIndex].id,
                        'rel': 0,
                        'modestbranding': 1,
                        'enablejsapi': 1
                    },
                events: {
                    'onReady': () => {
                        updatePlaylistName();
                        // ×”×•×“×¢×” ×œ××©×ª××© ×©×¦×¨×™×š ×œ×œ×—×•×¥ ×¢×œ ×›×¤×ª×•×¨ ×”× ×™×’×•×Ÿ
                        document.getElementById('currentSong').textContent = '××•×›×Ÿ ×œ× ×’×Ÿ â€“ ×œ×—×¥ ×¢×œ â–¶ï¸ ×›×“×™ ×œ×”×ª×—×™×œ';
                        // ×•×™×“×•× ×©×”× ×’×Ÿ ×‘××¦×‘ ×¢×¦×™×¨×” ×¢×“ ×œ×¤×¢×•×œ×” ×©×œ ×”××©×ª××©
                        if (player && player.pauseVideo) {
                            player.pauseVideo();
                        }
                        // ××ª×—×•×œ ××¦×‘ ×¢×¨×‘×•×‘ ×©×™×¨×™× ×× ×”×•×¤×¢×œ ×‘×¢×‘×¨
                        if (songShuffleEnabled && player && player.setShuffle) {
                            try {
                                player.setShuffle(true);
                                buildSongShuffleQueue();
                            } catch (err) {
                                console.warn('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ××¦×‘ ×¢×¨×‘×•×‘ ×‘×¢×ª ×˜×¢×™× ×ª ×”× ×’×Ÿ:', err);
                            }
                        }
                        updatePlayPauseButton(false);
                        updateShuffleButtons();

                        if (pendingRestoreState && !restoringPlayback) {
                            console.log('ğŸ” ×× ×¡×” ×œ×©×—×–×¨ ××ª ×”×©×™×¨ ×”××—×¨×•×Ÿ...');
                            setTimeout(() => attemptRestorePlayback(), 500);
                        }
                    },
                    'onStateChange': (event) => {
                        // ×¢×“×›×•×Ÿ ×©× ×”×©×™×¨ ×›××©×¨ ×”×©×™×¨ ××©×ª× ×”
                        if (event.data === YT.PlayerState.PLAYING) {
                            userRequestedStop = false;
                            updateCurrentSong();
                            updatePlayPauseButton(true);
                            startPlaybackStateTracking();
                            if (restoringPlayback && pendingRestoreState) {
                                const targetTime = pendingRestoreState.time || 0;
                                if (typeof player.seekTo === 'function') {
                                    console.log(`â±ï¸ ××©×—×–×¨ ××™×§×•× ${targetTime} ×©× ×™×•×ª`);
                                    try {
                                        player.seekTo(targetTime, true);
                                    } catch (err) {
                                        console.warn('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××™×§×•× ×‘×–××Ÿ:', err);
                                    }
                                }
                                pendingRestoreState = null;
                                restoringPlayback = false;
                            }
                        } else if (event.data === YT.PlayerState.PAUSED) {
                            updatePlayPauseButton(false);

                            if (!userRequestedStop) {
                                console.log('â–¶ï¸ ×”× ×’×Ÿ ×”×•×©×”×” ×œ×œ× ×‘×§×©×ª ×”××©×ª××© - ×××©×™×š ×œ× ×’×Ÿ');
                                setTimeout(() => {
                                    if (player && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PAUSED && !userRequestedStop) {
                                        playVideo();
                                    }
                                }, 800);
                            }
                        } else if (event.data === YT.PlayerState.ENDED) {
                            updatePlayPauseButton(false);

                            if (!userRequestedStop) {
                                console.log('â­ï¸ ×©×™×¨ ×”×¡×ª×™×™× - ×¢×•×‘×¨ ×œ×©×™×¨ ×”×‘× ××•×˜×•××˜×™×ª');
                                setTimeout(() => {
                                    if (!userRequestedStop) {
                                        nextTrack();
                                    }
                                }, 300);
                            }
                            stopPlaybackStateTracking();
                        }
                    },
                    'onError': handlePlayerError
                }
            });
            } catch (error) {
                console.error('×©×’×™××” ×‘×™×¦×™×¨×ª × ×’×Ÿ YouTube:', error);
                // × ×™×¡×™×•×Ÿ ×©× ×™ ×× ×”×¨××©×•×Ÿ × ×›×©×œ
                setTimeout(() => {
                    try {
                        document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                            playlists[currentPlaylistIndex].id + 
                            '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                    } catch (e) {
                        console.error('× ×™×¡×™×•×Ÿ ×™×¦×™×¨×ª × ×’×Ÿ ×’×™×‘×•×™ × ×›×©×œ:', e);
                    }
                }, 1000);
            }
        }

        function updatePlaylistName() {
            document.getElementById('playlistName').textContent = playlists[currentPlaylistIndex].name;
        }

        function playVideo(userInitiated = false) {
            if (userRequestedStop && !userInitiated) {
                console.log('â¸ï¸ × ×™×’×•×Ÿ ××•×˜×•××˜×™ × ×—×¡× - ×”××©×ª××© ×¢×¦×¨ ××ª ×”× ×’×Ÿ ×™×“× ×™×ª');
                return;
            }

            if (player && player.playVideo) {
                if (userInitiated) {
                    userRequestedStop = false;
                }

                hasUserInteracted = true;
                player.playVideo();
                startAdDetection(); // ×”×¤×¢×œ ×–×™×”×•×™ ×¤×¨×¡×•××•×ª
                
                // ××ª×—×œ background audio ×œ××§×¨×” ×©×œ ××¢×‘×¨ ×œ×¨×§×¢
                const backgroundAudio = document.getElementById('backgroundAudio');
                if (backgroundAudio && backgroundAudio.paused) {
                    const silenceUrl = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                    backgroundAudio.src = silenceUrl;
                    backgroundAudio.loop = true;
                    backgroundAudio.volume = 0.01; // ×©×§×˜ ×××•×“
                    backgroundAudio.play().catch(e => console.log('Silent audio init:', e));
                    console.log('ğŸ”‡ Background audio initialized (silent)');
                }
                updatePlayPauseButton(true);
            }
        }

        function pauseVideo(userInitiated = false) {
            if (userInitiated) {
                userRequestedStop = true;
            }

            if (player && player.pauseVideo) {
                player.pauseVideo();
                stopAdDetection();
                updatePlayPauseButton(false);
            }
        }

        function togglePlayPause(btn) {
            if (!player || typeof player.getPlayerState !== 'function') {
                playVideo();
                return;
            }

            const state = player.getPlayerState();
            // YT.PlayerState.PLAYING === 1, PAUSED === 2, BUFFERING === 3, UNSTARTED === -1, ENDED === 0
            if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
                pauseVideo(true);
            } else {
                playVideo(true);
            }
        }

        function nextTrack() {
            if (!player) return;

            hasUserInteracted = true;
            userRequestedStop = false;

            if (songShuffleEnabled && playNextShuffledSong()) {
                return;
            }

            if (player.nextVideo) {
                player.nextVideo();
                setTimeout(() => {
                    if (player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        playVideo();
                    }
                }, 400);
            }
        }

        function previousTrack() {
            if (!player) return;

            hasUserInteracted = true;
            userRequestedStop = false;

            if (songShuffleEnabled && playPreviousShuffledSong()) {
                return;
            }

            if (player.previousVideo) {
                player.previousVideo();
                setTimeout(() => {
                    if (player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                        playVideo();
                    }
                }, 400);
            }
        }

        function nextPlaylist() {
            const oldIndex = currentPlaylistIndex;
            const targetIndex = getNextPlaylistIndex();
            currentPlaylistIndex = targetIndex;
            console.log(`â­ï¸ ××¢×‘×¨ ××¤×œ×™×™×œ×™×¡×˜ ${oldIndex} (${playlists[oldIndex].name}) ×œ×¤×œ×™×™×œ×™×¡×˜ ${currentPlaylistIndex} (${playlists[currentPlaylistIndex].name})`);
            hasUserInteracted = true;
            
            // ×¢×“×›×Ÿ ××ª ×©× ×”×¤×œ×™×™×œ×™×¡×˜ ××™×“
            updatePlaylistName();
            
            // ×˜×¢×Ÿ ××ª ×”× ×’×Ÿ ××—×“×©
            reloadPlayer();
            
            // ×”×•×¡×¤×ª ××¤×§×˜ ×•×™×–×•××œ×™ ×›×“×™ ×©×”××©×ª××© ×™×“×¢ ×©×”×¤×¢×•×œ×” ×”×ª×§×‘×œ×”
            const playlistName = document.getElementById('playlistName');
            playlistName.style.animation = 'none';
            setTimeout(() => {
                playlistName.style.animation = 'flashEffect 0.5s';
            }, 10);
        }

        function previousPlaylist() {
            const oldIndex = currentPlaylistIndex;
            const targetIndex = getPreviousPlaylistIndex();
            currentPlaylistIndex = targetIndex;
            console.log(`â®ï¸ ××¢×‘×¨ ××¤×œ×™×™×œ×™×¡×˜ ${oldIndex} (${playlists[oldIndex].name}) ×œ×¤×œ×™×™×œ×™×¡×˜ ${currentPlaylistIndex} (${playlists[currentPlaylistIndex].name})`);
            hasUserInteracted = true;
            
            // ×¢×“×›×Ÿ ××ª ×©× ×”×¤×œ×™×™×œ×™×¡×˜ ××™×“
            updatePlaylistName();
            
            // ×˜×¢×Ÿ ××ª ×”× ×’×Ÿ ××—×“×©
            reloadPlayer();
            
            // ×”×•×¡×¤×ª ××¤×§×˜ ×•×™×–×•××œ×™ ×›×“×™ ×©×”××©×ª××© ×™×“×¢ ×©×”×¤×¢×•×œ×” ×”×ª×§×‘×œ×”
            const playlistName = document.getElementById('playlistName');
            playlistName.style.animation = 'none';
            setTimeout(() => {
                playlistName.style.animation = 'flashEffect 0.5s';
            }, 10);
        }

        function reloadPlayer() {
            console.log(`×˜×•×¢×Ÿ ××—×“×© ×¤×œ×™×™×œ×™×¡×˜: ${playlists[currentPlaylistIndex].name}`);

            try {
                if (player) {
                    player.destroy();
                }
                resetSongShuffleState();
                if (playlistShuffleEnabled) {
                    buildPlaylistShuffleQueue();
                }
                
                // ×™×¦×™×¨×ª × ×’×Ÿ ×—×“×© ×œ××—×¨ ×”×©×”×™×™×” ×§×¦×¨×”
                setTimeout(() => {
                    createPlayer();
                    
                    // ×× ×”×™×¦×™×¨×” × ×›×©×œ×”, × ×¡×” ×‘×“×¨×š ××—×¨×ª
                    setTimeout(() => {
                        if (!player || (player && typeof player.getPlayerState !== 'function')) {
                            console.log('× ×™×¡×™×•×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×¤×œ×™×™×œ×™×¡×˜ ×‘×“×¨×š ×™×©×™×¨×”');
                            document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                                playlists[currentPlaylistIndex].id + 
                                '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';

                            // ×¢×“×›×•×Ÿ ×©× ×”×¤×œ×™×™×œ×™×¡×˜ ×’× ×‘××¦×‘ ×–×”
                            updatePlaylistName();
                        }
                    }, 2000);
                }, 500);
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×œ×™×™×œ×™×¡×˜:', error);

                // × ×™×¡×™×•×Ÿ ××—×¨×•×Ÿ ×‘×××¦×¢×•×ª ×”×˜××¢×” ×™×©×™×¨×” ×œ×œ× autoplay
                document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                    playlists[currentPlaylistIndex].id + 
                    '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';

                updatePlaylistName();
            }
        }

        function goBack() {
            // ××›×™×•×•×Ÿ ×©××“×•×‘×¨ ×‘×™×™×©×•× ×“×£ ×‘×•×“×“, × ×¢×‘×™×¨ ×œ×“×£ ×”×“××” ×©×œ ×ª×¤×¨×™×˜ ×¨××©×™
            alert('×ª×•×“×” ×©×”×©×ª××©×ª ×‘× ×’×Ÿ ×”××•×–×™×§×” ×œ×¨×›×‘!\n×–×” ×”×“×£ ×”×¨××©×™ ×©×œ ×”××¤×œ×™×§×¦×™×”.');
        }

        function buttonClickEffect(button) {
            button.classList.add("active-effect");
            setTimeout(() => {
                button.classList.remove("active-effect");
            }, 300);
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function toggleSettingsMenu(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            if (!dropdown || !toggleBtn) {
                return;
            }

            event.stopPropagation();

            const isOpen = !dropdown.classList.contains('open');
            if (isOpen) {
                dropdown.classList.add('open');
                dropdown.setAttribute('aria-hidden', 'false');
                toggleBtn.setAttribute('aria-expanded', 'true');
                document.addEventListener('click', handleSettingsOutsideClick);
                document.addEventListener('keydown', handleSettingsKeydown);
            } else {
                closeSettingsMenu();
            }
        }

        function closeSettingsMenu() {
            const dropdown = document.getElementById('settingsDropdown');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            if (!dropdown || !toggleBtn) {
                return;
            }

            dropdown.classList.remove('open');
            dropdown.setAttribute('aria-hidden', 'true');
            toggleBtn.setAttribute('aria-expanded', 'false');
            document.removeEventListener('click', handleSettingsOutsideClick);
            document.removeEventListener('keydown', handleSettingsKeydown);
        }

        function handleSettingsOutsideClick(event) {
            const dropdown = document.getElementById('settingsDropdown');
            const toggleBtn = document.getElementById('settingsToggleBtn');
            if (!dropdown || !toggleBtn) {
                return;
            }

            if (!dropdown.contains(event.target) && event.target !== toggleBtn) {
                closeSettingsMenu();
            }
        }

        function handleSettingsKeydown(event) {
            if (event.key === 'Escape') {
                closeSettingsMenu();
            }
        }

        function handleDayNightToggle(button) {
            buttonClickEffect(button);
            toggleDayNightMode();
            closeSettingsMenu();
        }

        function handleUpdateCheck(button) {
            buttonClickEffect(button);
            closeSettingsMenu();
            checkForUpdates();
        }

        function handleGoBack(button) {
            buttonClickEffect(button);
            closeSettingsMenu();
            goBack();
        }

        function updateDayNightSettingUI() {
            const icon = document.getElementById('dayNightSettingIcon');
            const label = document.getElementById('dayNightSettingLabel');
            if (!icon || !label) {
                return;
            }

            if (isDayMode) {
                icon.textContent = 'â˜€ï¸';
                label.textContent = '×”×¤×¢×œ ××¦×‘ ×œ×™×œ×”';
            } else {
                icon.textContent = 'ğŸŒ™';
                label.textContent = '×”×¤×¢×œ ××¦×‘ ×™×•×';
            }
        }
        // ×¤×•× ×§×¦×™×” ×œ×”×—×œ×¤×ª ××¦×‘ ×™×•×/×œ×™×œ×”
        function toggleDayNightMode() {
            isDayMode = !isDayMode;
            const body = document.body;
            
            if (isDayMode) {
                body.classList.add('day-mode');
            } else {
                body.classList.remove('day-mode');
            }
            
            updateDayNightSettingUI();
        }
        
        // ×‘×“×™×§×ª ×–××Ÿ ×™×•× ××•×˜×•××˜×™×ª ×‘×˜×¢×™× ×”
        function checkDayTime() {
            const hour = new Date().getHours();
            // ×× ×”×©×¢×” ×‘×™×Ÿ 7 ×‘×‘×•×§×¨ ×œ-19 ×‘×¢×¨×‘, ×”×¤×¢×œ ××¦×‘ ×™×•×
            if (hour >= 7 && hour < 19 && !isDayMode) {
                toggleDayNightMode();
            }
        }
        
        // ×‘×“×™×§×ª ×–××Ÿ ×™×•× ×‘×˜×¢×™× ×”
        window.addEventListener('load', checkDayTime);
        window.addEventListener('load', updateDayNightSettingUI);
        
        // ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š
        function preventScreenSleep() {
            // ×©×™××•×© ×‘-NoSleep.js ×œ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š
            if ('wakeLock' in navigator) {
                // ×× ×”×“×¤×“×¤×Ÿ ×ª×•××š ×‘-Wake Lock API
                let wakeLock = null;
                
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('××¡×š × ×©××¨ ×“×œ×•×§ - Wake Lock ×”×•×¤×¢×œ');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock ×©×•×—×¨×¨, ×× ×¡×” ×œ×”×¤×¢×™×œ ××—×“×©...');
                            requestWakeLock(); // × ×™×¡×™×•×Ÿ ×œ×”×¤×¢×™×œ ××—×“×©
                        });
                    } catch (err) {
                        console.error(`×œ× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ Wake Lock: ${err.name}, ${err.message}`);
                        // ×”×¤×¢×œ×ª ×©×™×˜×” ×—×œ×•×¤×™×ª - × ×’×™× ×ª ×¡×¨×˜×•×Ÿ ×©×§×˜ ×œ×œ× × ×¨××•×ª
                        fallbackNoSleep();
                    }
                };
                
                // ×”×¤×¢×œ×ª Wake Lock ×‘×¢×ª ×˜×¢×™× ×ª ×”×“×£
                requestWakeLock();
                
                // ×”×¤×¢×œ×” ××—×“×© ×©×œ Wake Lock ×›××©×¨ ×”×“×£ ×—×•×–×¨ ×œ×”×™×•×ª ×’×œ×•×™
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && wakeLock === null) {
                        requestWakeLock();
                    }
                });
            } else {
                // ×©×™×˜×” ×—×œ×•×¤×™×ª ×× ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-Wake Lock API
                fallbackNoSleep();
            }
        }
        
        // ×©×™×˜×” ×—×œ×•×¤×™×ª ×œ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š
        function fallbackNoSleep() {
            // ×™×¦×™×¨×ª ××œ×× ×˜ ××•×“×™×• ×©×™× ×•×’×Ÿ ×‘×¨×§×¢ ×‘×©×§×˜
            console.log('××¤×¢×™×œ ×©×™×˜×” ×—×œ×•×¤×™×ª ×œ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š');
            setInterval(() => {
                // ×™×¦×™×¨×ª ×ª×–×•×–×” ×§×˜× ×” ×›×œ 30 ×©× ×™×•×ª ×›×“×™ ×œ×× ×•×¢ ×›×™×‘×•×™ ××¡×š
                window.scrollBy(0, 1);
                window.scrollBy(0, -1);
            }, 30000);
        }
        
        // ×–×™×”×•×™ ×•×“×™×œ×•×’ ×¢×œ ×¤×¨×¡×•××•×ª - ××œ×’×•×¨×™×ª× ××©×•×¤×¨ ×‘××™×•×—×“ ×œ-PWA
        function detectAndSkipAds() {
            if (!player || !player.getDuration || !player.getCurrentTime) return;
            
            try {
                const duration = player.getDuration();
                const currentTime = player.getCurrentTime();
                const playerState = player.getPlayerState();
                let currentUrl = '';
                let videoData = null;
                
                // × ×¡×” ×œ×§×‘×œ URL ×•-videoData (×¢×©×•×™ ×œ×”×™×›×©×œ ×‘×¤×¨×¡×•××•×ª)
                try {
                    currentUrl = player.getVideoUrl ? player.getVideoUrl() : '';
                    videoData = player.getVideoData ? player.getVideoData() : null;
                } catch (e) {
                    // ×× × ×›×©×œ ×œ×§×‘×œ ××™×“×¢ - ×–×” ×›× ×¨××” ×¤×¨×¡×•××ª!
                    console.log('âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××™×“×¢ ×¢×œ ×”×¡×¨×˜×•×Ÿ - ×›× ×¨××” ×¤×¨×¡×•××ª');
                }
                
                // ×‘×“×™×§×” ××™×•×—×“×ª ×œ-PWA: ×”×× ×–×” standalone mode?
                const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                              window.navigator.standalone === true;
                
                // ××¡×˜×¨×˜×’×™×•×ª ×–×™×”×•×™ ××©×•×œ×‘×•×ª:
                let adIndicators = 0;
                
                // 1. ×‘×“×™×§×ª video_id - ×¤×¨×¡×•××•×ª ×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª ×™×© ID ×§×¦×¨ ××• ××•×–×¨
                if (videoData && videoData.video_id) {
                    const videoId = videoData.video_id;
                    // ×¤×¨×¡×•××•×ª ×‘×“×¨×š ×›×œ×œ ×™×© ID ×§×¦×¨ ×××•×“ ××• ××ª×—×™×œ ×‘-prefix ××™×•×—×“
                    if (videoId.length < 8 || videoId.startsWith('_')) {
                        adIndicators += 3;
                        console.log('ğŸš« ×–×•×”×” video_id ×—×©×•×“:', videoId);
                    }
                }
                
                // 2. ×‘×“×™×§×ª ××©×š - ×¤×¨×¡×•××•×ª ×™×›×•×œ×•×ª ×œ×”×™×•×ª 5-180 ×©× ×™×•×ª
                if (duration > 0 && duration >= 5 && duration <= 180) {
                    adIndicators++;
                    // ×× ×”××©×š ×§×¦×¨ ×××•×“ (×¤×—×•×ª ×-30 ×©× ×™×•×ª) - ×—×©×•×“ ×™×•×ª×¨
                    if (duration < 30) {
                        adIndicators++;
                    }
                }
                
                // 3. ×©×™× ×•×™ ×¤×ª××•××™ ×‘-URL ××• ×‘××©×š
                if (lastVideoUrl && currentUrl && currentUrl !== lastVideoUrl) {
                    adIndicators++;
                    console.log('ğŸ”„ ×©×™× ×•×™ URL ×–×•×”×”');
                }
                if (lastKnownDuration > 0 && Math.abs(duration - lastKnownDuration) > 15) {
                    adIndicators++;
                    console.log('â±ï¸ ×©×™× ×•×™ ××©×š ×–×•×”×”');
                }
                
                // 4. ×‘×“×™×§×ª ×©× ×”×¡×¨×˜×•×Ÿ (×¤×¨×¡×•××•×ª ×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª ×™×© ××™×œ×™× ××¡×•×™××•×ª)
                if (videoData && videoData.title) {
                    const title = videoData.title.toLowerCase();
                    const adKeywords = [
                        'ad', 'advertisement', 'sponsor', 'sponsored', 
                        '×¤×¨×¡×•××ª', '××•×¢×¦×¨', 'promo', 'commercial',
                        'visit', 'buy now', 'shop', 'deal',
                        'limited time', 'offer', 'sale'
                    ];
                    if (adKeywords.some(keyword => title.includes(keyword))) {
                        adIndicators += 4; // ××©×§×œ ×’×‘×•×” ×××•×“
                        console.log('ğŸ“¢ ×–×•×”×ª×” ××™×œ×ª ××¤×ª×— ×‘×›×•×ª×¨×ª:', title);
                    }
                    
                    // ×× ××™×Ÿ ×›×•×ª×¨×ª ××• ×›×•×ª×¨×ª ×¨×™×§×” - ×—×©×•×“
                    if (!title || title.trim() === '') {
                        adIndicators += 3;
                    }
                } else {
                    // ×× ××™×Ÿ videoData ×‘×›×œ×œ - ×—×©×•×“ ×××•×“
                    adIndicators += 3;
                    console.log('âŒ ××™×Ÿ videoData - ×›× ×¨××” ×¤×¨×¡×•××ª');
                }
                
                // 5. ×‘×“×™×§×ª ×”×ª× ×”×’×•×ª ××©×•× ×”
                const timeRemaining = duration - currentTime;
                if (timeRemaining > 0 && timeRemaining < 40 && duration < 90) {
                    adIndicators++;
                }
                
                // 6. ×‘×“×™×§×” ×× ××¤×©×¨ ×œ×“×œ×’ - ×¤×¨×¡×•××•×ª ×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª ×œ× ×××¤×©×¨×•×ª ×“×™×œ×•×’
                try {
                    // ×× ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ playlist ××• ×©×”×•× ×¨×™×§ - ×›× ×¨××” ×¤×¨×¡×•××ª
                    const playlist = player.getPlaylist ? player.getPlaylist() : null;
                    if (!playlist || playlist.length === 0) {
                        adIndicators += 2;
                        console.log('ï¿½ ××™×Ÿ playlist - ×›× ×¨××” ×¤×¨×¡×•××ª');
                    }
                } catch (e) {
                    adIndicators += 2;
                }
                
                // 7. ×‘×“×™×§×” ××™×•×—×“×ª ×œ-PWA - ×× ×‘-standalone mode, ×”×™×” ×™×•×ª×¨ ××’×¨×¡×™×‘×™
                if (isPWA && duration > 0 && duration < 90) {
                    adIndicators += 1;
                }
                
                // ×”×—×œ×˜×”: ×× ×™×© 3+ ××™× ×“×™×§×˜×•×¨×™× (××• 4+ ×‘-PWA), ×–×• ×›× ×¨××” ×¤×¨×¡×•××ª
                const threshold = isPWA ? 4 : 3;
                const isPossibleAd = adIndicators >= threshold && playerState === 1;
                
                console.log(`ğŸ” ××™× ×“×™×§×˜×•×¨×™×: ${adIndicators}/${threshold}, ××©×š: ${duration.toFixed(1)}s, PWA: ${isPWA}`);
                
                if (isPossibleAd) {
                    consecutiveAdChecks++;
                    
                    // ×‘-PWA mode - ×”×©×ª×§ ××™×“ ×œ×œ× ×”××ª× ×”
                    const checksNeeded = isPWA ? 1 : 2;
                    
                    if (!isAdPlaying && consecutiveAdChecks >= checksNeeded) {
                        console.log(`ğŸš« ×–×•×”×ª×” ×¤×¨×¡×•××ª! (××™× ×“×™×§×˜×•×¨×™×: ${adIndicators}, PWA: ${isPWA}) - ××©×ª×™×§ ×•××“×œ×’`);
                        isAdPlaying = true;
                        
                        // ×”×©×ª×§×ª ×©××¢ ××™×™×“×™×ª
                        if (player.isMuted && !player.isMuted()) {
                            lastVolume = player.getVolume();
                            player.mute();
                        }
                    }
                    
                    // ×“×™×œ×•×’ ××’×¨×¡×™×‘×™ ×‘××™×•×—×“ ×‘-PWA
                    if (isAdPlaying) {
                        if (currentTime < duration - 1) {
                            // ×§×¤×™×¦×” ×’×“×•×œ×” ×™×•×ª×¨ ×‘-PWA
                            const skipAmount = isPWA ? 15 : 10;
                            const skipTo = Math.min(duration - 0.3, currentTime + skipAmount);
                            player.seekTo(skipTo, true);
                        } else {
                            // ×›××¢×˜ ×‘×¡×•×£ - ×¢×‘×•×¨ ×œ×©×™×¨ ×”×‘×
                            console.log('â­ï¸ ××¢×‘×™×¨ ×œ×©×™×¨ ×”×‘×...');
                            if (player.nextVideo) {
                                player.nextVideo();
                            }
                        }
                    }
                } else {
                    // ×œ× ×¤×¨×¡×•××ª - ××™×¤×•×¡ ×•×”×—×–×¨×ª ×©××¢
                    consecutiveAdChecks = 0;
                    
                    if (isAdPlaying) {
                        console.log('âœ… ×¤×¨×¡×•××ª ×”×¡×ª×™×™××” - ××—×–×™×¨ ×©××¢ ×¨×’×™×œ');
                        isAdPlaying = false;
                        
                        if (player.isMuted && player.isMuted() && lastVolume > 0) {
                            player.unMute();
                            player.setVolume(lastVolume);
                        }
                    }
                    
                    // ×¢×“×›×•×Ÿ × ×ª×•× ×™× ××—×¨×•× ×™×
                    if (duration > 60) { // ×¨×§ ×©×™×¨×™× ×××™×ª×™×™×
                        lastKnownDuration = duration;
                    }
                }
                
                lastVideoUrl = currentUrl;
                
            } catch (e) {
                console.error('×©×’×™××” ×‘×–×™×”×•×™ ×¤×¨×¡×•××•×ª:', e);
            }
        }
        
        // ×”×¤×¢×œ×ª ×–×™×”×•×™ ×¤×¨×¡×•××•×ª
        function startAdDetection() {
            if (adDetectionInterval) {
                clearInterval(adDetectionInterval);
            }
            // ×‘×“×™×§×” ×›×œ 200 ××™×œ×™×©× ×™×•×ª ×‘-PWA, 300 ×‘×“×¤×“×¤×Ÿ ×¨×’×™×œ
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
            const checkInterval = isPWA ? 200 : 300;
            adDetectionInterval = setInterval(detectAndSkipAds, checkInterval);
            console.log(`ğŸ›¡ï¸ ××¢×¨×›×ª ×–×™×”×•×™ ×¤×¨×¡×•××•×ª ×”×•×¤×¢×œ×” (${isPWA ? 'PWA' : 'Browser'} mode, ${checkInterval}ms)`);
        }
        
        // ×¢×¦×™×¨×ª ×–×™×”×•×™ ×¤×¨×¡×•××•×ª
        function stopAdDetection() {
            if (adDetectionInterval) {
                clearInterval(adDetectionInterval);
                adDetectionInterval = null;
            }
        }

        // ×¢×“×›×•×Ÿ Media Session API ×œ× ×™×’×•×Ÿ ×‘×¨×§×¢
        function updateMediaSession(title) {
            if ('mediaSession' in navigator) {
                try {
                    const backgroundAudio = document.getElementById('backgroundAudio');
                    
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title || '× ×’×Ÿ ××•×–×™×§×” ×œ×¨×›×‘',
                        artist: playlists[currentPlaylistIndex].name,
                        album: 'ğŸ¶ × ×’×Ÿ ×©×™×¨×™× ×œ×¨×›×‘ ğŸš—',
                        artwork: [
                            { src: 'car-music-icon.png', sizes: '192x192', type: 'image/png' },
                            { src: 'car-music-icon.png', sizes: '512x512', type: 'image/png' }
                        ]
                    });

                    // ×”×’×“×¨×ª ×¤×¢×•×œ×•×ª ×©×œ×™×˜×”
                    navigator.mediaSession.setActionHandler('play', () => {
                        playVideo(true);
                        // ×•×•×“× ×©×”-background audio ×¤×¢×™×œ
                        if (backgroundAudio && backgroundAudio.paused) {
                            backgroundAudio.play().catch(e => console.log('Background audio play failed'));
                        }
                    });
                    navigator.mediaSession.setActionHandler('pause', () => {
                        pauseVideo(true);
                        // ×¢×¦×•×¨ ×’× ××ª ×”-background audio
                        if (backgroundAudio && !backgroundAudio.paused) {
                            backgroundAudio.pause();
                        }
                    });
                    navigator.mediaSession.setActionHandler('previoustrack', () => {
                        previousTrack();
                    });
                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        nextTrack();
                    });
                    
                    // ×›×¤×ª×•×¨×™× × ×•×¡×¤×™× ×œ××¢×‘×¨ ×‘×™×Ÿ ×¤×œ×™×™×œ×™×¡×˜×™×
                    navigator.mediaSession.setActionHandler('seekbackward', () => {
                        console.log('âª ×¤×œ×™×™×œ×™×¡×˜ ×§×•×“× (×-Media Session)');
                        previousPlaylist();
                    });
                    navigator.mediaSession.setActionHandler('seekforward', () => {
                        console.log('â© ×¤×œ×™×™×œ×™×¡×˜ ×”×‘× (×-Media Session)');
                        nextPlaylist();
                    });

                    console.log('âœ… Media Session API ××•×¤×¢×œ - 5 ×›×¤×ª×•×¨×™× ×–××™× ×™× (×©×™×¨×™× + ×¤×œ×™×™×œ×™×¡×˜×™×)');
                } catch (e) {
                    console.warn('Media Session API ×œ× × ×ª××š:', e);
                }
            }
        }

        // ×¢×“×›×•×Ÿ ×©× ×”×©×™×¨ ×”× ×•×›×—×™
        function updateCurrentSong() {
            if (player && player.getVideoData) {
                try {
                    const videoData = player.getVideoData();
                    if (videoData && videoData.title) {
                        const adIndicator = isAdPlaying ? ' ğŸš« [××“×œ×’ ×¢×œ ×¤×¨×¡×•××ª...]' : '';
                        const title = videoData.title;
                        document.getElementById('currentSong').textContent = title + adIndicator;
                        
                        // ×¢×“×›×•×Ÿ Media Session
                        if (!isAdPlaying) {
                            updateMediaSession(title);
                        }
                    } else if (hasUserInteracted) {
                        document.getElementById('currentSong').textContent = '×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××™×“×¢ ×¢×œ ×”×©×™×¨';
                    }
                } catch (e) {
                    console.error('×©×’×™××” ×‘×§×‘×œ×ª ××™×“×¢ ×¢×œ ×”×©×™×¨:', e);
                }
            } else if (!hasUserInteracted) {
                document.getElementById('currentSong').textContent = '××•×›×Ÿ ×œ× ×’×Ÿ â€“ ×œ×—×¥ ×¢×œ â–¶ï¸ ×›×“×™ ×œ×”×ª×—×™×œ';
            }
        }

        function handlePlayerError(event) {
            const currentSongLabel = document.getElementById('currentSong');
            let message = '×œ× × ×™×ª×Ÿ ×œ× ×’×Ÿ ××ª ×”×©×™×¨ ×”× ×•×›×—×™.';

            switch (event.data) {
                case 2:
                    message = '×›×ª×•×‘×ª ×”×¡×¨×˜×•×Ÿ ×©×’×•×™×” ××• ×‘×œ×ª×™ ×–××™× ×”.';
                    break;
                case 5:
                    message = '×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×¤×•×¨××˜ ×”×¡×¨×˜×•×Ÿ ×”× ×•×›×—×™.';
                    break;
                case 100:
                case 101:
                case 150:
                    message = '×”×¡×¨×˜×•×Ÿ ××•×’×‘×œ ×œ×¦×¤×™×™×” ×‘×ª×•×š YouTube ×‘×œ×‘×“.';
                    break;
            }

            currentSongLabel.textContent = message + ' ××“×œ×’ ×œ×©×™×¨ ×”×‘×...';

            if (!userRequestedStop && player && player.nextVideo && hasUserInteracted) {
                setTimeout(() => {
                    if (userRequestedStop) {
                        return;
                    }
                    try {
                        userRequestedStop = false;
                        player.nextVideo();
                        setTimeout(() => {
                            if (player && player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING && !userRequestedStop) {
                                playVideo();
                            }
                        }, 500);
                    } catch (err) {
                        console.error('× ×™×¡×™×•×Ÿ ××¢×‘×¨ ×œ×©×™×¨ ×”×‘× × ×›×©×œ:', err);
                    }
                }, 1500);
            }
        }
        
        // ×‘×“×™×§×” ××—×–×•×¨×™×ª ×©×œ ×©× ×”×©×™×¨ ×”× ×•×›×—×™
        setInterval(updateCurrentSong, 2000);
        
        // ×”×¤×¢×œ×ª ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š ×‘×˜×¢×™× ×ª ×”×“×£
        window.addEventListener('load', preventScreenSleep);
        
        // ×©×œ×™×˜×” ×‘×¢×•×¦××ª ×”×©××¢
        document.getElementById('volumeSlider').addEventListener('input', function() {
            if (player && player.setVolume) {
                const volume = this.value;
                player.setVolume(volume);
                updateVolumeIcon(volume);
                lastVolume = volume;
            }
        });
        
        // ×¢×“×›×•×Ÿ ××™×™×§×•×Ÿ ×”×¢×•×¦××” ×œ×¤×™ ×¢×¨×š ×”×¢×•×¦××”
        function updateVolumeIcon(volume) {
            const volumeIcon = document.getElementById('volumeIcon');
            if (volume == 0) {
                volumeIcon.textContent = 'ğŸ”‡'; // ××•×©×ª×§
            } else if (volume < 50) {
                volumeIcon.textContent = 'ğŸ”‰'; // ×¢×•×¦××” × ××•×›×”
            } else {
                volumeIcon.textContent = 'ğŸ”Š'; // ×¢×•×¦××” ×’×‘×•×”×”
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×©×ª×§×” ×•×”×¤×¢×œ×” ××—×“×© ×©×œ ×”×©××¢
        function toggleMute() {
            if (player && player.isMuted) {
                const volumeSlider = document.getElementById('volumeSlider');
                if (player.isMuted()) {
                    player.unMute();
                    volumeSlider.value = lastVolume;
                    updateVolumeIcon(lastVolume);
                } else {
                    player.mute();
                    updateVolumeIcon(0);
                }
            }
        }
        
        // ×ª××™×›×” ×‘×”×ª×§× ×ª PWA 
        window.addEventListener('beforeinstallprompt', (e) => {
            // ×× ×™×¢×ª ×”×¦×’×ª ×”×—×œ×•×Ÿ ×”××•×˜×•××˜×™
            e.preventDefault();
            // ×©××™×¨×ª ×”××™×¨×•×¢ ×›×“×™ ×©× ×•×›×œ ×œ×”×¤×¢×™×œ ××•×ª×• ×××•×—×¨ ×™×•×ª×¨
            deferredPrompt = e;
            
            // ×™×¦×™×¨×ª ×—×œ×•×Ÿ ××•×ª×× ×¢× ×”×•×“×¢×” ×œ×”×ª×§× ×”
            const installPrompt = document.createElement('div');
            installPrompt.className = 'install-prompt';
            installPrompt.innerHTML = `
                <button class="close-prompt" id="closePromptBtn">âœ–ï¸</button>
                <p>×¨×•×¦×” ×œ×”×ª×§×™×Ÿ ××ª × ×’×Ÿ ×”××•×–×™×§×” ×œ×¨×›×‘ ×™×©×™×¨×•×ª ×œ××¡×š ×”×‘×™×ª?</p>
                <button id="installBtn">×”×ª×§×Ÿ ×¢×›×©×™×•</button>
            `;
            document.body.appendChild(installPrompt);
            
            // ×”×¦×’×ª ×”×—×œ×•×Ÿ ×œ××—×¨ ×©× ×™×™×”
            setTimeout(() => {
                installPrompt.style.display = 'block';
            }, 1000);
            
            // ×”×•×¡×¤×ª ×××–×™×Ÿ ××™×¨×•×¢×™× ×œ×›×¤×ª×•×¨ ×”×¡×’×™×¨×”
            document.getElementById('closePromptBtn').addEventListener('click', () => {
                installPrompt.style.display = 'none';
            });
            
            // ×”×•×¡×¤×ª ×××–×™×Ÿ ××™×¨×•×¢×™× ×œ×›×¤×ª×•×¨ ×”×”×ª×§× ×”
            document.getElementById('installBtn').addEventListener('click', async () => {
                // ×”×¡×ª×¨×ª ×”×—×œ×•×Ÿ
                installPrompt.style.display = 'none';
                
                // ×”×¦×’×ª ×—×œ×•×Ÿ ×”×”×ª×§× ×”
                deferredPrompt.prompt();
                
                // ×‘×“×™×§×” ×× ×”××©×ª××© ××™×©×¨ ××ª ×”×”×ª×§× ×”
                const { outcome } = await deferredPrompt.userChoice;
                
                // ××™×¤×•×¡ deferredPrompt ×›×™ × ×™×ª×Ÿ ×œ×”×©×ª××© ×‘×• ×¨×§ ×¤×¢× ××—×ª
                deferredPrompt = null;
            });
        });
        
        // ×× ×”××¤×œ×™×§×¦×™×” ×›×‘×¨ ××•×ª×§× ×ª
        window.addEventListener('appinstalled', () => {
            // ×”×¡×ª×¨×ª ×”×›×¤×ª×•×¨ ×× ×”×•× ×¢×“×™×™×Ÿ ××•×¦×’
            const installPrompt = document.querySelector('.install-prompt');
            if (installPrompt) {
                installPrompt.style.display = 'none';
            }
            deferredPrompt = null;
        });

        // ×× ×’× ×•×Ÿ ×©××™×¨×” ×¢×œ ×”××¤×œ×™×§×¦×™×” ×¤×¢×™×œ×” ×‘×¨×§×¢
        function keepAppAlive() {
            // 1. Page Lifecycle API - ×× ×™×¢×ª freeze/discard ×‘×× ×“×¨×•××™×“
            if ('onfreeze' in document) {
                document.addEventListener('freeze', (e) => {
                    console.log('â„ï¸ ×× ×“×¨×•××™×“ ×× ×¡×” ×œ×”×§×¤×™× - ××•× ×¢!');
                    e.preventDefault();
                });
            }
            
            if ('onresume' in document) {
                document.addEventListener('resume', () => {
                    console.log('â™»ï¸ ×”××¤×œ×™×§×¦×™×” ×—×•×“×©×”');
                    // ×•×•×“× ×©×”× ×’×Ÿ ×¢×“×™×™×Ÿ ×¤×¢×™×œ
                    if (player && player.getPlayerState && player.getPlayerState() === 2) {
                        player.playVideo();
                    }
                });
            }

            // 2. ×¡× ×›×¨×•×Ÿ Audio ×‘×¨×§×¢ ×¢× YouTube
            const backgroundAudio = document.getElementById('backgroundAudio');
            let isBackgroundMode = false;
            
            // ×¤×•× ×§×¦×™×” ×œ×¡× ×›×¨×•×Ÿ ×”×©××¢
            function syncBackgroundAudio() {
                if (!player || !player.getVideoData) return;
                
                try {
                    const videoData = player.getVideoData();
                    const videoId = videoData.video_id;
                    
                    if (videoId && isBackgroundMode) {
                        // ×”×©×ª××© ×‘-YouTube Audio URL (×¢×•×‘×“ ×‘×¨×§×¢!)
                        const audioUrl = `https://www.youtube.com/watch?v=${videoId}`;
                        console.log('ğŸµ ××¢×‘×™×¨ ×œ× ×™×’×•×Ÿ ×‘×¨×§×¢:', videoData.title);
                        
                        // × ×’×Ÿ ×©××¢ ×©×§×˜ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”×§×©×¨ ×¤×¢×™×œ
                        if (backgroundAudio.paused) {
                            // ×™×¦×™×¨×ª silence audio ×›×“×™ ×œ×©××•×¨ ×¢×œ Media Session ×¤×¢×™×œ
                            const silenceUrl = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                            backgroundAudio.src = silenceUrl;
                            backgroundAudio.loop = true;
                            backgroundAudio.play().catch(e => console.log('Background audio play failed:', e));
                        }
                    }
                } catch (e) {
                    console.error('×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×©××¢ ×‘×¨×§×¢:', e);
                }
            }

            // 3. ×× ×™×¢×ª ×”×©×”×™×”/×¡×’×™×¨×” ×©×œ ×”×“×£
            let backgroundNotificationShown = false;
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('ğŸ“± ×”××¤×œ×™×§×¦×™×” ×¢×‘×¨×” ×œ×¨×§×¢ - ×©×•××¨ ×¢×œ ×¤×¢×™×œ×•×ª');
                    isBackgroundMode = true;
                    
                    // ×”××©×š × ×™×’×•×Ÿ ×’× ×‘×¨×§×¢
                    if (player && player.getPlayerState && player.getPlayerState() === 1) {
                        console.log('ğŸµ ×××©×™×š ×œ× ×’×Ÿ ×‘×¨×§×¢');
                        
                        // ×”×¤×¢×œ Audio ×‘×¨×§×¢
                        syncBackgroundAudio();
                        
                        // ×”×¦×’ ×”×•×“×¢×” ×œ××©×ª××© ×¤×¢× ××—×ª
                        if (!backgroundNotificationShown && 'Notification' in window && Notification.permission === 'granted') {
                            new Notification('ğŸµ × ×’×Ÿ ××•×–×™×§×” ×œ×¨×›×‘', {
                                body: '×”××•×–×™×§×” ×××©×™×›×” ×œ× ×’×Ÿ ×‘×¨×§×¢ ğŸš—',
                                icon: 'car-music-icon.png',
                                tag: 'background-music',
                                requireInteraction: false
                            });
                            backgroundNotificationShown = true;
                        }
                    }
                } else {
                    console.log('ğŸ“± ×”××¤×œ×™×§×¦×™×” ×—×–×¨×” ×œ×—×–×™×ª');
                    isBackgroundMode = false;
                    
                    // ×¢×¦×•×¨ ××ª ×”-background audio
                    if (backgroundAudio && !backgroundAudio.paused) {
                        backgroundAudio.pause();
                    }
                    
                    // ×•×•×“× ×©×”× ×’×Ÿ ×¢×“×™×™×Ÿ ×¢×•×‘×“
                    if (player && player.getPlayerState) {
                        const state = player.getPlayerState();
                        console.log('ğŸ” ××¦×‘ × ×’×Ÿ:', state);
                        
                        // ×× ×”× ×’×Ÿ ×¢×¦×¨, ×”×¤×¢×œ ××•×ª×• ×©×•×‘
                        if (state === 2 || state === 5) {
                            player.playVideo();
                        }
                    }
                }
            });

            // 2. ×× ×™×¢×ª unload/beforeunload
            window.addEventListener('beforeunload', (e) => {
                // ××•× ×¢ ×¡×’×™×¨×” ××§×¨×™×ª
                if (player && player.getPlayerState && player.getPlayerState() === 1) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

            // 3. ×©××™×¨×” ×¢×œ ×—×™×‘×•×¨ ×¤×¢×™×œ - heartbeat
            let heartbeatInterval = setInterval(() => {
                if (document.hidden && player && player.getPlayerState) {
                    // ×©×œ×™×—×ª "×“×•×¤×§" ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”××¤×œ×™×§×¦×™×” ×—×™×”
                    try {
                        const state = player.getPlayerState();
                        console.log('ğŸ’“ Heartbeat - ××¦×‘ × ×’×Ÿ:', state);
                    } catch (e) {
                        // ×©×§×˜
                    }
                }
            }, 5000); // ×›×œ 5 ×©× ×™×•×ª

            // 4. ×× ×™×¢×ª sleep mode
            if ('wakeLock' in navigator) {
                let wakeLock = null;
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('ğŸ”’ Wake Lock ×¤×¢×™×œ - ××•× ×¢ ×›×™×‘×•×™');
                        
                        wakeLock.addEventListener('release', () => {
                            console.log('ğŸ”“ Wake Lock ×©×•×—×¨×¨ - ×× ×¡×” ×©×•×‘');
                            setTimeout(requestWakeLock, 1000);
                        });
                    } catch (err) {
                        console.log('âš ï¸ Wake Lock × ×›×©×œ, ×× ×¡×” ×©×•×‘ ×‘×¢×•×“ 5 ×©× ×™×•×ª');
                        setTimeout(requestWakeLock, 5000);
                    }
                };
                
                // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
                requestWakeLock();
                
                // ×”×¤×¢×œ×” ××—×“×© ×›×©×—×•×–×¨×™× ××¨×§×¢
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && wakeLock === null) {
                        requestWakeLock();
                    }
                });
            }

            // 5. ×©××™×¨×” ×¢×œ Audio Context ×¤×¢×™×œ (×—×©×•×‘ ×œ× ×™×’×•×Ÿ ×‘×¨×§×¢)
            if ('AudioContext' in window || 'webkitAudioContext' in window) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                
                // ×©××™×¨×” ×¢×œ ×”-context ×¤×¢×™×œ
                setInterval(() => {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            console.log('ğŸ”Š Audio Context ×—×•×“×©');
                        });
                    }
                }, 3000);
            }

            // 6. ×× ×™×¢×ª "freeze" ×‘-iOS
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                // iOS ×“×•×¨×© ×¤×¢×™×œ×•×ª ×§×‘×•×¢×”
                setInterval(() => {
                    if (document.hidden) {
                        // ×¤×¢×•×œ×” ×§×˜× ×” ×©××•× ×¢×ª freeze
                        const dummy = new Date().getTime();
                    }
                }, 1000);
            }

            // 7. ×©××™×¨×” ×¢×œ Service Worker ×¤×¢×™×œ (×× ×§×™×™×)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    console.log('âœ… Service Worker ××•×›×Ÿ ×œ×¢×‘×•×“×” ×‘×¨×§×¢');
                    
                    // ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×ª×§×•×¤×ª×™×•×ª ×œ-Service Worker
                    setInterval(() => {
                        if (registration.active) {
                            registration.active.postMessage({
                                type: 'KEEP_ALIVE',
                                timestamp: Date.now()
                            });
                        }
                    }, 10000);
                });
            }

            // 8. ×‘×§×©×ª ×”×¨×©××•×ª ×œ×”×ª×¨××•×ª (×œ××—×¨ ××™× ×˜×¨××§×¦×™×” ×¨××©×•× ×”)
            if ('Notification' in window && Notification.permission === 'default') {
                // × ×‘×§×© ×”×¨×©××” ×¨×§ ××—×¨×™ ×©×”××©×ª××© ×œ×—×¥ play
                const requestNotificationPermission = () => {
                    if (hasUserInteracted) {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('âœ… ×”×¨×©××•×ª ×”×ª×¨××•×ª × ×™×ª× ×•');
                            }
                        });
                        // ×”×¡×¨ ××ª ×”×××–×™×Ÿ ××—×¨×™ ×‘×§×©×” ××—×ª
                        document.removeEventListener('click', requestNotificationPermission);
                    }
                };
                document.addEventListener('click', requestNotificationPermission);
            }

            console.log('ğŸ›¡ï¸ ×× ×’× ×•× ×™ ×©××™×¨×” ×¢×œ ×¤×¢×™×œ×•×ª ×‘×¨×§×¢ ×”×•×¤×¢×œ×•');
        }

        // ×”×¤×¢×œ×ª ×× ×’× ×•× ×™ ×©××™×¨×” ×¢×œ ×¤×¢×™×œ×•×ª
        window.addEventListener('load', keepAppAlive);
        
        // ×§×™×¦×•×¨×™ ××§×œ×“×ª ×œ××—×©×‘
        document.addEventListener('keydown', function(event) {
            // ×× ×”××©×ª××© ××§×œ×™×“ ×‘×©×“×” ×˜×§×¡×˜, ×œ× ×œ×”×¤×¢×™×œ ×§×™×¦×•×¨×™×
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.key) {
                case ' ': // ×¨×•×•×— - ×”×¤×¢×œ×”/×”×©×”×™×™×”
                    if (player && player.getPlayerState) {
                        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                            pauseVideo();
                        } else {
                            playVideo();
                        }
                    }
                    event.preventDefault();
                    break;
                case 'ArrowRight': // ×—×¥ ×™××™× ×” - ×©×™×¨ ×”×‘×
                    nextTrack();
                    event.preventDefault();
                    break;
                case 'ArrowLeft': // ×—×¥ ×©×××œ×” - ×©×™×¨ ×§×•×“×
                    previousTrack();
                    event.preventDefault();
                    break;
                case 's': // ×¢×¨×‘×•×‘ ×©×™×¨×™×
                case 'S':
                    toggleSongShuffle();
                    event.preventDefault();
                    break;
                case 'p': // ×¤×œ×™×™×œ×™×¡×˜ ×”×‘×
                case 'P':
                    nextPlaylist();
                    event.preventDefault();
                    break;
                case 'm': // ×”×©×ª×§×”
                case 'M':
                    toggleMute();
                    event.preventDefault();
                    break;
                case 'd': // ××¦×‘ ×™×•×/×œ×™×œ×”
                case 'D':
                    toggleDayNightMode();
                    event.preventDefault();
                    break;
                case '+': // ×”×’×‘×¨×ª ×¢×•×¦××”
                case '=':
                    if (player && player.getVolume) {
                        const currentVolume = player.getVolume();
                        const newVolume = Math.min(100, currentVolume + 10);
                        player.setVolume(newVolume);
                        document.getElementById('volumeSlider').value = newVolume;
                        updateVolumeIcon(newVolume);
                    }
                    event.preventDefault();
                    break;
                case '-': // ×”× ××›×ª ×¢×•×¦××”
                case '_':
                    if (player && player.getVolume) {
                        const currentVolume = player.getVolume();
                        const newVolume = Math.max(0, currentVolume - 10);
                        player.setVolume(newVolume);
                        document.getElementById('volumeSlider').value = newVolume;
                        updateVolumeIcon(newVolume);
                    }
                    event.preventDefault();
                    break;
            }
        });
        
        // ×¤×•× ×§×¦×™×” ×–×• ×”×•×¡×¨×” - ×œ× ×”×™×ª×” ×‘×©×™××•×©
        
        // ×¨×™×©×•× Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('âœ… Service Worker × ×¨×©× ×‘×”×¦×œ×—×”:', registration.scope);
                        
                        // ×‘×“×™×§×” ×× ×™×© ×¢×“×›×•×Ÿ
                        registration.addEventListener('updatefound', () => {
                            console.log('ğŸ”„ × ××¦× ×¢×“×›×•×Ÿ ×œ-Service Worker');
                        });

                        checkForUpdates();
                    })
                    .catch(error => {
                        console.error('âŒ ×¨×™×©×•× Service Worker × ×›×©×œ:', error);
                    });

                // ×‘×“×™×§×ª ×¢×“×›×•× ×™× ××™×“ ×œ××—×¨ ×˜×¢×™× ×”
                checkForUpdates();
            });

            if (!updateListenerAttached) {
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (updatePending && !refreshing) {
                        refreshing = true;
                        console.log('ğŸ” ×˜×¢×™× ×ª ×”×“×£ ×œ××—×¨ ×¢×“×›×•×Ÿ Service Worker');
                        window.location.reload();
                    }
                });
                updateListenerAttached = true;
            }
        }

        // ××¢×¨×›×ª ×¢×“×›×•× ×™×
        function updateApp() {
            console.log('ğŸ”„ ××ª×—×™×œ ×¢×“×›×•×Ÿ...');
            
            if (newServiceWorker) {
                updatePending = true;
                // ×©×œ×™×—×ª ×”×•×¨××” ×œ-Service Worker ×œ×“×œ×’ ×¢×œ ××¦×‘ ×”××ª× ×”
                newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                const banner = document.getElementById('updateBanner');
                banner.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold;">
                        â³ ××¢×“×›×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”...
                    </div>
                    <div style="margin-top: 10px;">
                        ×× × ×”××ª×Ÿ ×œ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
                    </div>
                `;
            } else {
                console.log('âš ï¸ ××™×Ÿ Service Worker ×—×“×© ×–××™×Ÿ');
                dismissUpdate();
            }
        }
        
        function dismissUpdate() {
            console.log('â° ×“×—×™×™×ª ×¢×“×›×•×Ÿ ×œ××—×¨ ×›×š');
            const banner = document.getElementById('updateBanner');
            if (banner) {
                banner.style.display = 'none';
            }
            updateAvailable = false;
        }
        
        function showUpdateBanner() {
            console.log('ğŸ”” ××¦×™×’ ×‘×× ×¨ ×¢×“×›×•×Ÿ');
            const banner = document.getElementById('updateBanner');
            if (!banner) return;
            banner.style.display = 'block';
            updateAvailable = true;
            
            // ×¢×“×›×Ÿ ××ª ×”×•×“×¢×ª ×”×‘×× ×¨ ×¢× ×’×¨×¡×ª ×”××¤×œ×™×§×¦×™×”
            const versionInfo = banner.querySelector('.version-info');
            if (versionInfo) {
                versionInfo.textContent = `×’×¨×¡×” ${APP_VERSION}`;
            }
            
            // ×”×ª×¨××” ×× ×”×“×¤×“×¤×Ÿ ×ª×•××š
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸ”„ ×¢×“×›×•×Ÿ ×–××™×Ÿ!', {
                    body: '×’×¨×¡×” ×—×“×©×” ×©×œ × ×’×Ÿ ×”××•×–×™×§×” ×–××™× ×” ×œ×¢×“×›×•×Ÿ',
                    icon: 'car-music-icon.png',
                    tag: 'update',
                    requireInteraction: false
                });
            }
        }

        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (!registration) return;
                    
                    registration.update();

                    if (registration.waiting) {
                        newServiceWorker = registration.waiting;
                        if (AUTO_REFRESH_ON_UPDATE) {
                            console.log('ğŸ”„ Service Worker ×××ª×™×Ÿ - ×××œ×¥ ×¨×¢× ×•×Ÿ!');
                            updatePending = true;
                            newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            showUpdateBanner();
                        }
                    }

                    registration.addEventListener('updatefound', () => {
                        console.log('ğŸ” × ××¦× Service Worker ×—×“×©');
                        newServiceWorker = registration.installing;
                        newServiceWorker.addEventListener('statechange', () => {
                            if (newServiceWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    if (AUTO_REFRESH_ON_UPDATE) {
                                        console.log('ğŸ”„ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×××•×œ×¥ - ××¢×“×›×Ÿ ×¢×›×©×™×•!');
                                        updatePending = true;
                                        newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                                        // ×”××ª×Ÿ ×§×¦×¨ ×•××– ×¨×¢× ×Ÿ
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 500);
                                    } else {
                                        showUpdateBanner();
                                    }
                                } else {
                                    console.log('âœ… ×”××¤×œ×™×§×¦×™×” ×”×•×ª×§× ×” ×œ×¨××©×•× ×”');
                                }
                            }
                        });
                    });
                });
            }
        }

        // ××¢×¨×›×ª ×–×™×”×•×™ ×§×•×œ×™
        let recognition = null;
        let isVoiceActive = false;
        let voiceControlEnabled = false;
        let voiceRecognitionInitialized = false;
        const VOICE_COMMAND_COOLDOWN_MS = 1200;
        const VOICE_RESTART_DELAY_MS = 350;
        let lastVoiceCommandTime = 0;
        let voiceCommandInProgress = false;
        let voiceRestartTimeout = null;
        let lastRecognizedCommand = '';
        let voiceCommandDefinitions = [];

        function showVoiceCommandFeedback(message) {
            const commandDiv = document.getElementById('voiceCommand');
            if (!commandDiv) return;
            commandDiv.textContent = message;
            commandDiv.style.display = 'block';
            setTimeout(() => {
                commandDiv.style.display = 'none';
            }, 2000);
        }

        function scheduleVoiceRecognitionRestart() {
            if (!voiceControlEnabled || !recognition) {
                return;
            }
            if (voiceRestartTimeout) {
                clearTimeout(voiceRestartTimeout);
            }
            voiceRestartTimeout = setTimeout(() => {
                startVoiceRecognition();
            }, VOICE_RESTART_DELAY_MS);
        }

        function voiceNextTrack() {
            nextTrack();
        }

        function voicePreviousTrack() {
            previousTrack();
        }

        function voiceNextPlaylist() {
            nextPlaylist();
        }

        function voicePreviousPlaylist() {
            previousPlaylist();
        }

        function voicePlay() {
            playVideo(true);
        }

        function voicePause() {
            pauseVideo(true);
        }

        function voiceToggleMute() {
            toggleMute();
        }

        function handleVoiceCommand(definition) {
            const now = Date.now();
            if (voiceCommandInProgress) {
                console.log('ğŸ¤ ×¤×§×•×“×” ×§×•×œ×™×ª ×§×•×“××ª ×¢×“×™×™×Ÿ ×‘×ª×”×œ×™×š â€“ ××ª×¢×œ× ×›×“×™ ×œ×× ×•×¢ ×›×¤×™×œ×•×™×•×ª');
                return false;
            }
            if (definition.id === lastRecognizedCommand && (now - lastVoiceCommandTime) < VOICE_COMMAND_COOLDOWN_MS) {
                console.log('ğŸ¤ ×”×¤×§×•×“×” ×”×§×•×œ×™×ª ×”×ª×§×‘×œ×” ×©×•×‘ ××”×¨ ××“×™ â€“ ××ª×¢×œ×');
                return false;
            }

            voiceCommandInProgress = true;
            lastVoiceCommandTime = now;
            lastRecognizedCommand = definition.id;

            try {
                definition.action();
                showVoiceCommandFeedback(`âœ… ${definition.label}`);
            } catch (err) {
                console.error('âŒ ×©×’×™××” ×‘×‘×™×¦×•×¢ ×¤×§×•×“×ª ×§×•×œ:', err);
                showVoiceCommandFeedback('âŒ ×¤×¢×•×œ×” × ×›×©×œ×”');
            }

            if (recognition) {
                try {
                    recognition.stop();
                } catch (err) {
                    console.warn('âš ï¸ × ×™×¡×™×•×Ÿ ×œ×¢×¦×•×¨ ×–×™×”×•×™ ×§×•×œ×™ ×‘×¢×ª ×¢×™×‘×•×“ ×¤×§×•×“×” × ×›×©×œ:', err);
                }
            }

            setTimeout(() => {
                voiceCommandInProgress = false;
            }, Math.max(VOICE_RESTART_DELAY_MS + 150, 400));

            scheduleVoiceRecognitionRestart();

            return true;
        }

        function normaliseTranscript(text) {
            return text
                .toLowerCase()
                .replace(/[.,!?"×³×´']/g, '')
                .trim();
        }

        function updateVoiceIndicator() {
            const indicator = document.getElementById('voiceIndicator');
            if (!indicator) return;

            if (!voiceRecognitionInitialized) {
                indicator.style.display = 'none';
                return;
            }

            indicator.style.display = 'inline-block';
            indicator.style.animation = 'none';

            if (!voiceControlEnabled) {
                indicator.textContent = 'ğŸ¤ ×©×œ×™×˜×” ×§×•×œ×™×ª ×›×‘×•×™×” - ×œ×—×™×¦×” ×œ×”×¤×¢×™×œ';
                indicator.style.background = 'linear-gradient(135deg, #7f8c8d, #95a5a6)';
                indicator.setAttribute('title', '×œ×—×¥ ×›×“×™ ×œ×”×¤×¢×™×œ ×©×œ×™×˜×” ×§×•×œ×™×ª');
            } else if (isVoiceActive) {
                indicator.textContent = 'ğŸ¤ ×××–×™×Ÿ ×œ×¤×§×•×“×•×ª ×§×•×œ×™×•×ª... (×œ×—×™×¦×” ×œ×›×™×‘×•×™)';
                indicator.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                indicator.style.animation = 'pulse 1.5s infinite';
                indicator.setAttribute('title', '×œ×—×¥ ×›×“×™ ×œ×›×‘×•×ª ××ª ×”×©×œ×™×˜×” ×”×§×•×œ×™×ª');
            } else {
                indicator.textContent = 'ğŸ¤ ××¤×¢×™×œ ×©×œ×™×˜×” ×§×•×œ×™×ª...';
                indicator.style.background = 'linear-gradient(135deg, #f39c12, #d35400)';
                indicator.style.animation = 'pulse 1.5s infinite';
                indicator.setAttribute('title', '×× ×¡×” ×œ×”×¤×¢×™×œ ×©×œ×™×˜×” ×§×•×œ×™×ª');
            }
        }

        function startVoiceRecognition() {
            if (!recognition) return;
            try {
                if (voiceRestartTimeout) {
                    clearTimeout(voiceRestartTimeout);
                    voiceRestartTimeout = null;
                }
                recognition.start();
            } catch (err) {
                if (err.name === 'InvalidStateError') {
                    console.log('ğŸ¤ ×”×©×œ×™×˜×” ×”×§×•×œ×™×ª ×›×‘×¨ ×¤×¢×™×œ×”');
                } else {
                    console.error('âŒ ×œ× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ×©×œ×™×˜×” ×§×•×œ×™×ª:', err);
                }
            }
        }

        function stopVoiceRecognition() {
            if (!recognition) return;
            try {
                recognition.stop();
            } catch (err) {
                console.error('âŒ ×œ× × ×™×ª×Ÿ ×œ×¢×¦×•×¨ ×©×œ×™×˜×” ×§×•×œ×™×ª:', err);
            }
        }

        function toggleVoiceControl() {
            if (!voiceRecognitionInitialized) {
                console.log('ğŸ¤ ×”×©×œ×™×˜×” ×”×§×•×œ×™×ª ×¢×“×™×™×Ÿ ×œ× ××•×›× ×”');
                return;
            }

            voiceControlEnabled = !voiceControlEnabled;

            if (voiceControlEnabled) {
                console.log('ğŸ¤ ×©×œ×™×˜×” ×§×•×œ×™×ª ×”×•×¤×¢×œ×” ×™×“× ×™×ª');
                startVoiceRecognition();
            } else {
                console.log('ğŸ›‘ ×©×œ×™×˜×” ×§×•×œ×™×ª ×›×•×‘×ª×” ×™×“× ×™×ª');
                stopVoiceRecognition();
                isVoiceActive = false;
            }

            updateVoiceIndicator();
        }

        function initVoiceRecognition() {
            // ×‘×“×™×§×” ×× ×”×“×¤×“×¤×Ÿ ×ª×•××š ×‘×–×™×”×•×™ ×§×•×œ×™
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('âš ï¸ ×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×–×™×”×•×™ ×§×•×œ×™');
                voiceRecognitionInitialized = false;
                updateVoiceIndicator();
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true; // ×”××–× ×” ×¨×¦×™×¤×”
            recognition.interimResults = false;
            recognition.lang = 'he-IL'; // ×¢×‘×¨×™×ª ×›×‘×¨×™×¨×ª ××—×“×œ
            recognition.maxAlternatives = 3;

            voiceRecognitionInitialized = true;
            updateVoiceIndicator();

            // ××™×œ×•×Ÿ ×¤×§×•×“×•×ª
            voiceCommandDefinitions = [
                { id: 'next-track', label: '×©×™×¨ ×”×‘×', phrases: ['next', '×”×‘×', '×©×™×¨ ×”×‘×', 'next song', '×”×‘× ×©×™×¨'], action: voiceNextTrack },
                { id: 'previous-track', label: '×©×™×¨ ×§×•×“×', phrases: ['previous', '×§×•×“×', '×©×™×¨ ×§×•×“×', 'previous song', '×—×–×•×¨'], action: voicePreviousTrack },
                { id: 'play', label: '×× ×’×Ÿ', phrases: ['play', '× ×’×Ÿ', '×ª× ×’×Ÿ', '×ª×¤×¢×™×œ', '×”×¤×¢×œ'], action: voicePlay },
                { id: 'pause', label: '×¢×¦×•×¨', phrases: ['pause', 'stop', '×¢×¦×•×¨', '×ª×¢×¦×•×¨', '×¢×¦×™×¨×”', '×”×¤×¡×§'], action: voicePause },
                { id: 'mute', label: '×”×©×ª×§', phrases: ['mute', '×”×©×ª×§', '×©×§×˜', '×”×©×ª×§ ××•×–×™×§×”'], action: voiceToggleMute },
                { id: 'next-playlist', label: '×¤×œ×™×™×œ×™×¡×˜ ×”×‘×', phrases: ['next playlist', '×¤×œ×™×™×œ×™×¡×˜ ×”×‘×', '×¢×‘×•×¨ ×¤×œ×™×™×œ×™×¡×˜', '×¤×œ×™×™×œ×™×¡×˜ ×§×“×™××”'], action: voiceNextPlaylist },
                { id: 'previous-playlist', label: '×¤×œ×™×™×œ×™×¡×˜ ×§×•×“×', phrases: ['previous playlist', '×¤×œ×™×™×œ×™×¡×˜ ×§×•×“×', '×—×–×•×¨ ×¤×œ×™×™×œ×™×¡×˜', '×¤×œ×™×™×œ×™×¡×˜ ××—×•×¨×”'], action: voicePreviousPlaylist }
            ];

            recognition.onstart = () => {
                isVoiceActive = true;
                voiceControlEnabled = true;
                if (voiceRestartTimeout) {
                    clearTimeout(voiceRestartTimeout);
                    voiceRestartTimeout = null;
                }
                updateVoiceIndicator();
                console.log('ğŸ¤ ×–×™×”×•×™ ×§×•×œ×™ ×”×•×¤×¢×œ - ×××–×™×Ÿ...');
            };

            recognition.onresult = (event) => {
                const last = event.results.length - 1;
                const transcriptRaw = event.results[last][0].transcript;
                const transcript = normaliseTranscript(transcriptRaw);
                
                console.log('ğŸ¤ ×–×•×”×”:', transcript);
                
                // ×—×™×¤×•×© ×¤×§×•×“×” ××ª××™××”
                let commandExecuted = false;
                for (const definition of voiceCommandDefinitions) {
                    if (definition.phrases.some(phrase => transcript.includes(phrase))) {
                        console.log(`âœ… ×¤×§×•×“×” ×§×•×œ×™×ª ××–×•×”×”: ${definition.label}`);
                        commandExecuted = handleVoiceCommand(definition);
                        break;
                    }
                }

                if (!commandExecuted) {
                    console.log('â“ ×¤×§×•×“×” ×œ× ×–×•×”×ª×”:', transcript);
                }
            };

            recognition.onerror = (event) => {
                console.error('âŒ ×©×’×™××” ×‘×–×™×”×•×™ ×§×•×œ×™:', event.error);
                
                if (event.error === 'no-speech') {
                    console.log('ğŸ”‡ ×œ× ×–×•×”×” ×“×™×‘×•×¨ - ×××©×™×š ×œ×”××–×™×Ÿ...');
                } else if (event.error === 'not-allowed') {
                    console.error('ğŸš« ×”×¨×©××•×ª ××™×§×¨×•×¤×•×Ÿ × ×“×—×•');
                    voiceControlEnabled = false;
                    isVoiceActive = false;
                    updateVoiceIndicator();
                }
            };

            recognition.onend = () => {
                isVoiceActive = false;
                updateVoiceIndicator();

                if (voiceControlEnabled) {
                    console.log('ğŸ”„ ×–×™×”×•×™ ×§×•×œ×™ ×”×¡×ª×™×™× - ××ª×–××Ÿ ×”×¤×¢×œ×” ××—×“×©...');
                    scheduleVoiceRecognitionRestart();
                } else {
                    console.log('ğŸ¤ ×©×œ×™×˜×” ×§×•×œ×™×ª ×›×‘×•×™×” - ×œ× ×××ª×—×œ ××—×“×©');
                }
            };

            // ×”×¤×¢×œ ××ª ×”×–×™×”×•×™ ×”×§×•×œ×™
            updateVoiceIndicator();
        }

        // ×‘×§×©×ª ×”×¨×©××•×ª ××”××©×ª××©
        async function requestAllPermissions() {
            console.log('ğŸ” ××‘×§×© ×”×¨×©××•×ª ××”××©×ª××©...');
            
            const permissions = [];
            
            // 0. ×”×¨×©××•×ª ××™×§×¨×•×¤×•×Ÿ ×œ×–×™×”×•×™ ×§×•×œ×™
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                permissions.push('âœ… ××™×§×¨×•×¤×•×Ÿ (×©×œ×™×˜×” ×§×•×œ×™×ª)');
                stream.getTracks().forEach(track => track.stop()); // ×¢×¦×•×¨ ××ª ×”×–×¨×
                
                // ×”×¤×¢×œ ×–×™×”×•×™ ×§×•×œ×™
                setTimeout(() => {
                    initVoiceRecognition();
                }, 1000);
            } catch (e) {
                permissions.push('âŒ ××™×§×¨×•×¤×•×Ÿ (× ×“×—×”)');
                console.warn('×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ×”×¨×©××•×ª ××™×§×¨×•×¤×•×Ÿ:', e);
                voiceRecognitionInitialized = false;
                voiceControlEnabled = false;
                isVoiceActive = false;
                updateVoiceIndicator();
            }
            
            // 1. ×”×¨×©××•×ª ×œ×”×ª×¨××•×ª
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        permissions.push('âœ… ×”×ª×¨××•×ª');
                        // ×”×¦×’ ×”×ª×¨××ª ×“×•×’××”
                        new Notification('ğŸµ × ×’×Ÿ ××•×–×™×§×” ×œ×¨×›×‘', {
                            body: '×”××¤×œ×™×§×¦×™×” ×ª××©×™×š ×œ× ×’×Ÿ ×’× ×‘×¨×§×¢! ğŸš—',
                            icon: 'car-music-icon.png',
                            tag: 'welcome',
                            requireInteraction: false
                        });
                    } else {
                        permissions.push('âŒ ×”×ª×¨××•×ª (× ×“×—×”)');
                    }
                } catch (e) {
                    console.warn('×œ× × ×™×ª×Ÿ ×œ×‘×§×© ×”×¨×©××•×ª ×”×ª×¨××•×ª:', e);
                }
            } else if (Notification.permission === 'granted') {
                permissions.push('âœ… ×”×ª×¨××•×ª (×›×‘×¨ × ×™×ª× ×•)');
            }

            // 3. ×‘×“×™×§×ª ×¢×“×›×•× ×™× ×‘×¢×ª ×”×¨×©××•×ª
            checkForUpdates();

            // 2. Wake Lock - ×œ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š
            if ('wakeLock' in navigator) {
                try {
                    const wakeLock = await navigator.wakeLock.request('screen');
                    permissions.push('âœ… ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š');
                    console.log('ğŸ”’ Wake Lock ×”×•×¤×¢×œ');
                } catch (e) {
                    permissions.push('âš ï¸ ×× ×™×¢×ª ×›×™×‘×•×™ ××¡×š (×™× ×¡×” ×©×•×‘)');
                }
            }
            
            // 3. ×”×¦×’×ª ×¡×™×›×•× ×”×¨×©××•×ª
            if (permissions.length > 0) {
                console.log('ğŸ“‹ ×”×¨×©××•×ª ×©×”×ª×§×‘×œ×•:');
                permissions.forEach(p => console.log('  ' + p));
                
                // ×”×¦×’ ×”×•×“×¢×” ×™×¤×” ×œ××©×ª××©
                const permissionList = permissions.map(p => `<div style="margin: 5px 0;">${p}</div>`).join('');
                
                const notification = document.createElement('div');
                notification.className = 'permission-notification';
                notification.innerHTML = `
                    <h3>ğŸµ × ×’×Ÿ ××•×–×™×§×” ×œ×¨×›×‘</h3>
                    <p><strong>×”×¨×©××•×ª ×©×”×ª×§×‘×œ×•:</strong></p>
                    <div class="permission-list">
                        ${permissionList}
                    </div>
                    <p style="font-size: 18px; font-weight: bold;">
                        âœ¨ ×”××¤×œ×™×§×¦×™×” ×ª××©×™×š ×œ× ×’×Ÿ<br>×’× ×›×©×ª×¢×‘×•×¨ ×œ××¤×œ×™×§×¦×™×•×ª ××—×¨×•×ª! ğŸš—
                    </p>
                    <button onclick="this.parentElement.remove()">×”×‘× ×ª×™! ğŸ‘</button>
                `;
                
                setTimeout(() => {
                    document.body.appendChild(notification);
                    
                    // ×”×¡×¨ ××•×˜×•××˜×™×ª ××—×¨×™ 8 ×©× ×™×•×ª
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.animation = 'slideIn 0.5s ease reverse';
                            setTimeout(() => notification.remove(), 500);
                        }
                    }, 8000);
                }, 500);
            }
        }

        // ×‘×“×™×§×ª ×˜×¢×™× ×ª ×”×“×£ ×•××¦×‘ ×”× ×’×Ÿ
        window.addEventListener('load', function() {
            console.log('×”×“×£ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”');
            
            // ×‘×§×© ×”×¨×©××•×ª ××—×¨×™ ×œ×—×™×¦×” ×¨××©×•× ×”
            let permissionsRequested = false;
            document.addEventListener('click', async () => {
                if (!permissionsRequested) {
                    permissionsRequested = true;
                    await requestAllPermissions();
                }
            }, { once: true });
            
            // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×¤×œ×™×™×œ×™×¡×˜×™×
            updatePlaylistNavigation();
            
            // ×‘×“×™×§×” ×©×›×œ ×”××œ×× ×˜×™× ××•×¦×’×™×
            setTimeout(function() {
                // ×•×™×“×•× ×©×›×œ ×”××œ×× ×˜×™× ××•×¦×’×™× ×‘×¦×•×¨×” ×ª×§×™× ×”
                document.getElementById('currentSongContainer').style.display = 'block';
                document.getElementById('volumeControl').style.display = 'flex';
                document.querySelectorAll('.control-buttons').forEach(el => el.style.display = 'flex');
                document.getElementById('playlistName').style.display = 'block';
                
                // ×× ×’× ×•×Ÿ ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ ×× ×”× ×’×Ÿ ×œ× × ×˜×¢×Ÿ ×›×¨××•×™
                if (!player || (player && typeof player.getPlayerState !== 'function')) {
                    console.log('× ×’×Ÿ YouTube ×œ× × ×˜×¢×Ÿ ×›×¨××•×™, ×× ×¡×” ×œ×˜×¢×•×Ÿ ××—×“×©...');
                    // × ×™×¡×™×•×Ÿ ×œ×˜×¢×•×Ÿ ××—×“×© ××ª ×”× ×’×Ÿ ×‘×¦×•×¨×” ×™×©×™×¨×” ×•×¤×©×•×˜×”
                    document.getElementById('player').innerHTML = '<iframe width="100%" height="350" src="https://www.youtube.com/embed/videoseries?list=' + 
                        playlists[currentPlaylistIndex].id + 
                        '&autoplay=0&rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                }
            }, 1000); // ×‘×“×™×§×” ×œ××—×¨ ×©× ×™×™×” ××—×ª
        });

        // Error Handling ×’×œ×•×‘×œ×™
        window.addEventListener('error', function(event) {
            console.error('âŒ ×©×’×™××” ×’×œ×•×‘×œ×™×ª:', event.error);
            // ××œ ×ª×¦×™×’ ×©×’×™××•×ª ×œ××©×ª××© - ×¨×§ ×œ×•×’ ×œ×§×•× ×¡×•×œ
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('âŒ Promise × ×“×—×”:', event.reason);
            event.preventDefault();
        });

        // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜
        window.addEventListener('online', () => {
            console.log('âœ… ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×—×–×¨');
        });

        window.addEventListener('offline', () => {
            console.log('âš ï¸ ××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜');
            const currentSong = document.getElementById('currentSong');
            if (currentSong) {
                currentSong.textContent = 'âš ï¸ ××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ - ×× ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×©...';
            }
        });
    </script>

</body>
</html>







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































